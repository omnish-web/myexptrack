<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"/>
<title>Expense Command Center</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>tailwind.config={darkMode:'class',theme:{extend:{colors:{glass:{light:'rgba(255, 255, 255, 0.90)',dark:'rgba(17, 24, 39, 0.85)'}}}}}</script>
<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg-image:url('https://images.unsplash.com/photo-1738005787790-cdd55b3bddec?auto=format&fit=crop&w=1470&q=80')}
body{background:var(--bg-image) no-repeat center center fixed;background-size:cover;font-family:'Work Sans',sans-serif;transition:color .3s,background-color .3s}
.dark body{background-image:linear-gradient(rgba(0,0,0,0.7),rgba(0,0,0,0.7)),var(--bg-image)}
.glass-panel{backdrop-filter:saturate(180%) blur(15px);border-radius:1rem;transition:all .3s ease;background:var(--glass-light);border:1px solid rgba(255,255,255,0.5);box-shadow:0 8px 32px 0 rgba(31,38,135,0.15);color:#1f2937}
.dark .glass-panel{background:rgba(17,24,39,0.90);border:1px solid rgba(255,255,255,0.08);box-shadow:0 8px 32px 0 rgba(0,0,0,0.4);color:#e5e7eb}
.nav-item.active{background-color:#1f2937;color:white}.dark .nav-item.active{background-color:#3b82f6}
.custom-scroll::-webkit-scrollbar{width:6px}.custom-scroll::-webkit-scrollbar-thumb{background:rgba(156,163,175,0.5);border-radius:10px}
.compact-input{width:100%;padding:.5rem;font-size:16px;border-radius:.5rem;border:1px solid #d1d5db;background-color:rgba(255,255,255,0.9);outline:none}
.dark .compact-input{background-color:rgba(31,41,55,0.8);border-color:#374151;color:#e5e7eb}
.compact-label{display:block;font-size:.65rem;font-weight:700;color:#6b7280;text-transform:uppercase;margin-bottom:.2rem}.dark .compact-label{color:#9ca3af}
.clear-btn{position:absolute;right:2px;top:50%;transform:translateY(-50%);color:#9ca3af;padding:4px;cursor:pointer;display:none}
.input-wrapper:hover .clear-btn,.input-wrapper select:valid+.clear-btn{display:block}
.status-overdue { color: #ef4444; font-weight: bold; }
</style>
</head>
<body class="flex flex-col items-center p-4 h-screen w-screen overflow-hidden text-gray-800 dark:text-gray-100">
<div id="splash" class="fixed inset-0 z-50 flex items-center justify-center bg-white/90 dark:bg-gray-900/90 backdrop-blur-sm transition-opacity duration-500">
  <div class="text-center p-6 bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-sm w-full mx-4 border border-gray-200 dark:border-gray-700">
    <div id="splash-spinner" class="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-600 mx-auto mb-4"></div>
    <h2 id="splash-title" class="text-lg font-bold text-gray-800 dark:text-white">Connecting...</h2>
    <p id="splash-status" class="text-xs text-gray-500 mt-2">Initializing App...</p>
    <div id="errorBox" class="hidden mt-4 p-3 bg-red-50 dark:bg-red-900/30 rounded text-left">
      <p class="text-[10px] font-bold text-red-600 uppercase">Error Details:</p>
      <p id="errorMsg" class="text-xs text-red-600 font-mono break-words"></p>
    </div>
    <button id="forceLoadBtn" onclick="forceLoadApp()" class="hidden mt-6 w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 rounded text-sm transition">Force Open Dashboard</button>
    <button id="testSupabaseBtn" onclick="testSupabaseConnection()" class="mt-3 w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 rounded text-sm transition">Test Supabase connection</button>
    <!-- Phase 3: Sign-in - magic link or email+password -->
    <div id="signinBox" class="hidden mt-4 pt-4 border-t border-gray-200 dark:border-gray-600 text-left">
      <h3 class="text-sm font-bold text-gray-800 dark:text-white mb-2">Sign in</h3>
      <input type="email" id="signinEmail" placeholder="you@example.com" class="compact-input mb-2 text-sm w-full">
      <input type="password" id="signinPassword" placeholder="Password (for sign in / sign up)" class="compact-input mb-2 text-sm w-full" autocomplete="current-password">
      <div class="flex flex-col gap-2">
        <button type="button" id="signInPasswordBtn" onclick="signInWithPassword()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded text-sm transition">Sign in with password</button>
        <button type="button" id="signUpPasswordBtn" onclick="signUpWithPassword()" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 rounded text-sm transition">Sign up (create account with password)</button>
        <button type="button" id="sendMagicLinkBtn" onclick="sendMagicLink()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded text-sm transition">Send magic link</button>
        <a href="#" id="forgotPasswordLink" onclick="event.preventDefault(); showForgotPasswordBox(); return false;" class="text-xs text-blue-600 dark:text-blue-400 hover:underline text-center mt-1">Forgot password?</a>
      </div>
      <p id="signinMessage" class="mt-2 text-xs text-gray-500 dark:text-gray-400 hidden"></p>
      <!-- Forgot password: request reset link -->
      <div id="forgotPasswordBox" class="hidden mt-3 pt-3 border-t border-gray-200 dark:border-gray-600">
        <h3 class="text-sm font-bold text-gray-800 dark:text-white mb-2">Reset password</h3>
        <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">Enter your email and we’ll send a link to set a new password.</p>
        <input type="email" id="resetEmail" placeholder="you@example.com" class="compact-input mb-2 text-sm w-full">
        <div class="flex gap-2">
          <button type="button" id="sendResetLinkBtn" onclick="sendPasswordResetLink()" class="flex-1 bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 rounded text-sm transition">Send reset link</button>
          <button type="button" onclick="hideForgotPasswordBox()" class="px-3 py-2 bg-gray-200 dark:bg-gray-600 rounded text-sm">Cancel</button>
        </div>
        <p id="resetLinkMessage" class="mt-2 text-xs text-gray-500 dark:text-gray-400 hidden"></p>
      </div>
      <!-- Set new password (after clicking reset link in email) -->
      <div id="setNewPasswordBox" class="hidden mt-3 pt-3 border-t border-gray-200 dark:border-gray-600">
        <h3 class="text-sm font-bold text-gray-800 dark:text-white mb-2">Set new password</h3>
        <input type="password" id="newPassword" placeholder="New password" class="compact-input mb-2 text-sm w-full" autocomplete="new-password">
        <input type="password" id="newPasswordConfirm" placeholder="Confirm new password" class="compact-input mb-2 text-sm w-full" autocomplete="new-password">
        <button type="button" id="setNewPasswordBtn" onclick="submitNewPassword()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 rounded text-sm transition">Set new password</button>
        <p id="setNewPasswordMessage" class="mt-2 text-xs text-gray-500 dark:text-gray-400 hidden"></p>
      </div>
    </div>
  </div>
</div>

<div id="toast-container" class="fixed bottom-5 right-5 z-50 flex flex-col gap-2 pointer-events-none"></div>

<div class="w-full max-w-[98%] 2xl:max-w-[1800px] flex flex-col h-full gap-4">
    <div class="glass-panel p-3 flex justify-between items-center w-full flex-shrink-0">
        <div class="flex items-center gap-4 min-w-0">
            <h1 class="text-xl font-bold tracking-tight hidden md:block whitespace-nowrap">Expense<span class="text-blue-600">Track</span></h1>
            <div class="flex gap-3 overflow-x-auto px-2 custom-scroll min-w-0" id="balanceTicker"></div>
        </div>
        <div class="flex items-center gap-3">
            <button id="signOutBtn" onclick="signOutSupabase()" class="hidden text-xs font-semibold text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 px-2 py-1 rounded" title="Sign out">Sign out</button>
            <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition"><i data-feather="moon" class="w-4 h-4 hidden dark:block"></i><i data-feather="sun" class="w-4 h-4 block dark:hidden"></i></button>
            <div class="bg-gray-200/50 dark:bg-gray-700/50 p-1 rounded-lg flex text-xs font-semibold backdrop-blur-sm flex-shrink-0 overflow-x-auto">
                <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item px-4 py-1.5 rounded-md">Dashboard</button>
				<button onclick="switchTab('entry')" id="nav-entry" class="nav-item active px-4 py-1.5 rounded-md">Entry</button>
                <button onclick="switchTab('pending')" id="nav-pending" class="nav-item px-4 py-1.5 rounded-md">Pending</button>
                <button onclick="switchTab('scheduled')" id="nav-scheduled" class="nav-item px-4 py-1.5 rounded-md">Scheduled</button>
                <button onclick="switchTab('reports')" id="nav-reports" class="nav-item px-4 py-1.5 rounded-md">Reports</button>
                <button onclick="switchTab('budgets')" id="nav-budgets" class="nav-item px-4 py-1.5 rounded-md">Budgets</button>
                <button onclick="switchTab('settings')" id="nav-settings" class="nav-item px-4 py-1.5 rounded-md">Settings</button>
            </div>
        </div>
    </div>

    <div class="flex-1 min-h-0 relative w-full">
        <div id="tab-entry" class="view-section w-full h-full flex flex-col">
            <div class="glass-panel p-6 w-full h-full flex flex-col overflow-y-auto custom-scroll">
                <div class="flex justify-between mb-4 flex-shrink-0">
                    <div class="flex gap-2"></div>
                    <div class="bg-gray-100 dark:bg-gray-800 p-1 rounded-lg flex shadow-inner">
                        <button onclick="setEntryMode('single')" id="mode-single" class="px-3 py-1 rounded text-xs font-bold bg-white dark:bg-gray-600 shadow text-gray-800 dark:text-white">Single</button>
                        <button onclick="setEntryMode('bulk')" id="mode-bulk" class="px-3 py-1 rounded text-xs font-bold text-gray-500 dark:text-gray-400">Bulk</button>
                    </div>
                </div>
                <div id="container-single">
                    <form id="txnForm" onsubmit="handleFormSubmit(event)" autocomplete="off">
                        <input type="hidden" name="transactionId" id="inpId">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4 items-end">
                            <div><label class="compact-label">Date</label><input type="date" name="date" id="inpDate" required class="compact-input"></div>
                            <div><label class="compact-label">Type</label><select name="type" id="inpType" class="compact-input" onchange="toggleTransferMode()"><option value="Expense">Expense</option><option value="Income">Income</option><option value="Transfer">Transfer</option></select></div>
                            <div id="wrapSub"><label class="compact-label">Sub-Category</label><input list="subCatList" name="subCategory" id="inpSub" oninput="handleSubCategoryInput(this)" placeholder="Search..." class="compact-input"><datalist id="subCatList"></datalist></div>
                            <div id="wrapParent"><label class="compact-label">Parent</label><input type="text" name="parentCategory" id="inpParent" readonly tabindex="-1" class="compact-input bg-gray-100 dark:bg-gray-800 text-gray-500 cursor-not-allowed"></div>
                            <div><label class="compact-label">Total Amount (₹)</label><input type="number" name="amount" id="inpAmount" step="0.01" min="0.01" required placeholder="0.00" class="compact-input font-mono font-bold text-lg" oninput="handleAmountInput()"></div>
                            <div>
                                <div id="wrapMode"><label class="compact-label">Mode</label><select name="mode" id="inpMode" class="compact-input" onchange="handleModeChange()"><option value="Cashless">Cashless</option><option value="Cash">Cash</option></select></div>
                                <div id="wrapSource" class="hidden"><label id="lblSource" class="compact-label font-bold text-blue-700 dark:text-blue-400">Deposit To Account</label><select id="inpTransferSource" class="compact-input font-bold text-blue-800 dark:text-blue-200 bg-blue-50 dark:bg-blue-900/30"></select></div>
                            </div>
                            <div class="md:col-span-2"><label class="compact-label">Remarks</label><input type="text" name="remarks" id="inpRemarks" list="remarksList" class="compact-input" placeholder="General Notes..." oninput="predictTransactionDetails(this)"><datalist id="remarksList"></datalist></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-start">
                            <div id="divExpenseSplits" class="md:col-span-3 bg-red-50/50 dark:bg-red-900/20 p-3 rounded-lg border border-red-100 dark:border-red-900/30">
                                <div class="flex justify-between items-center mb-2"><div class="flex items-center gap-2"><label class="text-[10px] font-bold text-red-800 dark:text-red-300 uppercase">Source Breakdown</label><span id="splitTotal" class="text-[10px] font-mono font-bold text-gray-500 dark:text-gray-400">Total: 0</span><span id="splitError" class="text-[10px] text-red-600 font-bold hidden animate-pulse">Mismatch!</span></div><button type="button" onclick="addSplitRow()" class="text-[10px] bg-white dark:bg-gray-700 border border-red-200 text-red-600 px-2 py-1 rounded">+ Row</button></div>
                                <div id="splitContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2"></div>
                            </div>
                            <div id="divTransferDestinations" class="hidden md:col-span-3 bg-green-50/50 dark:bg-green-900/20 p-3 rounded-lg border border-green-100 dark:border-green-900/30">
                                <div class="flex justify-between items-center mb-2"><div class="flex items-center gap-2"><label class="text-[10px] font-bold text-green-800 dark:text-green-300 uppercase">Destination Breakdown</label><span id="transTotal" class="text-[10px] font-mono font-bold text-gray-500 dark:text-gray-400">Total: 0</span><span id="transError" class="text-[10px] text-red-600 font-bold hidden animate-pulse">Mismatch!</span></div><button type="button" onclick="addTransferRow()" class="text-[10px] bg-white dark:bg-gray-700 border border-green-200 text-green-600 px-2 py-1 rounded">+ Dest</button></div>
                                <div id="transferContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2"></div>
                            </div>
                            <div class="h-full flex items-end gap-2">
                                <button type="submit" id="btnSubmit" class="flex-1 h-[48px] bg-gray-900 hover:bg-black dark:bg-blue-600 dark:hover:bg-blue-700 text-white font-bold rounded-lg shadow-md flex justify-center items-center gap-2 text-sm"><span>Save</span><i data-feather="arrow-right-circle" class="w-4 h-4"></i></button>
                                <button type="button" onclick="resetForm()" class="w-[48px] h-[48px] flex justify-center items-center bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 rounded-lg"><i data-feather="x" class="w-5 h-5"></i></button>
                            </div>
                        </div>
                    </form>
                </div>
                <div id="container-bulk" class="hidden">
                    <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-700 mb-4">
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                            <div><label class="compact-label">Date</label><input type="date" id="bulkDate" class="compact-input"></div>
                            <div><label class="compact-label">Type</label><select id="bulkType" class="compact-input"><option value="Expense">Expense</option><option value="Income">Income</option></select></div>
                            <div><label class="compact-label">Parent</label><select id="bulkParent" onchange="renderBulkRows()" class="compact-input"><option value="" disabled selected>Select...</option></select></div>
                            <div><label class="compact-label">Mode</label><select id="bulkMode" class="compact-input" onchange="handleBulkModeChange()"><option value="Cashless">Cashless</option><option value="Cash">Cash</option></select></div>
                            <div><label class="compact-label">Source</label><select id="bulkGlobalSource" class="compact-input"><option value="">Select...</option></select></div>
                        </div>
                    </div>
                    <form id="bulkForm" onsubmit="handleBulkSubmit(event)">
                        <div class="bg-white dark:bg-gray-800 rounded-lg border mb-4"><table class="w-full text-left text-xs"><tbody id="bulkRowsBody"><tr><td colspan="4" class="p-4 text-center">Select Parent.</td></tr></tbody></table></div>
                        <div class="flex gap-2">
                            <button type="submit" id="btnBulkSubmit" class="flex-1 h-[48px] bg-purple-700 text-white font-bold rounded-lg">Save Bulk</button>
                            <button type="button" onclick="resetBulkForm()" class="w-[48px] h-[48px] bg-gray-200 rounded-lg flex justify-center items-center"><i data-feather="x" class="w-5 h-5"></i></button>
                        </div>
                    </form>
                </div>
                <div class="mt-6 border-t border-gray-200 dark:border-gray-700 pt-4">
                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">Session Log</h3>
                    <div class="rounded-lg border bg-white/60 dark:bg-gray-800/60"><table class="w-full text-left text-xs"><tbody id="recentListBody"></tbody></table></div>
                </div>
            </div>
        </div>
		<div id="tab-dashboard" class="view-section hidden w-full h-full overflow-y-auto p-2">
			<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 h-full">
				<div class="glass-panel p-5 flex flex-col min-h-[400px]">
					<h3 class="text-sm font-bold uppercase mb-4 flex items-center gap-2">
						<i data-feather="bar-chart-2" class="text-blue-600"></i> 6-Month Cashflow
					</h3>
					<div class="flex-1 relative w-full min-h-0">
						<canvas id="chartCashflow"></canvas>
					</div>
				</div>
				
				<div class="glass-panel p-5 flex flex-col min-h-[400px]">
					<h3 class="text-sm font-bold uppercase mb-4 flex items-center gap-2">
						<i data-feather="activity" class="text-purple-600"></i> 30-Day Spending Trend
					</h3>
					<div class="flex-1 relative w-full min-h-0">
						<canvas id="chartTrend"></canvas>
					</div>
				</div>
			</div>
		</div>
        <div id="tab-pending" class="view-section hidden w-full h-full">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 h-full">
                <div class="lg:col-span-4 glass-panel p-5 flex flex-col h-full overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-base font-bold flex items-center gap-2"><i data-feather="clock" class="text-orange-600 w-4 h-4"></i> <span id="pendingFormTitle">Add Receivable</span></h3>
                        <button onclick="resetPendingForm()" class="text-xs text-blue-600 font-bold hover:underline">Reset</button>
                    </div>
                    <form id="pendingForm" onsubmit="handlePendingSubmit(event)" class="space-y-3">
                        <input type="hidden" id="pendingId">
                        <div><label class="compact-label">Description / Payer</label><input type="text" id="pendDesc" required class="compact-input" placeholder="e.g. Arrears, Friend Name"></div>
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="compact-label">Amount (₹)</label><input type="number" id="pendAmount" step="0.01" required class="compact-input font-bold" oninput="validatePendingSplits()"></div>
                            <div><label class="compact-label">Expected Date</label><input type="date" id="pendDate" required class="compact-input"></div>
                        </div>
                        <div class="bg-green-50 dark:bg-green-900/20 p-3 rounded border border-green-100 dark:border-green-800">
                            <h4 class="text-[10px] font-bold text-green-700 mb-2 uppercase">1. Incoming (Income Category)</h4>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div><label class="compact-label">Income Sub-Cat</label><input list="incomeSubList" id="pendIncSub" required placeholder="Select..." class="compact-input text-xs" oninput="handlePendingIncomeInput(this)"><datalist id="incomeSubList"></datalist></div>
                                <div><label class="compact-label">Parent</label><input type="text" id="pendIncParent" value="Income" readonly class="compact-input bg-gray-100 dark:bg-gray-700 text-xs"></div>
                            </div>
                            <div><label class="compact-label">Deposit Account</label><select id="pendIncAccount" required class="compact-input text-xs"></select></div>
                        </div>
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded border border-blue-100 dark:border-blue-800">
                            <div class="flex justify-between items-center mb-2">
                                <div class="flex items-center gap-2"><h4 class="text-[10px] font-bold text-blue-700 uppercase">2. Destinations (Optional)</h4><span id="pendSplitTotal" class="text-[9px] font-mono text-gray-500"></span></div>
                                <button type="button" onclick="addPendingTransferRow()" class="text-[9px] bg-white border border-blue-200 text-blue-600 px-2 py-0.5 rounded shadow">+ Dest</button>
                            </div>
                            <div id="pendingSplitList" class="space-y-2"></div>
                            <datalist id="expenseSubList"></datalist>
                        </div>
                        <button type="submit" id="btnPendSubmit" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-2.5 rounded shadow-md mt-2 flex justify-center items-center gap-2"><span>Log Pending</span></button>
                    </form>
                </div>
                <div class="lg:col-span-8 glass-panel p-5 flex flex-col h-full">
                    <div id="pendingStatsBar" class="grid grid-cols-3 gap-3 mb-5 shrink-0"></div>
					<div id="pendingInflowSummary" class="mb-5 flex flex-wrap gap-2 shrink-0 empty:hidden"></div>
					<h3 class="text-base font-bold mb-3">Due Payments</h3>
                    <div class="flex-1 overflow-y-auto custom-scroll rounded-lg border bg-white/50 dark:bg-gray-800/50">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-gray-100 dark:bg-gray-700 sticky top-0 z-10 text-gray-600 dark:text-gray-300 font-bold uppercase">
                                <tr><th class="p-3">Expected</th><th class="p-3">Description</th><th class="p-3">Amount</th><th class="p-3">Flow</th><th class="p-3 text-center">Action</th></tr>
                            </thead>
                            <tbody id="pendingTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-scheduled" class="view-section hidden w-full h-full">
			<div class="grid grid-cols-1 lg:grid-cols-12 gap-4 h-full">
				
				<div class="lg:col-span-4 glass-panel p-5 flex flex-col h-full overflow-y-auto">
				<div class="flex justify-between items-center mb-4">
					<h3 class="text-base font-bold flex items-center gap-2">
					<i data-feather="clock" class="text-blue-600 w-4 h-4"></i> 
					<span id="schFormTitle">Create Schedule</span>
					</h3>
					<button onclick="resetScheduleForm()" class="text-xs text-blue-600 font-bold hover:underline">Reset</button>
				</div>
				<form id="scheduleForm" onsubmit="handleScheduleSubmit(event)" class="space-y-3">
					<input type="hidden" name="scheduleId" id="schId">
					<div class="grid grid-cols-2 gap-3">
					<div>
						<label class="compact-label">Frequency</label>
						<select name="frequency" id="schFreq" class="compact-input">
						<option value="Daily">Daily</option>
						<option value="Weekly">Weekly</option>
						<option value="Monthly" selected>Monthly</option>
						<option value="Annually">Annually</option>
						</select>
					</div>
					<div>
						<label class="compact-label">Mode</label>
						<select name="mode" id="schMode" class="compact-input">
						<option value="Cashless">Cashless</option>
						<option value="Cash">Cash</option>
						</select>
					</div>
					</div>
					<div class="grid grid-cols-2 gap-3">
					<div>
						<label class="compact-label">Next Due</label>
						<input type="date" name="startDate" id="schStartDate" required class="compact-input">
					</div>
					<div>
						<label class="compact-label">Sunset</label>
						<input type="date" name="endDate" id="schEndDate" class="compact-input">
					</div>
					</div>
					<div class="grid grid-cols-2 gap-3">
					<div>
						<label class="compact-label">Sub-Category</label>
						<input list="subCatList" name="subCategory" id="schSub" required oninput="handleSchSubInput(this)" class="compact-input">
					</div>
					<div>
						<label class="compact-label">Parent</label>
						<input type="text" name="parentCategory" id="schParent" readonly class="compact-input bg-gray-100 dark:bg-gray-700">
					</div>
					</div>
					<div class="grid grid-cols-2 gap-3">
					<div>
						<label class="compact-label">Amount</label>
						<input type="number" name="amount" id="schAmount" required step="0.01" class="compact-input font-bold">
					</div>
					<div>
						<label class="compact-label">Type</label>
						<select name="type" id="schType" class="compact-input">
						<option value="Expense">Expense</option>
						<option value="Income">Income</option>
						<option value="Transfer">Transfer</option>
						</select>
					</div>
					</div>
					<div>
					<label class="compact-label">Source Account</label>
					<select name="source" id="schSource" required class="compact-input"></select>
					</div>
					<div>
					<label class="compact-label">Remarks</label>
					<input type="text" name="remarks" id="schRemarks" class="compact-input">
					</div>
					<button type="submit" id="btnSchSubmit" class="w-full bg-blue-600 text-white font-bold py-2.5 rounded shadow-md mt-2">Set Schedule</button>
				</form>
				</div>
			
				<div class="lg:col-span-8 glass-panel p-5 flex flex-col h-full relative">
				<div class="flex justify-between items-center mb-4 shrink-0">
					<h3 class="text-base font-bold flex items-center gap-2">
					<span id="schViewTitle">Active Instructions</span>
					<div id="calNav" class="hidden flex items-center gap-2 ml-4 text-sm bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
						<button onclick="changeCalMonth(-1)" class="p-1 hover:text-blue-600"><i data-feather="chevron-left" class="w-4 h-4"></i></button>
						<span id="calMonthLabel" class="font-bold min-w-[100px] text-center">January 2026</span>
						<button onclick="changeCalMonth(1)" class="p-1 hover:text-blue-600"><i data-feather="chevron-right" class="w-4 h-4"></i></button>
					</div>
					</h3>
					
					<div class="flex bg-gray-100 dark:bg-gray-700 p-1 rounded-lg">
					<button onclick="toggleSchView('list')" id="btnViewList" class="px-3 py-1 text-xs font-bold rounded shadow bg-white dark:bg-gray-600 dark:text-white transition-all">List</button>
					<button onclick="toggleSchView('calendar')" id="btnViewCal" class="px-3 py-1 text-xs font-bold rounded text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-all">Calendar</button>
					</div>
				</div>
			
				<div id="schStatsBar" class="grid grid-cols-3 gap-3 mb-5 shrink-0"></div>
			
				<div id="schListView" class="flex-1 overflow-y-auto custom-scroll rounded-lg border bg-white/50 dark:bg-gray-800/50">
					<table class="w-full text-left text-xs">
					<thead class="bg-gray-100 dark:bg-gray-700 sticky top-0 z-10 text-gray-600 dark:text-gray-300 font-bold uppercase">
						<tr>
						<th class="p-3">Freq</th>
						<th class="p-3">Next Due</th>
						<th class="p-3">Category</th>
						<th class="p-3">Amount</th>
						<th class="p-3">Sunset</th>
						<th class="p-3 text-center">Action</th>
						</tr>
					</thead>
					<tbody id="scheduledTableBody"></tbody>
					</table>
				</div>
			
				<div id="schCalendarView" class="hidden flex-1 flex flex-col bg-white/50 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
					<div class="grid grid-cols-7 bg-gray-100 dark:bg-gray-700 text-[10px] font-bold text-gray-500 uppercase text-center py-2 border-b dark:border-gray-600 shrink-0">
					<div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
					</div>
					<div id="calendarGrid" class="grid grid-cols-7 grid-rows-6 flex-1 text-xs"></div>
				</div>
				</div>
			</div>
		</div>
        <div id="tab-reports" class="view-section hidden w-full h-full overflow-y-auto p-2">
			<div class="grid grid-cols-1 lg:grid-cols-12 gap-4 items-start">
				<div class="lg:col-span-4 flex flex-col gap-4 w-full h-fit">
				<div class="glass-panel p-4">
					<div class="flex justify-between items-center mb-3">
					<h3 class="text-xs font-bold uppercase">Filters</h3>
					<div class="flex gap-2">
						<button onclick="loadArchivedData()" class="text-[10px] text-orange-600 hover:underline flex items-center gap-1">
						<i data-feather="database" class="w-3 h-3"></i> History
						</button>
						<div class="w-px h-3 bg-gray-300"></div>
						<button onclick="openPresetModal()" class="text-[10px] text-purple-600 hover:underline flex items-center gap-1">
						<i data-feather="bookmark" class="w-3 h-3"></i> Presets
						</button>
						<button onclick="resetFilters()" class="text-[10px] text-blue-600 hover:underline">Reset</button>
					</div>
					</div>
					<div class="space-y-2">
					<div id="activeFilterBadges" class="flex flex-wrap gap-1 mb-2"></div>
					<button onclick="resetFilters()" class="text-[9px] text-red-600 hover:underline mb-2 hidden" id="clearAllBtn">Clear All Filters ×</button>
					<div class="flex gap-2 mb-2 overflow-x-auto pb-1">
						<div id="quickFilterContainer" class="flex gap-2"></div>
					</div>
					<div class="grid grid-cols-4 gap-2">
						<button onclick="setDateFilter('thisMonth')" class="px-1 py-1.5 text-[9px] font-bold bg-blue-50 text-blue-700 rounded border border-blue-100">THIS M</button>
						<button onclick="setDateFilter('lastMonth')" class="px-1 py-1.5 text-[9px] font-bold bg-gray-50 text-gray-700 rounded border border-gray-200">LAST M</button>
						<button onclick="setDateFilter('last7')" class="px-1 py-1.5 text-[9px] font-bold bg-gray-50 text-gray-700 rounded border border-gray-200">7 DAY</button>
						<button onclick="setDateFilter('thisYear')" class="px-1 py-1.5 text-[9px] font-bold bg-gray-50 text-gray-700 rounded border border-gray-200">YEAR</button>
					</div>
					<div class="flex gap-2 items-center mb-2">
						<input type="number" id="customDays" placeholder="N" class="compact-input w-16 text-xs text-center">
						<button onclick="setCustomDays()" class="px-2 py-1 text-[9px] bg-gray-100 hover:bg-gray-200 rounded border font-bold">Last N Days</button>
					</div>
					<div class="grid grid-cols-2 gap-2">
						<div><label class="compact-label">Start</label><input type="date" id="filterStartDate" class="compact-input text-xs"></div>
						<div><label class="compact-label">End</label><input type="date" id="filterEndDate" class="compact-input text-xs"></div>
					</div>
					<div class="grid grid-cols-2 gap-2">
						<input type="number" id="filterMinAmount" placeholder="Min ₹" class="compact-input text-xs">
						<input type="number" id="filterMaxAmount" placeholder="Max ₹" class="compact-input text-xs">
					</div>
					<div class="grid grid-cols-2 gap-2">
						<select id="filterType" class="compact-input text-xs">
						<option value="">All Types</option>
						<option value="Expense">Expense</option>
						<option value="Income">Income</option>
						<option value="Transfer">Transfer</option>
						</select>
						<select id="filterDayType" class="compact-input text-xs">
						<option value="">All Days</option>
						<option value="weekday">Weekdays Only</option>
						<option value="weekend">Weekends Only</option>
						</select>
					</div>
					<div class="space-y-2">
						<div class="relative input-wrapper">
						<select id="filterParent" class="compact-input text-xs" onchange="updateSubFilter()">
							<option value="">All Parents</option>
						</select>
						<div class="clear-btn" onclick="clearInput('filterParent')"><i data-feather="x" class="w-3 h-3"></i></div>
						</div>
						<div class="relative input-wrapper">
						<select id="filterSub" class="compact-input text-xs">
							<option value="">All Sub-Cats</option>
						</select>
						<div class="clear-btn" onclick="clearInput('filterSub')"><i data-feather="x" class="w-3 h-3"></i></div>
						</div>
						<div class="relative input-wrapper">
						<select id="filterSource" class="compact-input text-xs">
							<option value="">All Sources</option>
						</select>
						<div class="clear-btn" onclick="clearInput('filterSource')"><i data-feather="x" class="w-3 h-3"></i></div>
						</div>
					</div>
					<input type="text" id="reportSearch" placeholder="Search..." class="compact-input text-xs">
					<div class="flex gap-2 mt-2">
						<button onclick="renderReportTable(true)" id="btnApplyFilter" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded text-xs transition-colors flex justify-center items-center gap-2"><i data-feather="filter" class="w-3 h-3"></i> <span>Apply</span> <span id="filterMatchCount" class="opacity-75 font-normal"></span></button>
						<button onclick="exportReportToCSV()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded text-xs transition-colors flex justify-center items-center gap-2"><i data-feather="download" class="w-3 h-3"></i> CSV</button>
					</div>
					</div>
				</div>
				<div class="glass-panel p-4 flex flex-col gap-4">
					<div class="grid grid-cols-3 gap-2">
					<div class="bg-green-50 dark:bg-green-900/20 p-2 rounded text-center">
						<p class="text-[10px] text-green-600 font-bold">INCOME</p>
						<p id="sumIncome" class="text-xs font-bold">₹0</p>
					</div>
					<div class="bg-red-50 dark:bg-red-900/20 p-2 rounded text-center">
						<p class="text-[10px] text-red-600 font-bold">EXPENSE</p>
						<p id="sumExpense" class="text-xs font-bold">₹0</p>
					</div>
					<div class="bg-blue-50 dark:bg-blue-900/20 p-2 rounded text-center">
						<p class="text-[10px] text-blue-600 font-bold">NET</p>
						<p id="sumNet" class="text-xs font-bold">₹0</p>
					</div>
					</div>
					<div class="bg-gray-50 dark:bg-gray-700/30 p-2 rounded">
					<h4 class="text-[10px] font-bold text-gray-500 mb-1">Sources</h4>
					<div id="sourceBreakdown" class="space-y-1 text-xs"></div>
					</div>
					<div>
					<h4 class="text-[10px] font-bold text-gray-500 mb-1">Categories</h4>
					<div id="categoryBreakdown" class="space-y-3"></div>
					</div>
				</div>
				</div>
				<div class="lg:col-span-8 relative w-full h-full min-h-[500px]">
				<div class="absolute inset-0 glass-panel p-0 flex flex-col overflow-hidden">
					<div class="p-5 flex justify-between items-center border-b">
					<h3 class="text-sm font-bold uppercase">Log</h3><span class="text-xs font-bold text-gray-500">Rows: <span id="reportCount" class="text-blue-600">0</span></span>
					</div>
					<div id="reportScrollContainer" class="flex-1 overflow-y-auto custom-scroll p-5 pt-0">
					<table class="w-full text-left text-xs mt-4">
						<thead class="bg-gray-100 dark:bg-gray-800 sticky top-0 z-20 font-bold uppercase">
						<tr>
							<th class="p-3 w-8 text-center"><input type="checkbox" onclick="toggleSelectAll()" class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"></th>
							<th class="p-3">Date</th>
							<th class="p-3">Category</th>
							<th class="p-3">Source</th>
							<th class="p-3">Remarks</th>
							<th class="p-3 text-right">Amt</th>
							<th class="p-3 text-center">Act</th>
						</tr>
						</thead>
						<tbody id="reportTableBody" class="divide-y divide-gray-100 dark:divide-gray-700"></tbody>
					</table>
					<div id="loadMoreTrigger" class="p-4 text-center text-xs text-gray-400 italic hidden">Loading more...</div>
					</div>
				</div>
				</div>
			</div>
		</div>
        <div id="tab-budgets" class="view-section hidden w-full h-full p-2"><div class="grid grid-cols-1 md:grid-cols-3 gap-4 h-full"><div class="md:col-span-2 glass-panel p-5 flex flex-col h-full overflow-y-auto custom-scroll"><div class="flex justify-between items-center mb-4"><h3 class="text-base font-bold flex items-center gap-2"><i data-feather="pie-chart" class="text-purple-600 w-4 h-4"></i> Budgets</h3></div><div id="budgetContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-4"></div></div><div class="glass-panel p-5 flex flex-col h-fit"><h3 class="text-sm font-bold uppercase border-b pb-2 mb-3">Set Limits</h3><form onsubmit="handleSaveBudget(event)" class="space-y-3"><div><label class="compact-label">Category</label><select id="budgetCat" required class="compact-input"></select></div><div><label class="compact-label">Limit (₹)</label><input type="number" id="budgetLimit" required min="1" class="compact-input font-bold"></div><button type="submit" class="w-full bg-purple-600 text-white font-bold py-2 rounded text-xs">Set Budget</button></form></div></div></div>
        <div id="tab-settings" class="view-section hidden w-full h-full overflow-y-auto p-2">
			<div class="glass-panel p-4 mb-4 flex flex-col md:flex-row justify-between items-center gap-4">
				<div>
					<h3 class="font-bold text-sm uppercase flex items-center gap-2">
						<i data-feather="database" class="w-4 h-4 text-blue-600"></i> Data Management
					</h3>
					<p class="text-xs text-gray-500 mt-1">Create a 'Snapshot' to archive old transactions and speed up the app.</p>
				</div>
				<button onclick="createServerSnapshot()" class="bg-gray-800 hover:bg-black dark:bg-gray-600 dark:hover:bg-gray-500 text-white px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-2 shadow-lg transition-all">
					<i data-feather="save" class="w-4 h-4"></i> Close Books & Snapshot
				</button>
			</div>
			
			<div class="grid grid-cols-1 md:grid-cols-3 gap-4 h-auto md:h-full">
				<div class="glass-panel p-5 flex flex-col h-[500px] md:h-full">
				<h3 class="font-bold mb-3 border-b pb-2 text-sm uppercase">Sources</h3>
				<div class="flex flex-wrap gap-2 mb-3 items-end">
					<input type="text" id="newSourceInp" placeholder="Source name" class="compact-input flex-1 min-w-[100px]">
					<select id="newSourceType" class="compact-input w-28 text-xs">
						<option value="Bank">Bank</option>
						<option value="Cash">Cash</option>
						<option value="Wallet">Wallet</option>
						<option value="Card">Card</option>
					</select>
					<input type="number" id="newSourceOpening" placeholder="Opening ₹" step="0.01" class="compact-input w-24 text-xs" title="Opening / current balance">
					<button onclick="addSource()" class="bg-gray-800 text-white px-3 rounded">+</button>
				</div>
				<div id="settingsSourceList" class="flex-1 overflow-y-auto custom-scroll space-y-2 pr-2"></div>
				</div>
				<div class="glass-panel p-5 flex flex-col h-[500px] md:h-full">
				<h3 class="font-bold mb-3 border-b pb-2 text-sm uppercase">Parents</h3>
				<div class="flex gap-2 mb-3"><input type="text" id="newParentInp" placeholder="New Parent" class="compact-input"><button onclick="addParent()" class="bg-gray-800 text-white px-3 rounded">+</button></div>
				<div id="settingsParentList" class="flex-1 overflow-y-auto custom-scroll space-y-2 pr-2"></div>
				</div>
				<div class="glass-panel p-5 flex flex-col h-[500px] md:h-full">
				<h3 class="font-bold mb-3 border-b pb-2 text-sm uppercase">Sub-Categories</h3><select id="selParentForSub" class="compact-input mb-3 font-bold text-blue-800 bg-blue-50">
					<option disabled selected>Select Parent First</option>
				</select>
				<div class="flex gap-2 mb-3"><input type="text" id="newSubInp" placeholder="New Sub" class="compact-input"><button onclick="addSub()" class="bg-gray-800 text-white px-3 rounded">+</button></div>
				<div id="settingsSubList" class="flex-1 overflow-y-auto custom-scroll space-y-2 pr-2"></div>
				</div>
			</div>
		</div>
    </div>
</div>

<div id="reclassifyModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden"><div class="bg-white p-6 rounded-lg shadow-xl w-96"><h3 class="text-lg font-bold mb-4">Reclassify</h3><p class="text-sm text-gray-600 mb-2">Moving: <span id="modalSubName" class="font-bold"></span></p><label class="text-xs font-bold uppercase text-gray-500">New Parent</label><input list="modalParentList" id="modalNewParent" class="compact-input mt-1 mb-6"><datalist id="modalParentList"></datalist><div class="flex justify-end gap-2"><button onclick="closeReclassifyModal()" class="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded">Cancel</button><button onclick="confirmReclassify()" class="px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded">Confirm</button></div></div></div>
<div id="renameModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden backdrop-blur-sm">
  <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl w-96 border border-gray-200 dark:border-gray-700">
    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-1" id="renameModalTitle">Rename</h3>
    <p class="text-sm text-gray-500 dark:text-gray-400 mb-3" id="renameModalLabel">New name:</p>
    <input type="text" id="renameModalInput" class="compact-input mb-4 w-full" placeholder="Name" autocomplete="off" onkeydown="if(event.key==='Enter'){event.preventDefault();confirmRenameModal();}">
    <p id="renameModalError" class="text-xs text-red-600 dark:text-red-400 mb-2 hidden"></p>
    <div class="flex justify-end gap-2">
      <button type="button" onclick="closeRenameModal()" class="px-4 py-2 text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition">Cancel</button>
      <button type="button" onclick="confirmRenameModal()" class="px-4 py-2 text-sm bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition">Rename</button>
    </div>
  </div>
</div>
<div id="presetModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden"><div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl w-96 border border-gray-200 dark:border-gray-700"><h3 class="text-lg font-bold mb-4 text-gray-800 dark:text-gray-100">Saved Filter Presets</h3><div id="presetList" class="space-y-2 mb-4 max-h-60 overflow-y-auto custom-scroll"></div><div class="border-t dark:border-gray-700 pt-4"><input type="text" id="newPresetName" placeholder="New preset name..." class="compact-input mb-2 text-sm"><div class="flex gap-2"><button onclick="saveNewPreset()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm transition-colors">Save Current</button><button onclick="closePresetModal()" class="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700 rounded transition-colors">Close</button></div></div></div></div>
<div id="approveModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden">
  <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl w-96 border border-gray-200 dark:border-gray-700 relative">
    <h3 class="text-lg font-bold mb-2 dark:text-white">Confirm Receipt</h3>
    <p class="text-xs text-gray-500 mb-4">Verify details before posting to ledger.</p>
    <label class="compact-label">Amount Received:</label><input type="number" id="approveAmount" class="compact-input mb-3 font-bold">
    <label class="compact-label">Date Received:</label><input type="date" id="approveDate" class="compact-input mb-4">
    <div class="flex justify-between gap-2">
      <button class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 rounded text-sm" onclick="closeApproveModal()">Cancel</button>
      <button id="btnApproveConfirm" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded text-sm" onclick="submitApproval()">Confirm</button>
    </div>
  </div>
</div>
<div id="confirmModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 hidden backdrop-blur-sm transition-opacity">
  <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl w-80 border border-gray-200 dark:border-gray-700 text-center transform transition-all scale-100">
    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900/30 mb-4">
      <i data-feather="alert-triangle" class="h-6 w-6 text-red-600 dark:text-red-400"></i>
    </div>
    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2" id="confirmTitle">Confirm Action</h3>
    <p class="text-xs text-gray-500 dark:text-gray-400 mb-6 leading-relaxed" id="confirmMessage">Are you sure you want to proceed?</p>
    <div class="flex justify-center gap-3">
      <button onclick="closeConfirmModal()" class="flex-1 px-4 py-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg text-xs font-bold transition">Cancel</button>
      <button onclick="executeConfirmAction()" id="btnConfirmAction" class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-xs font-bold transition shadow-lg">Delete</button>
    </div>
  </div>
</div>
<div id="bulkActionBar" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-6 z-50 transition-all duration-300 translate-y-20 opacity-0">
    <div class="font-bold text-sm flex items-center gap-2">
        <span class="bg-white text-gray-900 w-5 h-5 rounded-full flex items-center justify-center text-xs" id="bulkCount">0</span>
        Selected
    </div>
    <div class="h-6 w-px bg-gray-700"></div> <button onclick="openBulkEditModal()" class="flex items-center gap-1 hover:text-blue-300 text-sm font-medium transition">
        <i data-feather="folder" class="w-4 h-4"></i> Move
    </button>
    <button onclick="executeBulkDelete()" class="flex items-center gap-1 hover:text-red-300 text-sm font-medium transition">
        <i data-feather="trash-2" class="w-4 h-4"></i> Delete
    </button>
    <button onclick="clearBulkSelection()" class="ml-2 text-gray-500 hover:text-white">
        <i data-feather="x" class="w-4 h-4"></i>
    </button>
</div>

<div id="bulkEditModal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-95 opacity-0" id="bulkEditContent">
        <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
            <i data-feather="folder" class="text-blue-600"></i> Bulk Move
        </h3>
        <p class="text-sm text-gray-500 mb-4">Select the new category for <b id="bulkEditCount">0</b> items:</p>
        
        <div class="space-y-3">
            <div>
                <label class="compact-label">New Sub-Category</label>
                <input list="subCatList" id="bulkNewSub" class="compact-input" placeholder="Search..." oninput="handleSubCategoryInput(this, 'bulkNewParent')">
            </div>
            <div>
                <label class="compact-label">New Parent</label>
                <input type="text" id="bulkNewParent" readonly class="compact-input bg-gray-100 dark:bg-gray-700">
            </div>
        </div>

        <div class="flex gap-3 mt-6">
            <button onclick="closeBulkEditModal()" class="flex-1 py-2 text-gray-600 font-bold hover:bg-gray-100 rounded-lg">Cancel</button>
            <button onclick="submitBulkEdit()" class="flex-1 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-lg">Move Items</button>
        </div>
    </div>
</div>
<div id="dayDetailModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 hidden backdrop-blur-sm">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm m-4 overflow-hidden transform transition-all scale-100">
        <div class="bg-gray-50 dark:bg-gray-700/50 p-4 border-b dark:border-gray-700 flex justify-between items-center">
            <div>
                <h3 class="text-lg font-bold text-gray-800 dark:text-white" id="dayModalTitle">February 14</h3>
                <p class="text-xs text-gray-500 dark:text-gray-400 font-mono" id="dayModalTotal">Total: ₹0</p>
            </div>
            <button onclick="closeDayModal()" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                <i data-feather="x" class="w-5 h-5"></i>
            </button>
        </div>
        
        <div id="dayModalContent" class="p-4 space-y-2 max-h-[60vh] overflow-y-auto custom-scroll"></div>
        
        <div class="p-3 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-900/30 flex justify-end">
             <button onclick="closeDayModal()" class="px-4 py-2 text-xs font-bold bg-blue-600 hover:bg-blue-700 text-white rounded-lg">Close</button>
        </div>
    </div>
</div>
<script>
// ==========================================
// SUPABASE CONFIG (Phase 2) - Paste your keys here
// ==========================================
const SUPABASE_URL = 'https://juzrdkojjglqideclnzw.supabase.co';      // e.g. https://abcdefgh.supabase.co
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp1enJka29qamdscWlkZWNsbnp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwODQ4NjgsImV4cCI6MjA4NTY2MDg2OH0.akDH0O00QOddHemJw9ZSGkYSwbKBC9sPiBNZjMT5Q9M'; // long string from Project Settings → API → anon public

function testSupabaseConnection() {
  if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
    if (typeof showToast === 'function') showToast('Paste your Supabase URL and anon key in the script first.', 'error');
    else alert('Paste your Supabase URL and anon key at the top of the script (SUPABASE_URL, SUPABASE_ANON_KEY).');
    return;
  }
  const statusEl = document.getElementById('splash-status');
  if (statusEl) statusEl.innerText = 'Testing Supabase...';
  const { createClient } = window.supabase || {};
  const supabase = createClient ? createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;
  if (!supabase) {
    if (statusEl) statusEl.innerText = 'Initializing App...';
    if (typeof showToast === 'function') showToast('Supabase script not loaded.', 'error');
    else alert('Supabase script not loaded.');
    return;
  }
  supabase.from('expenses').select('id').limit(1).then(function(res) {
    if (statusEl) statusEl.innerText = 'Initializing App...';
    if (res.error) {
      if (typeof showToast === 'function') showToast('Supabase error: ' + (res.error.message || 'Unknown'), 'error');
      else alert('Supabase error: ' + (res.error.message || 'Unknown'));
    } else {
      if (typeof showToast === 'function') showToast('Supabase connected! Tables are ready.', 'success');
      else alert('Supabase connected! Tables are ready.');
    }
  }).catch(function(err) {
    if (statusEl) statusEl.innerText = 'Initializing App...';
    if (typeof showToast === 'function') showToast('Connection failed: ' + (err && err.message ? err.message : String(err)), 'error');
    else alert('Connection failed: ' + (err && err.message ? err.message : String(err)));
  });
}

// ==========================================
// PHASE 3: Supabase auth + load data
// ==========================================
let _supabaseClient = null;
let supabaseUserId = null;

function getSupabaseClient() {
  if (!SUPABASE_URL || !SUPABASE_ANON_KEY) return null;
  if (!_supabaseClient) {
    const { createClient } = window.supabase || {};
    _supabaseClient = createClient ? createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;
  }
  return _supabaseClient;
}

function showSignInUI() {
  document.getElementById('splash-spinner').classList.add('hidden');
  document.getElementById('splash-title').textContent = 'Sign in';
  document.getElementById('splash-status').textContent = 'Enter your email to get a magic link.';
  document.getElementById('errorBox').classList.add('hidden');
  document.getElementById('forceLoadBtn').classList.add('hidden');
  document.getElementById('testSupabaseBtn').classList.add('hidden');
  document.getElementById('signinBox').classList.remove('hidden');
  document.getElementById('signinMessage').classList.add('hidden');
}

function hideSignInUI() {
  document.getElementById('signinBox').classList.add('hidden');
  document.getElementById('splash-spinner').classList.remove('hidden');
  document.getElementById('splash-title').textContent = 'Connecting...';
  document.getElementById('splash-status').textContent = 'Initializing App...';
  document.getElementById('testSupabaseBtn').classList.remove('hidden');
}

function sendMagicLink() {
  const emailEl = document.getElementById('signinEmail');
  const msgEl = document.getElementById('signinMessage');
  const btn = document.getElementById('sendMagicLinkBtn');
  const email = (emailEl && emailEl.value || '').trim();
  if (!email) {
    if (msgEl) { msgEl.textContent = 'Please enter your email.'; msgEl.classList.remove('hidden'); }
    return;
  }
  const supabase = getSupabaseClient();
  if (!supabase) return;
  btn.disabled = true;
  btn.textContent = 'Sending...';
  if (msgEl) msgEl.classList.add('hidden');
  supabase.auth.signInWithOtp({ email: email }).then(function(res) {
    if (msgEl) {
      msgEl.textContent = res.error ? (res.error.message || 'Failed') : 'Check your email for the magic link.';
      msgEl.classList.remove('hidden');
    }
    btn.disabled = false;
    btn.textContent = 'Send magic link';
  }).catch(function(err) {
    if (msgEl) { msgEl.textContent = err && err.message ? err.message : 'Failed to send link.'; msgEl.classList.remove('hidden'); }
    btn.disabled = false;
    btn.textContent = 'Send magic link';
  });
}

function signInWithPassword() {
  var emailEl = document.getElementById('signinEmail');
  var pwEl = document.getElementById('signinPassword');
  var msgEl = document.getElementById('signinMessage');
  var email = (emailEl && emailEl.value || '').trim();
  var password = (pwEl && pwEl.value || '');
  if (!email) { if (msgEl) { msgEl.textContent = 'Enter your email.'; msgEl.classList.remove('hidden'); } return; }
  if (!password) { if (msgEl) { msgEl.textContent = 'Enter your password.'; msgEl.classList.remove('hidden'); } return; }
  var supabase = getSupabaseClient();
  if (!supabase) return;
  var btn = document.getElementById('signInPasswordBtn');
  if (btn) { btn.disabled = true; btn.textContent = 'Signing in...'; }
  if (msgEl) msgEl.classList.add('hidden');
  supabase.auth.signInWithPassword({ email: email, password: password }).then(function(res) {
    if (res.error) {
      if (msgEl) { msgEl.textContent = res.error.message || 'Sign in failed'; msgEl.classList.remove('hidden'); }
      if (btn) { btn.disabled = false; btn.textContent = 'Sign in with password'; }
      return;
    }
    if (res.data && res.data.user) {
      supabaseUserId = res.data.user.id;
      startAppWithSupabase();
    }
  }).catch(function(err) {
    if (msgEl) { msgEl.textContent = err && err.message ? err.message : 'Sign in failed'; msgEl.classList.remove('hidden'); }
    if (btn) { btn.disabled = false; btn.textContent = 'Sign in with password'; }
  });
}

function signUpWithPassword() {
  var emailEl = document.getElementById('signinEmail');
  var pwEl = document.getElementById('signinPassword');
  var msgEl = document.getElementById('signinMessage');
  var email = (emailEl && emailEl.value || '').trim();
  var password = (pwEl && pwEl.value || '');
  if (!email) { if (msgEl) { msgEl.textContent = 'Enter your email.'; msgEl.classList.remove('hidden'); } return; }
  if (!password || password.length < 6) { if (msgEl) { msgEl.textContent = 'Password must be at least 6 characters.'; msgEl.classList.remove('hidden'); } return; }
  var supabase = getSupabaseClient();
  if (!supabase) return;
  var btn = document.getElementById('signUpPasswordBtn');
  if (btn) { btn.disabled = true; btn.textContent = 'Creating...'; }
  if (msgEl) msgEl.classList.add('hidden');
  supabase.auth.signUp({ email: email, password: password }).then(function(res) {
    if (res.error) {
      if (msgEl) { msgEl.textContent = res.error.message || 'Sign up failed'; msgEl.classList.remove('hidden'); }
      if (btn) { btn.disabled = false; btn.textContent = 'Sign up (create account with password)'; }
      return;
    }
    if (msgEl) {
      msgEl.textContent = res.data.user && !res.data.user.identities || (res.data.user.identities && res.data.user.identities.length === 0)
        ? 'Account already exists. Sign in with password.'
        : 'Account created! You can sign in with password now.';
      msgEl.classList.remove('hidden');
    }
    if (btn) { btn.disabled = false; btn.textContent = 'Sign up (create account with password)'; }
  }).catch(function(err) {
    if (msgEl) { msgEl.textContent = err && err.message ? err.message : 'Sign up failed'; msgEl.classList.remove('hidden'); }
    if (btn) { btn.disabled = false; btn.textContent = 'Sign up (create account with password)'; }
  });
}

function showForgotPasswordBox() {
  var emailEl = document.getElementById('signinEmail');
  var resetEl = document.getElementById('resetEmail');
  if (resetEl && emailEl && emailEl.value) resetEl.value = (emailEl.value || '').trim();
  document.getElementById('forgotPasswordBox').classList.remove('hidden');
  document.getElementById('resetLinkMessage').classList.add('hidden');
}

function hideForgotPasswordBox() {
  document.getElementById('forgotPasswordBox').classList.add('hidden');
}

function sendPasswordResetLink() {
  var resetEl = document.getElementById('resetEmail');
  var msgEl = document.getElementById('resetLinkMessage');
  var btn = document.getElementById('sendResetLinkBtn');
  var email = (resetEl && resetEl.value || '').trim();
  if (!email) {
    if (msgEl) { msgEl.textContent = 'Enter your email.'; msgEl.classList.remove('hidden'); }
    return;
  }
  var supabase = getSupabaseClient();
  if (!supabase) return;
  var redirectTo = (typeof window !== 'undefined' && window.location && window.location.origin)
    ? (window.location.origin + '/')
    : 'http://localhost:3000/';
  btn.disabled = true;
  btn.textContent = 'Sending...';
  if (msgEl) msgEl.classList.add('hidden');
  supabase.auth.resetPasswordForEmail(email, { redirectTo: redirectTo }).then(function(res) {
    if (msgEl) {
      msgEl.textContent = res.error ? (res.error.message || 'Failed') : 'Check your email for the reset link.';
      msgEl.classList.remove('hidden');
    }
    btn.disabled = false;
    btn.textContent = 'Send reset link';
  }).catch(function(err) {
    if (msgEl) { msgEl.textContent = err && err.message ? err.message : 'Failed to send reset link.'; msgEl.classList.remove('hidden'); }
    btn.disabled = false;
    btn.textContent = 'Send reset link';
  });
}

function showSetNewPasswordUI() {
  document.getElementById('splash-spinner').classList.add('hidden');
  document.getElementById('splash-title').textContent = 'Set new password';
  document.getElementById('splash-status').textContent = 'Enter and confirm your new password.';
  document.getElementById('signinBox').classList.remove('hidden');
  document.getElementById('signinMessage').classList.add('hidden');
  document.getElementById('forgotPasswordBox').classList.add('hidden');
  document.getElementById('setNewPasswordBox').classList.remove('hidden');
  document.querySelector('.flex.flex-col.gap-2').style.display = 'none';
  document.getElementById('forgotPasswordLink').style.display = 'none';
}

function hideSetNewPasswordUI() {
  document.getElementById('setNewPasswordBox').classList.add('hidden');
  var flex = document.querySelector('.flex.flex-col.gap-2');
  if (flex) flex.style.display = '';
  var link = document.getElementById('forgotPasswordLink');
  if (link) link.style.display = '';
}

function submitNewPassword() {
  var newPw = document.getElementById('newPassword');
  var confirmPw = document.getElementById('newPasswordConfirm');
  var msgEl = document.getElementById('setNewPasswordMessage');
  var btn = document.getElementById('setNewPasswordBtn');
  var p1 = (newPw && newPw.value || '').trim();
  var p2 = (confirmPw && confirmPw.value || '').trim();
  if (!p1 || p1.length < 6) {
    if (msgEl) { msgEl.textContent = 'Password must be at least 6 characters.'; msgEl.classList.remove('hidden'); }
    return;
  }
  if (p1 !== p2) {
    if (msgEl) { msgEl.textContent = 'Passwords do not match.'; msgEl.classList.remove('hidden'); }
    return;
  }
  var supabase = getSupabaseClient();
  if (!supabase) return;
  if (btn) { btn.disabled = true; btn.textContent = 'Updating...'; }
  if (msgEl) msgEl.classList.add('hidden');
  supabase.auth.updateUser({ password: p1 }).then(function(res) {
    if (res.error) {
      if (msgEl) { msgEl.textContent = res.error.message || 'Update failed'; msgEl.classList.remove('hidden'); }
      if (btn) { btn.disabled = false; btn.textContent = 'Set new password'; }
      return;
    }
    if (msgEl) { msgEl.textContent = 'Password updated. Signing you in...'; msgEl.classList.remove('hidden'); }
    if (window.history && window.history.replaceState) {
      try { window.history.replaceState(null, '', window.location.pathname + window.location.search); } catch (e) {}
    }
    supabaseUserId = (res.data && res.data.user && res.data.user.id) || supabaseUserId;
    hideSetNewPasswordUI();
    startAppWithSupabase();
    if (btn) { btn.disabled = false; btn.textContent = 'Set new password'; }
  }).catch(function(err) {
    if (msgEl) { msgEl.textContent = err && err.message ? err.message : 'Update failed'; msgEl.classList.remove('hidden'); }
    if (btn) { btn.disabled = false; btn.textContent = 'Set new password'; }
  });
}

function fetchInitialDataFromSupabase() {
  const supabase = getSupabaseClient();
  const uid = supabaseUserId;
  if (!supabase || !uid) return Promise.reject(new Error('Not signed in'));

  const schema = { id: 0, date: 1, type: 2, sub: 3, parent: 4, amt: 5, mode: 6, source: 7, remarks: 8 };
  const out = { expenses: [], categories: {}, sources: [], scheduled: [], budgets: {}, pending: [], snapshot: null, schema: schema };

  function fmtDate(d) { return d ? String(d).split('T')[0] : ''; }

  return supabase.from('balance_snapshots').select('snapshot_date, balances_json').eq('user_id', uid).order('snapshot_date', { ascending: false }).limit(1).single()
    .then(function(snapRes) {
      var cutoff = new Date('2000-01-01');
      if (snapRes.data && snapRes.data.snapshot_date) {
        out.snapshot = { date: fmtDate(snapRes.data.snapshot_date), balances: snapRes.data.balances_json || {} };
        cutoff = new Date(snapRes.data.snapshot_date);
      }
      return supabase.from('expenses').select('id, date, type, sub, parent, amount, mode, source, remarks').eq('user_id', uid).then(function(expRes) {
        if (expRes.data) {
          expRes.data.forEach(function(r) {
            var d = r.date;
            if (d && new Date(d) > cutoff) out.expenses.push([r.id, fmtDate(d), r.type || '', r.sub || '', r.parent || '', Number(r.amount), r.mode || '', r.source || '', r.remarks || '']);
          });
          out.expenses.sort(function(a, b) { return a[1] < b[1] ? 1 : -1; });
        }
        return supabase.from('categories').select('parent, sub').eq('user_id', uid);
      });
    })
    .then(function(catRes) {
      if (catRes.data) catRes.data.forEach(function(r) {
        if (!out.categories[r.parent]) out.categories[r.parent] = [];
        out.categories[r.parent].push(String(r.sub));
      });
      return supabase.from('sources').select('source_name, type, opening, stmt, due, link, fav, def').eq('user_id', uid);
    })
    .then(function(srcRes) {
      if (srcRes.data) out.sources = srcRes.data.map(function(r) { return [r.source_name, r.type || 'Bank', Number(r.opening) || 0, r.stmt || '', r.due || '', r.link || '', !!r.fav, !!r.def]; });
      return supabase.from('recurring').select('id, frequency, start_date, end_date, type, sub, parent, amount, mode, source, remarks').eq('user_id', uid);
    })
    .then(function(recRes) {
      if (recRes.data) out.scheduled = recRes.data.map(function(r) { return [r.id, r.frequency || '', fmtDate(r.start_date), fmtDate(r.end_date), r.type || '', r.sub || '', r.parent || '', Number(r.amount), r.mode || '', r.source || '', r.remarks || '']; });
      return supabase.from('budgets').select('category_key, limit_amount').eq('user_id', uid);
    })
    .then(function(budRes) {
      if (budRes.data) budRes.data.forEach(function(r) { out.budgets[r.category_key] = Number(r.limit_amount); });
      return supabase.from('pending_transactions').select('*').eq('user_id', uid).eq('status', 'Pending');
    })
    .then(function(pendRes) {
      if (pendRes.data) out.pending = pendRes.data.map(function(r) {
        return { id: r.id, description: r.description, amount: r.amount, expectedDate: fmtDate(r.expected_date), incomeCategory: r.income_category, incomeSubCategory: r.income_sub_category, incomeAccount: r.income_account, transferAccount: r.transfer_account, transferCategory: r.transfer_category, transferSubCategory: r.transfer_sub_category };
      });
      return out;
    });
}

function startAppWithSupabase() {
  hideSignInUI();
  document.getElementById('splash-status').textContent = 'Loading your data...';
  fetchInitialDataFromSupabase().then(function(data) {
    onDataLoad(JSON.stringify(data));
  }).catch(function(err) {
    document.getElementById('errorMsg').textContent = err && err.message ? err.message : 'Failed to load data';
    document.getElementById('errorBox').classList.remove('hidden');
    document.getElementById('splash-spinner').classList.add('hidden');
    document.getElementById('forceLoadBtn').classList.remove('hidden');
  });
}

// ==========================================
// PHASE 5: Supabase write helpers (when supabaseUserId is set)
// ==========================================
function useSupabase() { return getSupabaseClient() && supabaseUserId; }

function saveTransactionToSupabase(d) {
  var supabase = getSupabaseClient();
  if (!supabase || !supabaseUserId) return Promise.reject(new Error('Not signed in'));
  var src = (d.splits && d.splits.length > 0) ? d.splits.map(function(s) { return s.source + ': ' + s.amount; }).join(' | ') : (d.source || '');
  var id = d.transactionId || ('TXN-' + new Date().getTime());
  var row = { id: id, user_id: supabaseUserId, date: d.date, type: d.type, sub: d.subCategory || '', parent: d.parentCategory || '', amount: Number(d.amount), mode: d.mode || 'Cashless', source: src, remarks: d.remarks || '' };
  if (d.transactionId) {
    return supabase.from('expenses').update({ date: row.date, type: row.type, sub: row.sub, parent: row.parent, amount: row.amount, mode: row.mode, source: row.source, remarks: row.remarks }).eq('user_id', supabaseUserId).eq('id', id).select().single().then(function(res) {
      if (res.error) return Promise.reject(new Error(res.error.message));
      return { success: true, savedId: id };
    });
  }
  return supabase.from('expenses').insert(row).select().single().then(function(res) {
    if (res.error) return Promise.reject(new Error(res.error.message));
    return { success: true, savedId: id };
  });
}

function deleteTransactionToSupabase(id) {
  var supabase = getSupabaseClient();
  if (!supabase || !supabaseUserId) return Promise.reject(new Error('Not signed in'));
  return supabase.from('expenses').delete().eq('user_id', supabaseUserId).eq('id', id).then(function(res) {
    if (res.error) return Promise.reject(new Error(res.error.message));
    return { success: true };
  });
}

function restoreTransactionToSupabase(txnData) {
  var supabase = getSupabaseClient();
  if (!supabase || !supabaseUserId) return Promise.reject(new Error('Not signed in'));
  var row = { id: txnData[0], user_id: supabaseUserId, date: txnData[1], type: txnData[2], sub: txnData[3] || '', parent: txnData[4] || '', amount: Number(txnData[5]), mode: txnData[6] || '', source: txnData[7] || '', remarks: txnData[8] || '' };
  return supabase.from('expenses').insert(row).then(function(res) {
    if (res.error) return Promise.reject(new Error(res.error.message));
    return { success: true };
  });
}

function addCategoryParentToSupabase(name) {
  var supabase = getSupabaseClient();
  if (!supabase || !supabaseUserId) return Promise.reject(new Error('Not signed in'));
  return supabase.from('categories').insert({ user_id: supabaseUserId, parent: name, sub: name }).then(function(res) {
    if (res.error) return Promise.reject(new Error(res.error.message));
    return { success: true };
  });
}

function addCategorySubToSupabase(parent, sub) {
  var supabase = getSupabaseClient();
  if (!supabase || !supabaseUserId) return Promise.reject(new Error('Not signed in'));
  return supabase.from('categories').insert({ user_id: supabaseUserId, parent: parent, sub: sub }).then(function(res) {
    if (res.error) return Promise.reject(new Error(res.error.message));
    return { success: true };
  });
}

function deleteCategorySubToSupabase(parent, sub) {
  var supabase = getSupabaseClient();
  if (!supabase || !supabaseUserId) return Promise.reject(new Error('Not signed in'));
  return supabase.from('categories').delete().eq('user_id', supabaseUserId).eq('parent', parent).eq('sub', sub).then(function(res) {
    if (res.error) return Promise.reject(new Error(res.error.message));
    return { success: true };
  });
}

function addSourceToSupabase(name, type, opening) {
  var supabase = getSupabaseClient();
  if (!supabase || !supabaseUserId) return Promise.reject(new Error('Not signed in'));
  var openVal = opening !== undefined && opening !== '' ? Number(opening) : 0;
  if (isNaN(openVal)) openVal = 0;
  return supabase.from('sources').insert({ user_id: supabaseUserId, source_name: name, type: type || 'Bank', opening: openVal, fav: false, def: false }).then(function(res) {
    if (res.error) return Promise.reject(new Error(res.error.message));
    return { success: true };
  });
}

function updateSourceOpeningToSupabase(sourceName, opening) {
  var supabase = getSupabaseClient();
  if (!supabase || !supabaseUserId) return Promise.reject(new Error('Not signed in'));
  var openVal = opening !== undefined && opening !== '' ? Number(opening) : 0;
  if (isNaN(openVal)) openVal = 0;
  return supabase.from('sources').update({ opening: openVal }).eq('user_id', supabaseUserId).eq('source_name', sourceName).then(function(res) {
    if (res.error) return Promise.reject(new Error(res.error.message));
    return { success: true };
  });
}

function deleteSourceToSupabase(name) {
  var supabase = getSupabaseClient();
  if (!supabase || !supabaseUserId) return Promise.reject(new Error('Not signed in'));
  return supabase.from('sources').delete().eq('user_id', supabaseUserId).eq('source_name', name).then(function(res) {
    if (res.error) return Promise.reject(new Error(res.error.message));
    return { success: true };
  });
}

function updateSourceFlagsToSupabase(sourceName, flagType, value) {
  var supabase = getSupabaseClient();
  if (!supabase || !supabaseUserId) return Promise.reject(new Error('Not signed in'));
  var col = flagType === 'fav' ? 'fav' : 'def';
  if (flagType === 'def' && value) {
    return supabase.from('sources').update({ def: false }).eq('user_id', supabaseUserId).then(function() {
      return supabase.from('sources').update({ [col]: value }).eq('user_id', supabaseUserId).eq('source_name', sourceName);
    }).then(function(res) {
      if (res.error) return Promise.reject(new Error(res.error.message));
      return { success: true };
    });
  }
  return supabase.from('sources').update({ [col]: value }).eq('user_id', supabaseUserId).eq('source_name', sourceName).then(function(res) {
    if (res.error) return Promise.reject(new Error(res.error.message));
    return { success: true };
  });
}

function renameParentCategoryToSupabase(oldName, newName) {
  var supabase = getSupabaseClient();
  if (!supabase || !supabaseUserId) return Promise.reject(new Error('Not signed in'));
  return supabase.from('categories').update({ parent: newName }).eq('user_id', supabaseUserId).eq('parent', oldName).then(function(r1) {
    if (r1.error) return Promise.reject(new Error(r1.error.message));
    return supabase.from('expenses').update({ parent: newName }).eq('user_id', supabaseUserId).eq('parent', oldName);
  }).then(function(r2) {
    if (r2.error) return Promise.reject(new Error(r2.error.message));
    return supabase.from('recurring').update({ parent: newName }).eq('user_id', supabaseUserId).eq('parent', oldName);
  }).then(function(r3) {
    if (r3.error) return Promise.reject(new Error(r3.error.message));
    return supabase.from('pending_transactions').update({ income_category: newName }).eq('user_id', supabaseUserId).eq('income_category', oldName);
  }).then(function(r4) {
    if (r4.error) return Promise.reject(new Error(r4.error.message));
    return supabase.from('pending_transactions').update({ transfer_category: newName }).eq('user_id', supabaseUserId).eq('transfer_category', oldName);
  }).then(function(r5) {
    if (r5.error) return Promise.reject(new Error(r5.error.message));
    return { success: true };
  });
}

function deleteParentCategoryToSupabase(name) {
  var supabase = getSupabaseClient();
  if (!supabase || !supabaseUserId) return Promise.reject(new Error('Not signed in'));
  return supabase.from('categories').delete().eq('user_id', supabaseUserId).eq('parent', name).then(function(res) {
    if (res.error) return Promise.reject(new Error(res.error.message));
    return { success: true };
  });
}

function reclassifySubCategoryToSupabase(sub, oldParent, newParent) {
  var supabase = getSupabaseClient();
  if (!supabase || !supabaseUserId) return Promise.reject(new Error('Not signed in'));
  return supabase.from('categories').delete().eq('user_id', supabaseUserId).eq('parent', oldParent).eq('sub', sub).then(function(r1) {
    if (r1.error) return Promise.reject(new Error(r1.error.message));
    return supabase.from('categories').insert({ user_id: supabaseUserId, parent: newParent, sub: sub });
  }).then(function(r2) {
    if (r2.error) return Promise.reject(new Error(r2.error.message));
    return supabase.from('expenses').update({ parent: newParent }).eq('user_id', supabaseUserId).eq('sub', sub);
  }).then(function(r3) {
    if (r3.error) return Promise.reject(new Error(r3.error.message));
    return { success: true };
  });
}

function renameSubCategoryToSupabase(parent, oldSub, newSub) {
  var supabase = getSupabaseClient();
  if (!supabase || !supabaseUserId) return Promise.reject(new Error('Not signed in'));
  return supabase.from('categories').delete().eq('user_id', supabaseUserId).eq('parent', parent).eq('sub', oldSub).then(function(r1) {
    if (r1.error) return Promise.reject(new Error(r1.error.message));
    return supabase.from('categories').insert({ user_id: supabaseUserId, parent: parent, sub: newSub });
  }).then(function(r2) {
    if (r2.error) return Promise.reject(new Error(r2.error.message));
    return supabase.from('expenses').update({ sub: newSub }).eq('user_id', supabaseUserId).eq('parent', parent).eq('sub', oldSub);
  }).then(function(r3) {
    if (r3.error) return Promise.reject(new Error(r3.error.message));
    return supabase.from('recurring').update({ sub: newSub }).eq('user_id', supabaseUserId).eq('parent', parent).eq('sub', oldSub);
  }).then(function(r4) {
    if (r4.error) return Promise.reject(new Error(r4.error.message));
    return supabase.from('pending_transactions').update({ income_sub_category: newSub }).eq('user_id', supabaseUserId).eq('income_category', parent).eq('income_sub_category', oldSub);
  }).then(function(r5) {
    if (r5.error) return Promise.reject(new Error(r5.error.message));
    return supabase.from('pending_transactions').update({ transfer_sub_category: newSub }).eq('user_id', supabaseUserId).eq('transfer_category', parent).eq('transfer_sub_category', oldSub);
  }).then(function(r6) {
    if (r6.error) return Promise.reject(new Error(r6.error.message));
    return { success: true };
  });
}

function saveScheduleToSupabase(p) {
  var supabase = getSupabaseClient();
  if (!supabase || !supabaseUserId) return Promise.reject(new Error('Not signed in'));
  var id = p.scheduleId || ('SCH-' + new Date().getTime());
  var row = { id: id, user_id: supabaseUserId, frequency: p.frequency, start_date: p.startDate, end_date: p.endDate || null, type: p.type, sub: p.subCategory || '', parent: p.parentCategory || '', amount: Number(p.amount), mode: p.mode || '', source: p.source || '', remarks: p.remarks || '' };
  if (p.scheduleId) {
    return supabase.from('recurring').update({ frequency: row.frequency, start_date: row.start_date, end_date: row.end_date, type: row.type, sub: row.sub, parent: row.parent, amount: row.amount, mode: row.mode, source: row.source, remarks: row.remarks }).eq('user_id', supabaseUserId).eq('id', id).then(function(res) {
      if (res.error) return Promise.reject(new Error(res.error.message));
      return { success: true };
    });
  }
  return supabase.from('recurring').insert(row).then(function(res) {
    if (res.error) return Promise.reject(new Error(res.error.message));
    return { success: true };
  });
}

function deleteScheduleToSupabase(id) {
  var supabase = getSupabaseClient();
  if (!supabase || !supabaseUserId) return Promise.reject(new Error('Not signed in'));
  return supabase.from('recurring').delete().eq('user_id', supabaseUserId).eq('id', id).then(function(res) {
    if (res.error) return Promise.reject(new Error(res.error.message));
    return { success: true };
  });
}

function saveBudgetToSupabase(categoryKey, limitAmount) {
  var supabase = getSupabaseClient();
  if (!supabase || !supabaseUserId) return Promise.reject(new Error('Not signed in'));
  return supabase.from('budgets').upsert({ user_id: supabaseUserId, category_key: categoryKey, limit_amount: Number(limitAmount) }, { onConflict: 'user_id,category_key' }).then(function(res) {
    if (res.error) return Promise.reject(new Error(res.error.message));
    return { success: true };
  });
}

function deleteBudgetToSupabase(categoryKey) {
  var supabase = getSupabaseClient();
  if (!supabase || !supabaseUserId) return Promise.reject(new Error('Not signed in'));
  return supabase.from('budgets').delete().eq('user_id', supabaseUserId).eq('category_key', categoryKey).then(function(res) {
    if (res.error) return Promise.reject(new Error(res.error.message));
    return { success: true };
  });
}

function saveBatchTransactionsToSupabase(entries) {
  var supabase = getSupabaseClient();
  if (!supabase || !supabaseUserId) return Promise.reject(new Error('Not signed in'));
  var t = new Date().getTime();
  var rows = entries.map(function(e, i) {
    return { id: 'TXN-' + (t + i), user_id: supabaseUserId, date: e.date, type: e.type, sub: e.subCategory || '', parent: e.parentCategory || '', amount: Number(e.amount), mode: e.mode || '', source: e.source || '', remarks: e.remarks || '' };
  });
  if (rows.length === 0) return Promise.resolve({ success: true, savedIds: [] });
  return supabase.from('expenses').insert(rows).then(function(res) {
    if (res.error) return Promise.reject(new Error(res.error.message));
    return { success: true, savedIds: rows.map(function(r) { return r.id; }) };
  });
}

function deleteBulkTransactionsToSupabase(ids) {
  var supabase = getSupabaseClient();
  if (!supabase || !supabaseUserId) return Promise.reject(new Error('Not signed in'));
  return supabase.from('expenses').delete().eq('user_id', supabaseUserId).in('id', ids).then(function(res) {
    if (res.error) return Promise.reject(new Error(res.error.message));
    return 'Success';
  });
}

function updateBulkCategoryToSupabase(ids, newParent, newSub) {
  var supabase = getSupabaseClient();
  if (!supabase || !supabaseUserId) return Promise.reject(new Error('Not signed in'));
  var promises = ids.map(function(id) {
    return supabase.from('expenses').update({ parent: newParent, sub: newSub }).eq('user_id', supabaseUserId).eq('id', id);
  });
  return Promise.all(promises).then(function() { return 'Success'; });
}

function getPendingTransactionsFromSupabase() {
  var supabase = getSupabaseClient();
  if (!supabase || !supabaseUserId) return Promise.resolve([]);
  return supabase.from('pending_transactions').select('*').eq('user_id', supabaseUserId).eq('status', 'Pending').then(function(res) {
    if (res.error) return Promise.reject(new Error(res.error.message));
    return (res.data || []).map(function(r) {
      return { id: r.id, description: r.description, amount: r.amount, expectedDate: r.expected_date ? String(r.expected_date).split('T')[0] : '', incomeCategory: r.income_category, incomeSubCategory: r.income_sub_category, incomeAccount: r.income_account, transferAccount: r.transfer_account, transferCategory: r.transfer_category, transferSubCategory: r.transfer_sub_category };
    });
  });
}

function savePendingTransactionToSupabase(payload) {
  var supabase = getSupabaseClient();
  if (!supabase || !supabaseUserId) return Promise.reject(new Error('Not signed in'));
  var id = payload.pendingId && payload.pendingId !== '' ? payload.pendingId : 'PEND-' + new Date().getTime();
  var row = { id: id, user_id: supabaseUserId, description: payload.description, amount: Number(payload.amount), expected_date: payload.expectedDate, income_category: payload.incomeCategory || '', income_sub_category: payload.incomeSubCategory || '', income_account: payload.incomeAccount || '', transfer_account: payload.transferAccount || '', transfer_category: payload.transferCategory || '', transfer_sub_category: payload.transferSubCategory || '', status: 'Pending' };
  if (payload.pendingId && payload.pendingId !== '') {
    var upd = { description: row.description, amount: row.amount, expected_date: row.expected_date, income_category: row.income_category, income_sub_category: row.income_sub_category, income_account: row.income_account, transfer_account: row.transfer_account, transfer_category: row.transfer_category, transfer_sub_category: row.transfer_sub_category };
    return supabase.from('pending_transactions').update(upd).eq('user_id', supabaseUserId).eq('id', id).then(function(res) {
      if (res.error) return Promise.reject(new Error(res.error.message));
      return { status: 'success', message: 'Receivable Updated' };
    });
  }
  return supabase.from('pending_transactions').insert(row).then(function(res) {
    if (res.error) return Promise.reject(new Error(res.error.message));
    return { status: 'success', message: 'Receivable Saved' };
  });
}

function deletePendingTransactionToSupabase(id) {
  var supabase = getSupabaseClient();
  if (!supabase || !supabaseUserId) return Promise.reject(new Error('Not signed in'));
  return supabase.from('pending_transactions').delete().eq('user_id', supabaseUserId).eq('id', id).then(function(res) {
    if (res.error) return Promise.reject(new Error(res.error.message));
    return { status: 'success', message: 'Deleted successfully' };
  });
}

function approvePendingTransactionToSupabase(finalData) {
  var supabase = getSupabaseClient();
  if (!supabase || !supabaseUserId) return Promise.reject(new Error('Not signed in'));
  var t = new Date().getTime();
  var rows = [];
  rows.push({ id: 'TXN-'+t+'-INC', user_id: supabaseUserId, date: finalData.date, type: 'Income', sub: finalData.incomeSubCategory, parent: 'Income', amount: Number(finalData.amount), mode: 'Cashless', source: finalData.incomeAccount, remarks: finalData.description });
  var trf = finalData.transferAccount;
  if (trf && trf !== '') {
    if (trf.indexOf('[') === 0) {
      try {
        var splits = JSON.parse(trf);
        splits.forEach(function(split, i) {
          rows.push({ id: 'TXN-'+t+'-TRF'+i, user_id: supabaseUserId, date: finalData.date, type: 'Transfer', sub: split.sub || '', parent: split.parent || 'Transfer', amount: Number(split.amount), mode: 'Cashless', source: finalData.incomeAccount, remarks: 'Settlement: '+finalData.description+' | To: '+split.acct+': '+split.amount });
        });
      } catch(e) {}
    } else {
      rows.push({ id: 'TXN-'+t+'-TRF', user_id: supabaseUserId, date: finalData.date, type: 'Transfer', sub: finalData.transferSubCategory || '', parent: finalData.transferCategory || 'Transfer', amount: Number(finalData.amount), mode: 'Cashless', source: finalData.incomeAccount, remarks: 'Settlement: '+finalData.description+' | To: '+trf+': '+finalData.amount });
    }
  }
  return supabase.from('expenses').insert(rows).then(function(res) {
    if (res.error) return Promise.reject(new Error(res.error.message));
    return supabase.from('pending_transactions').delete().eq('user_id', supabaseUserId).eq('id', finalData.id);
  }).then(function(res) {
    if (res && res.error) return Promise.reject(new Error(res.error.message));
    return { status: 'success', message: 'Transaction Approved & Logged' };
  });
}

function saveSnapshotToSupabase(dateStr, balancesJSON) {
  var supabase = getSupabaseClient();
  if (!supabase || !supabaseUserId) return Promise.reject(new Error('Not signed in'));
  return supabase.from('balance_snapshots').upsert({ user_id: supabaseUserId, snapshot_date: dateStr, balances_json: balancesJSON, notes: 'User Generated' }, { onConflict: 'user_id,snapshot_date' }).then(function(res) {
    if (res.error) return Promise.reject(new Error(res.error.message));
    return 'Snapshot Saved';
  });
}

function fetchHistoryFromSupabase(year) {
  var supabase = getSupabaseClient();
  if (!supabase || !supabaseUserId) return Promise.reject(new Error('Not signed in'));
  var y = parseInt(year, 10);
  var start = year + '-01-01', end = year + '-12-31';
  return supabase.from('expenses').select('id, date, type, sub, parent, amount, mode, source, remarks').eq('user_id', supabaseUserId).gte('date', start).lte('date', end).order('date', { ascending: false }).then(function(res) {
    if (res.error) return Promise.reject(new Error(res.error.message));
    return (res.data || []).map(function(r) { return [r.id, r.date ? String(r.date).split('T')[0] : '', r.type, r.sub || '', r.parent || '', Number(r.amount), r.mode || '', r.source || '', r.remarks || '']; });
  });
}

// ==========================================
// 1. UTILITY FUNCTIONS & STATE (DEFINED FIRST)
// ==========================================
const toPaise = (v) => Math.round(Number(v) * 100);
const fromPaise = (v) => (v / 100).toFixed(2);
const fmtMoney = (v) => (v / 100).toLocaleString('en-IN', { minimumFractionDigits: 2 });

// GLOBAL STATE
let appData = { expenses: [], categories: {}, sources: [], scheduled: [], budgets: {}, schema: {} };
let liveBalances = {};
let sessionRecent = [];
let reclassifyTarget = { sub: null, oldParent: null };
let lastDeletedTxn = null;
let currentFilteredData = [];
let renderLimit = 50;
const BATCH_SIZE = 50;
let searchDebounceTimer;
let searchIndex = [];
let pendingItemsMap = {}; // SAFE STORAGE
let currentPendingItem = null;
let pendingConfirmCallback = null;

// ERROR HANDLING
window.onerror = function(msg, url, line) {
    document.getElementById('splash-title').innerText = "App Crash!";
    document.getElementById('splash-title').className = "text-lg font-bold text-red-600";
    document.getElementById('splash-status').innerText = "Error details below:";
    document.getElementById('splash-spinner').classList.add('hidden');
    document.getElementById('errorBox').classList.remove('hidden');
    document.getElementById('errorMsg').innerText = `${msg} (Line:${line})`;
    document.getElementById('forceLoadBtn').classList.remove('hidden');
};

function forceLoadApp(){
    document.getElementById('splash').classList.add('hidden');
    showToast("App forced open.", 'error');
}

function handleShortcuts(e) {
    if (e.ctrlKey || e.metaKey) {
        switch (e.key.toLowerCase()) {
            case 's':
                e.preventDefault();
                // Check if we are on the Entry Tab
                if (!document.getElementById('tab-entry').classList.contains('hidden')) {
                    const isBulkMode = !document.getElementById('container-bulk').classList.contains('hidden');
                    
                    if (isBulkMode) {
                        // Submit Bulk Form
                        document.getElementById('bulkForm').requestSubmit();
                    } else {
                        // Submit Single Form
                        document.getElementById('txnForm').requestSubmit();
                    }
                }
                break;

            case 'n':
                e.preventDefault();
                resetForm();
                switchTab('entry');
                break;

            case 'r':
                e.preventDefault();
                switchTab('reports');
                break;

            case 'e':
                e.preventDefault();
                switchTab('entry');
                break;
        }
    }
}

function setDateFilter(m) {
    const s = document.getElementById('filterStartDate');
    const e = document.getElementById('filterEndDate');
    const now = new Date();
    const y = now.getFullYear();
    const mo = now.getMonth() + 1; // 1-12
    const d = now.getDate();
    
    // Helper: Returns YYYY-MM-DD string safely
    const fmt = (dateObj) => {
        const year = dateObj.getFullYear();
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const day = String(dateObj.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    if (m === 'thisMonth') {
        // String construction - Zero Ambiguity
        s.value = `${y}-${String(mo).padStart(2,'0')}-01`;
        // Last day calculation using date math (safe for getting "last day")
        const lastDay = new Date(y, mo, 0).getDate(); 
        e.value = `${y}-${String(mo).padStart(2,'0')}-${lastDay}`;
    } 
    else if (m === 'lastMonth') {
        const lastMoObj = new Date(y, mo - 2, 1); // Go back 1 month safely
        const ly = lastMoObj.getFullYear();
        const lm = lastMoObj.getMonth() + 1;
        s.value = `${ly}-${String(lm).padStart(2,'0')}-01`;
        const lastDay = new Date(ly, lm, 0).getDate();
        e.value = `${ly}-${String(lm).padStart(2,'0')}-${lastDay}`;
    } 
    else if (m === 'last7') {
        // Safe subtraction
        const past = new Date(now);
        past.setDate(d - 7);
        s.value = fmt(past);
        e.value = fmt(now);
    } 
    else if (m === 'thisYear') {
        s.value = `${y}-01-01`;
        e.value = `${y}-12-31`;
    } 
    else {
        s.value = '';
        e.value = '';
    }
    
    localStorage.setItem('lastDateFilter', m);
    renderReportTable();
}

// ==========================================
// 2. CORE FUNCTIONS
// ==========================================

function onDataLoad(json) {
    try {
        const data = JSON.parse(json);
        appData = data;
        // Defaults
        if (!appData.categories) appData.categories = {};
        if (!appData.sources) appData.sources = [];
        if (!appData.scheduled) appData.scheduled = [];
        if (!appData.budgets) appData.budgets = {};
        if (!appData.expenses) appData.expenses = [];
        if (appData.schema) Object.freeze(appData.schema);

        // Date Fixes
        const s = appData.schema;
        appData.expenses.forEach(r => {
            if (r[s.date]) {
                const dStr = String(r[s.date]).split('T')[0];
                r[s.date] = dStr;
                const parts = dStr.split('-');
                const dt = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
                r._day = dt.getDay();
            }
        });

        appData.expenses.sort((a, b) => (a[s.date] < b[s.date] ? 1 : -1));

        buildSearchIndex();
        refreshAllDatalists();
        refreshTransferDropdowns();
        populateFilterDropdowns();
        populateRemarksDatalist();
        calculateLiveBalances();

        const savedDate = localStorage.getItem('lastDateFilter') || 'thisMonth';
        setDateFilter(savedDate);

        renderRecentList();
		if (appData.pending) renderPendingTable(appData.pending);
        renderScheduledTable();
        renderBudgetView();
        resetBulkForm();
        resetForm();
        renderQuickFilterBar();

        document.getElementById('splash').classList.add('hidden');
        if (supabaseUserId) {
            var so = document.getElementById('signOutBtn');
            if (so) so.classList.remove('hidden');
        }
    } catch (e) {
        document.getElementById('errorMsg').innerText = "Data Parse Error: " + e.message;
        document.getElementById('errorBox').classList.remove('hidden');
    }
}

function signOutSupabase() {
    var supabase = getSupabaseClient();
    if (supabase) {
        supabase.auth.signOut().then(function() {
            supabaseUserId = null;
            document.location.reload();
        });
    }
}

// SEARCH & UTILS
function buildSearchIndex() {
    // Only index text fields: Sub-Category, Parent, Source, Remarks
    const s = appData.schema;
    searchIndex = appData.expenses.map((r, i) => ({
        idx: i,
        txt: [
            r[s.sub], 
            r[s.parent], 
            String(r[s.source] || ""), 
            String(r[s.remarks] || "")
        ].join(" ").toLowerCase()
    }));
}

function validateTransaction(d) {
    if (!d.date) return { ok: false, msg: "Date is required" };
    if (Number(d.amount) <= 0) return { ok: false, msg: "Amount must be > 0" };
    if (d.type !== 'Transfer' && !d.subCategory) return { ok: false, msg: "Sub-Category required" };
    if (d.type === 'Transfer' && !d.source) return { ok: false, msg: "Source account required" };
    return { ok: true };
}

function safeFeatherReplace() {
    if (typeof feather !== 'undefined') feather.replace();
}

function showToast(msg, type = 'success') {
    const c = document.getElementById('toast-container');
    const el = document.createElement('div');
    const isE = type === 'error', isU = type === 'undo';
    let cl = isE ? 'border-red-500 text-red-700 bg-white' : isU ? 'border-purple-500 text-purple-700 bg-white' : 'border-green-500 text-green-700 bg-white';
    let ic = isE ? 'alert-circle' : isU ? 'corner-up-left' : 'check-circle';
    
    el.className = `pointer-events-auto border-l-4 ${cl} px-4 py-3 rounded shadow-xl flex items-center gap-3 transform transition-all duration-300 translate-y-5 opacity-0`;
    el.innerHTML = `<i data-feather="${ic}" class="w-5 h-5"></i><span class="text-sm font-semibold flex-grow">${msg}</span>`;
    
    if (isU) el.innerHTML += `<button onclick="handleUndo(this.parentElement)" class="text-xs bg-purple-100 px-2 py-1 rounded font-bold">UNDO</button>`;
    
    c.appendChild(el);
    safeFeatherReplace();
    
    requestAnimationFrame(() => el.classList.remove('translate-y-5', 'opacity-0'));
    setTimeout(() => {
        if (el.parentNode) {
            el.classList.add('opacity-0', 'translate-y-5');
            setTimeout(() => el.remove(), 300);
        }
    }, isU ? 5000 : 3000);
}

// UI LOGIC
function initTheme() {
    if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
    } else {
        document.documentElement.classList.remove('dark');
    }
}

function toggleTheme() {
    document.documentElement.classList.toggle('dark');
    localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
}

function switchTab(t) {
    document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
    document.getElementById('tab-' + t).classList.remove('hidden');
    document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
    document.getElementById('nav-' + t).classList.add('active');
    
    if (t === 'settings') renderSettingsUI();
    if (t === 'reports') renderReportTable();
    if (t === 'budgets') renderBudgetView();
    if (t === 'pending') loadPendingTransactions();
    if (t === 'dashboard') renderDashboard(); // <--- NEW LINE
}


function openConfirmModal(msg, callback, title="Confirm Delete", btnText="Delete") {
    document.getElementById('confirmTitle').innerText = title;
    document.getElementById('confirmMessage').innerText = msg;
    const btn = document.getElementById('btnConfirmAction');
    btn.innerText = btnText;
    
    // Store the function to run if user clicks "Delete"
    pendingConfirmCallback = callback;
    
    document.getElementById('confirmModal').classList.remove('hidden');
    safeFeatherReplace(); // Ensure icon renders
}

function closeConfirmModal() {
    document.getElementById('confirmModal').classList.add('hidden');
    pendingConfirmCallback = null;
}

function executeConfirmAction() {
    if (pendingConfirmCallback) pendingConfirmCallback();
    closeConfirmModal();
}
// ==========================================
// 3. PENDING TRANSACTIONS LOGIC (SAFE LOOKUP)
// ==========================================

function handlePendingSubInput(i) {
    const v = i.value;
    const p = document.getElementById('pendIncParent');
    let f = "";
    for (const [k, vals] of Object.entries(appData.categories)) {
        if (Array.isArray(vals) && vals.map(String).includes(v)) {
            f = k;
            break;
        }
    }
    p.value = f;
}

function handlePendingIncomeInput(i) { /* No logic needed */ }

function handlePendingTransferSubInput(i) {
    const v = i.value;
    const p = i.nextElementSibling;
    let f = "";
    for (const [k, vals] of Object.entries(appData.categories)) {
        if (Array.isArray(vals) && vals.map(String).includes(v)) {
            f = k;
            break;
        }
    }
    if (p) p.value = f;
}

function loadPendingTransactions() {
    if (useSupabase()) {
        getPendingTransactionsFromSupabase().then(renderPendingTable).catch(function(e) { showToast(e&&e.message?e.message:'Failed to load','error'); });
    } else {
        google.script.run.withSuccessHandler(renderPendingTable).getPendingTransactions();
    }
}

function renderPendingTable(data) {
    const tbody = document.getElementById('pendingTableBody');
    const statsContainer = document.getElementById('pendingStatsBar'); 
    const summaryContainer = document.getElementById('pendingInflowSummary'); // NEW
    
    tbody.innerHTML = "";
    summaryContainer.innerHTML = ""; // Clear previous summary
    pendingItemsMap = {};

    let totalPending = 0;
    let totalOverdue = 0;
    let totalMonth = 0;
    const todayStr = new Date().toISOString().split('T')[0];
    const currentMonth = todayStr.substring(0, 7);

    // --- NEW: CASHFLOW PROJECTION MAP ---
    const flowMap = {}; 

    if (!data || data.length === 0) {
        tbody.innerHTML = "<tr><td colspan='5' class='p-4 text-center text-gray-500 italic'>No pending payments.</td></tr>";
        statsContainer.innerHTML = renderStatCard("Total Pending", 0, "gray") + 
                                   renderStatCard("Overdue", 0, "red") + 
                                   renderStatCard("Due This Month", 0, "blue");
        return;
    }

    data.forEach(item => {
        pendingItemsMap[item.id] = item;
        const amt = parseFloat(item.amount) || 0;
        
        // 1. Stats Calculation
        totalPending += amt;
        if (item.expectedDate < todayStr) totalOverdue += amt;
        if (item.expectedDate.startsWith(currentMonth)) totalMonth += amt;

        // 2. Flow Calculation (Where will money go?)
        const incAcct = item.incomeAccount;
        
        // Step A: Money lands in Deposit Account
        flowMap[incAcct] = (flowMap[incAcct] || 0) + amt;

        // Step B: Handle Transfers (Money moves OUT of Deposit -> INTO Dest)
        if (item.transferAccount) {
            if (item.transferAccount.startsWith('[')) {
                // Split Transfers
                try {
                    const splits = JSON.parse(item.transferAccount);
                    splits.forEach(s => {
                        const sAmt = parseFloat(s.amount) || 0;
                        const sDest = s.acct;
                        
                        flowMap[incAcct] -= sAmt; // Subtract from Source
                        flowMap[sDest] = (flowMap[sDest] || 0) + sAmt; // Add to Dest
                    });
                } catch(e) { console.error("Parse error", e); }
            } else {
                // Single Transfer (Assume full amount moves if simplistic)
                // Based on your form logic, usually "Transfer" implies moving specific amount.
                // If your legacy data implies full move:
                const sAmt = amt; 
                flowMap[incAcct] -= sAmt;
                flowMap[item.transferAccount] = (flowMap[item.transferAccount] || 0) + sAmt;
            }
        }

        // 3. Render Table Row (Existing Logic)
        const isOverdue = item.expectedDate < todayStr;
        const dateClass = isOverdue ? 'status-overdue' : 'text-gray-700 dark:text-gray-300';
        let flowStr = `${item.incomeAccount}`;
        if (item.transferAccount && item.transferAccount.startsWith('[')) {
            flowStr += ` &#8594; ${JSON.parse(item.transferAccount).length} Splits`;
        } else if (item.transferAccount) {
            flowStr += ` &#8594; ${item.transferAccount}`;
        }

        tbody.innerHTML += `
        <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition">
          <td class="p-3 font-medium ${dateClass}">${item.expectedDate}</td>
          <td class="p-3 font-semibold text-gray-800 dark:text-gray-200">${item.description}</td>
          <td class="p-3 font-mono font-bold text-gray-800 dark:text-gray-100">₹${Number(item.amount).toLocaleString('en-IN')}</td>
          <td class="p-3 text-xs text-gray-500"><small>${flowStr}</small></td>
          <td class="p-3 flex gap-2 justify-center">
            <button onclick="initiateApprove('${item.id}')" class="text-green-600 hover:text-green-800 p-1 bg-green-50 dark:bg-green-900/30 rounded"><i data-feather="check-circle" class="w-4 h-4"></i></button>
            <button onclick="initiateEdit('${item.id}')" class="text-blue-500 hover:text-blue-700 p-1 bg-blue-50 dark:bg-blue-900/30 rounded"><i data-feather="edit-2" class="w-4 h-4"></i></button>
            <button onclick="deletePendingItem('${item.id}')" class="text-red-400 hover:text-red-600 p-1 bg-red-50 dark:bg-red-900/30 rounded"><i data-feather="trash-2" class="w-4 h-4"></i></button>
          </td>
        </tr>`;
    });

    // 4. Render Flow Summary
    // Sort by amount (Highest first) and ignore Zeros
    Object.entries(flowMap)
        .filter(([_, val]) => Math.abs(val) > 1) // Filter out negligible amounts (float precision)
        .sort((a,b) => b[1] - a[1])
        .forEach(([acct, val]) => {
            summaryContainer.innerHTML += `
            <div class="flex items-center gap-2 bg-emerald-50 dark:bg-emerald-900/20 px-3 py-2 rounded-lg border border-emerald-100 dark:border-emerald-800">
                <span class="text-[10px] font-bold text-emerald-800 dark:text-emerald-300 uppercase">${acct}</span>
                <span class="text-xs font-mono font-bold text-emerald-600 dark:text-emerald-400">+₹${Number(val).toLocaleString('en-IN')}</span>
            </div>`;
        });

    // Render Stats
    statsContainer.innerHTML = 
        renderStatCard("Total Pending", totalPending, "gray") + 
        renderStatCard("Overdue", totalOverdue, "red") + 
        renderStatCard("Due This Month", totalMonth, "blue");

    safeFeatherReplace();
}

// Helper to keep HTML clean
function renderStatCard(title, value, colorName) {
    const colors = {
        gray: { bg: 'bg-gray-100 dark:bg-gray-700', txt: 'text-gray-600 dark:text-gray-300', val: 'text-gray-800 dark:text-white' },
        red:  { bg: 'bg-red-50 dark:bg-red-900/30', txt: 'text-red-600 dark:text-red-300', val: 'text-red-700 dark:text-red-200' },
        blue: { bg: 'bg-blue-50 dark:bg-blue-900/30', txt: 'text-blue-600 dark:text-blue-300', val: 'text-blue-700 dark:text-blue-200' }
    };
    const c = colors[colorName] || colors.gray;
    
    // FIX: Smart Formatting
    // If it's a number, format as currency. If it's text, leave it alone.
    let displayVal = value;
    if (typeof value === 'number' || (!isNaN(parseFloat(value)) && isFinite(value))) {
        displayVal = "₹" + Number(value).toLocaleString('en-IN');
    }
    
    return `
    <div class="${c.bg} p-3 rounded-lg border border-transparent dark:border-gray-600 flex flex-col justify-center items-center shadow-sm">
        <span class="text-[10px] font-bold uppercase ${c.txt} mb-1">${title}</span>
        <span class="text-lg font-mono font-bold ${c.val}">${displayVal}</span>
    </div>`;
}

function addPendingTransferRow(acct = "", sub = "", amt = "") {
    const d = document.createElement('div');
    d.className = "flex gap-1 pend-split-row items-center w-full";
    
    let acctOpts = '<option value="" disabled selected>Acct</option>';
    (appData.sources || []).forEach(s => {
        let n = Array.isArray(s) ? s[0] : s;
        acctOpts += `<option value="${n}" ${n === acct ? 'selected' : ''}>${n}</option>`;
    });

    d.innerHTML = `
        <select class="pend-trf-acct w-1/4 py-1 px-1 text-[10px] border border-blue-200 dark:border-blue-800 rounded outline-none">${acctOpts}</select>
        <div class="flex-1 relative">
            <input list="expenseSubList" class="pend-trf-sub w-full py-1 px-1 text-[10px] border border-blue-200 dark:border-blue-800 rounded outline-none" placeholder="Sub-Cat" value="${sub}" oninput="handlePendingTransferSubInput(this)">
            <input type="hidden" class="pend-trf-parent">
        </div>
        <input type="number" class="pend-trf-amt w-16 py-1 px-1 text-[10px] font-mono border border-blue-200 dark:border-blue-800 rounded outline-none" placeholder="Amt" value="${amt}" oninput="validatePendingSplits()">
        <button type="button" onclick="this.parentElement.remove(); validatePendingSplits()" class="text-red-400 hover:text-red-600 p-0.5"><i data-feather="x" class="w-3 h-3"></i></button>
    `;
    
    document.getElementById('pendingSplitList').appendChild(d);
    
    if (sub) {
        const inp = d.querySelector('.pend-trf-sub');
        handlePendingTransferSubInput(inp);
    }
    
    safeFeatherReplace();
    validatePendingSplits();
}

function validatePendingSplits() {
    const total = toPaise(document.getElementById('pendAmount').value) || 0;
    let splitSum = 0;
    
    document.querySelectorAll('.pend-split-row').forEach(row => {
        splitSum += toPaise(row.querySelector('.pend-trf-amt').value) || 0;
    });
    
    const display = document.getElementById('pendSplitTotal');
    display.innerText = `Allocated: ₹${fromPaise(splitSum)}`;
    
    if (splitSum > 0 && splitSum !== total) {
        display.classList.add('text-red-600', 'font-bold');
        display.classList.remove('text-gray-500');
        return false;
    } else {
        display.classList.remove('text-red-600', 'font-bold');
        display.classList.add('text-gray-500');
        return true;
    }
}

function handlePendingSubmit(e) {
    e.preventDefault();
    const btn = document.getElementById('btnPendSubmit');
    const sub = document.getElementById('pendIncSub').value;
    const parent = document.getElementById('pendIncParent').value;
    
    if (!sub || !parent) return showToast("Invalid Category", 'error');
    
    if (document.querySelectorAll('.pend-split-row').length > 0 && !validatePendingSplits()) {
        return showToast("Split total mismatch", 'error');
    }

    const splits = [];
    document.querySelectorAll('.pend-split-row').forEach(row => {
        const acct = row.querySelector('.pend-trf-acct').value;
        const sVal = row.querySelector('.pend-trf-sub').value;
        const pVal = row.querySelector('.pend-trf-parent').value;
        const amt = row.querySelector('.pend-trf-amt').value;
        if (acct && sVal && amt) {
            splits.push({ acct: acct, sub: sVal, parent: pVal || 'Expense', amount: amt });
        }
    });

    const payload = {
        pendingId: document.getElementById('pendingId').value,
        description: document.getElementById('pendDesc').value,
        amount: document.getElementById('pendAmount').value,
        expectedDate: document.getElementById('pendDate').value,
        incomeCategory: parent,
        incomeSubCategory: sub,
        incomeAccount: document.getElementById('pendIncAccount').value,
        transferSplits: JSON.stringify(splits),
    };

    btn.innerText = "Saving...";
    btn.disabled = true;

    function done(res) {
        showToast(res.message);
        resetPendingForm();
        loadPendingTransactions();
        btn.innerText = "Log Pending";
        btn.disabled = false;
    }
    function fail(err) {
        showToast(err&&err.message?err.message:'Failed','error');
        btn.innerText = "Log Pending";
        btn.disabled = false;
    }
    if (useSupabase()) {
        payload.transferAccount = payload.transferSplits && payload.transferSplits !== '[]' ? payload.transferSplits : '';
        payload.transferCategory = payload.transferSplits && payload.transferSplits !== '[]' ? 'Split' : '';
        payload.transferSubCategory = payload.transferSplits && payload.transferSplits !== '[]' ? 'Split' : '';
        savePendingTransactionToSupabase(payload).then(done).catch(fail);
    } else {
        google.script.run.withSuccessHandler(done).withFailureHandler(fail).savePendingTransaction(payload);
    }
}

function deletePendingItem(id) {
    openConfirmModal("Remove this pending item permanently?", function() {
        if (useSupabase()) {
            deletePendingTransactionToSupabase(id).then(function() { showToast("Deleted"); loadPendingTransactions(); }).catch(function(e) { showToast(e&&e.message?e.message:'Failed','error'); });
        } else {
            google.script.run.withSuccessHandler(function() { showToast("Deleted"); loadPendingTransactions(); }).deletePendingTransaction(id);
        }
    });
}

function initiateEdit(id) {
    const item = pendingItemsMap[id];
    if(!item) return showToast("Error: Item not found", 'error');

    document.getElementById('pendingId').value = item.id;
    document.getElementById('pendDesc').value = item.description;
    document.getElementById('pendAmount').value = item.amount;
    document.getElementById('pendDate').value = item.expectedDate;
    document.getElementById('pendIncSub').value = item.incomeSubCategory;
    document.getElementById('pendIncParent').value = item.incomeCategory;
    document.getElementById('pendIncAccount').value = item.incomeAccount;
    
    document.getElementById('pendingSplitList').innerHTML = '';
    
    if (item.transferAccount && item.transferAccount.startsWith('[')) {
        const splits = JSON.parse(item.transferAccount);
        splits.forEach(s => addPendingTransferRow(s.acct, s.sub, s.amount));
    } else if (item.transferAccount) {
        addPendingTransferRow(item.transferAccount, item.transferSubCategory, item.amount);
    }

    document.getElementById('pendingFormTitle').innerText = "Edit Receivable";
    const btn = document.getElementById('btnPendSubmit');
    btn.innerText = "Update";
    btn.classList.replace('bg-orange-600', 'bg-blue-600');
    btn.classList.replace('hover:bg-orange-700', 'hover:bg-blue-700');
}

function resetPendingForm() {
    document.getElementById('pendingForm').reset();
    document.getElementById('pendingId').value = "";
    document.getElementById('pendingSplitList').innerHTML = '';
    document.getElementById('pendSplitTotal').innerText = '';
    document.getElementById('pendingFormTitle').innerText = "Add Receivable";
    
    const btn = document.getElementById('btnPendSubmit');
    btn.innerText = "Log Pending";
    btn.classList.replace('bg-blue-600', 'bg-orange-600');
    btn.classList.replace('hover:bg-blue-700', 'hover:bg-orange-700');
    
    const now = new Date();
    document.getElementById('pendDate').value = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
}

function initiateApprove(id) {
    currentPendingItem = pendingItemsMap[id];
    if(!currentPendingItem) return showToast("Error: Item not found", 'error');

    document.getElementById('approveAmount').value = currentPendingItem.amount;
    document.getElementById('approveDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('approveModal').classList.remove('hidden');
}

function closeApproveModal() {
    document.getElementById('approveModal').classList.add('hidden');
    currentPendingItem = null;
}

function submitApproval() {
    if (!currentPendingItem) return;
    
    // 1. LOCK THE UI
    const btn = document.getElementById('btnApproveConfirm');
    const originalText = btn.innerText;
    
    // Change Visual State
    btn.innerText = "Processing...";
    btn.disabled = true;
    btn.classList.add('opacity-50', 'cursor-not-allowed'); // Make it look disabled
    
    currentPendingItem.amount = document.getElementById('approveAmount').value;
    currentPendingItem.date = document.getElementById('approveDate').value;
    
    function onSuccess(res) {
        closeApproveModal();
        loadPendingTransactions();
        if (res.status === 'success') {
            showToast(res.message);
            if (useSupabase()) fetchInitialDataFromSupabase().then(function(data) { onDataLoad(JSON.stringify(data)); });
            else google.script.run.withSuccessHandler(onDataLoad).getInitialData();
        } else {
            showToast(res.message, 'error');
        }
        btn.innerText = originalText;
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
    }
    function onFail(e) {
        showToast("Server Error: " + (e&&e.message?e.message:''), 'error');
        btn.innerText = originalText;
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
    }
    if (useSupabase()) {
        approvePendingTransactionToSupabase(currentPendingItem).then(onSuccess).catch(onFail);
    } else {
        google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFail).approvePendingTransaction(currentPendingItem);
    }
}

// ==========================================
// 4. REST OF STANDARD FUNCTIONS
// ==========================================
function handleSchSubInput(i) {
    const v = i.value;
    const p = document.getElementById('schParent'); // Targets the specific Scheduled Parent field
    let f = "";
    
    // Search your categories data
    for (const [k, vals] of Object.entries(appData.categories)) {
        if (Array.isArray(vals) && vals.map(String).includes(v)) {
            f = k;
            break;
        }
    }
    
    p.value = f;
}
function refreshTransferDropdowns(){const mode=document.getElementById('inpMode').value;const filter=mode==='Cash'?'Cash':'Cashless';['inpTransferSource','schSource','bulkGlobalSource', 'pendIncAccount'].forEach(id=>{const el=document.getElementById(id);if(!el)return;const existingVal=el.value;let defaultText=id==='bulkGlobalSource'?"Select Source...":"Select Account...";el.innerHTML=`<option value="" disabled selected>${defaultText}</option>`;if(appData&&appData.sources){appData.sources.forEach(s=>{const n=Array.isArray(s)?s[0]:s;const type=Array.isArray(s)?(s[1]||'Bank'):'Bank';if(filter==='Cash'){if(type==='Cash')el.innerHTML+=`<option value="${n}">${n}</option>`;}else{if(type!=='Cash')el.innerHTML+=`<option value="${n}">${n}</option>`;}});}if(existingVal&&Array.from(el.options).some(o=>o.value===existingVal))el.value=existingVal;else el.value='';});}
function populateFilterDropdowns(){const p=document.getElementById('filterParent'),s=document.getElementById('filterSub'),src=document.getElementById('filterSource'),m=document.getElementById('modalParentList'),b=document.getElementById('budgetCat'),bulkP=document.getElementById('bulkParent');if(!appData||!appData.categories)return;if(p){p.innerHTML='<option value="">All Parents</option>';Object.keys(appData.categories).sort().forEach(k=>p.innerHTML+=`<option value="${k}">${k}</option>`);}if(s){updateSubFilter();}if(src){src.innerHTML='<option value="">All Sources</option>';(appData.sources||[]).forEach(r=>{let n=Array.isArray(r)?r[0]:r;src.innerHTML+=`<option value="${n}">${n}</option>`;});}if(m){m.innerHTML='';Object.keys(appData.categories).sort().forEach(k=>m.innerHTML+=`<option value="${k}">`);}if(b){b.innerHTML='<option value="">Select Category</option>';Object.keys(appData.categories).sort().forEach(k=>b.innerHTML+=`<option value="${k}">${k}</option>`);}if(bulkP){bulkP.innerHTML='<option value="" disabled selected>Select Parent...</option>';Object.keys(appData.categories).sort().forEach(k=>bulkP.innerHTML+=`<option value="${k}">${k}</option>`);} const incList = document.getElementById('incomeSubList'); if(incList && appData.categories['Income']){ incList.innerHTML = ''; appData.categories['Income'].forEach(sub => { incList.innerHTML += `<option value="${sub}"></option>`; }); } const expList = document.getElementById('expenseSubList'); if(expList){ expList.innerHTML = ''; Object.keys(appData.categories).forEach(parent => { if(parent !== 'Income'){ (appData.categories[parent]||[]).forEach(sub => { expList.innerHTML += `<option value="${sub}">${parent}</option>`; }); } }); } }
function updateSubFilter(){const p=document.getElementById('filterParent').value;const s=document.getElementById('filterSub');if(!s)return;s.innerHTML='<option value="">All Sub-Cats</option>';let list=[];if(p&&appData.categories[p]){list=appData.categories[p];}else{const set=new Set();Object.values(appData.categories).flat().forEach(x=>set.add(x));list=Array.from(set).sort();}list.forEach(x=>s.innerHTML+=`<option value="${x}">${x}</option>`);}
function populateRemarksDatalist(){const dl=document.getElementById('remarksList');if(!dl)return;const u=new Set();for(let i=appData.expenses.length-1;i>=0&&u.size<20;i--){if(appData.expenses[i][appData.schema.remarks])u.add(appData.expenses[i][appData.schema.remarks]);}dl.innerHTML='';u.forEach(r=>{const o=document.createElement('option');o.value=r;dl.appendChild(o);});}
function refreshAllDatalists(){const t=document.getElementById('inpType').value,dl=document.getElementById('subCatList');dl.innerHTML='';for(const[p,subs]of Object.entries(appData.categories)){if((t==='Income'&&p!=='Income')||(t!=='Income'&&p==='Income'))continue;subs.forEach(s=>{const o=document.createElement('option');o.value=s;dl.appendChild(o);});} handleModeChange();}
function renderSettingsUI(){const s=document.getElementById('settingsSourceList'),p=document.getElementById('settingsParentList'),sub=document.getElementById('settingsSubList');if(!s||!p||!sub)return;const qf=getQuickFilters();const esc=(str)=>str.replace(/'/g,"\\'");s.innerHTML=(appData.sources||[]).map((r,i)=>{const n=Array.isArray(r)?r[0]:r,type=Array.isArray(r)?(r[1]||'Bank'):'Bank';const openVal=Array.isArray(r)?(Number(r[2])||0):0;const f=Array.isArray(r)?r[6]:false,def=Array.isArray(r)?r[7]:false;return `<div class="flex justify-between items-center bg-gray-50 dark:bg-gray-800 p-2 rounded border border-gray-100 dark:border-gray-700 text-sm"><div class="flex flex-col gap-0.5"><span class="font-medium text-gray-700 dark:text-gray-300">${n}</span><span class="text-[10px] text-gray-400 uppercase tracking-wider">${type}</span><span class="text-[10px] text-gray-500">Opening: <input type="number" step="0.01" class="w-20 text-xs border border-gray-300 dark:border-gray-600 rounded px-1 bg-white dark:bg-gray-700" value="${openVal}" onchange="updateSourceOpeningByIndex(${i}, this.value)" title="Set opening/current balance"></span></div><div class="flex gap-2"><button onclick="toggleFlag('${esc(n)}','fav',${!f},this)" class="${f?'text-yellow-500':'text-gray-300'}"><i data-feather="star" class="w-4 h-4"></i></button><button onclick="toggleFlag('${esc(n)}','def',${!def},this)" class="${def?'text-green-600':'text-gray-300'}"><i data-feather="check-circle" class="w-4 h-4"></i></button><button onclick="delSet('source','${esc(n)}')" class="text-red-400"><i data-feather="trash-2" class="w-4 h-4"></i></button></div></div>`;}).join('');p.innerHTML=Object.keys(appData.categories).map(x=>{const isPinned=qf.includes(x);return `<div class="flex justify-between items-center bg-blue-50 dark:bg-blue-900/30 p-2 rounded text-xs border border-blue-100 dark:border-blue-800"><span class="font-bold text-blue-800 dark:text-blue-200">${x}</span><div class="flex gap-2"><button onclick="toggleQuickFilter('${esc(x)}')" class="${isPinned?'text-indigo-600 fill-current':'text-gray-300 hover:text-indigo-400'}"><i data-feather="bookmark" class="w-3 h-3 ${isPinned?'fill-current':''}"></i></button><button onclick="renameParentCat('${esc(x)}')" class="text-blue-500 hover:text-blue-700"><i data-feather="edit-2" class="w-3 h-3"></i></button><button onclick="deleteParentCat('${esc(x)}')" class="text-red-400 hover:text-red-600"><i data-feather="trash-2" class="w-3 h-3"></i></button></div></div>`;}).join('');const sel=document.getElementById('selParentForSub'),cur=sel.value;sel.innerHTML='<option disabled selected>Select Parent First</option>';Object.keys(appData.categories).sort().forEach(k=>sel.innerHTML+=`<option value="${k}">${k}</option>`);if(cur&&appData.categories[cur])sel.value=cur;const par=sel.value;if(par&&!par.includes('Select')){sub.innerHTML=(appData.categories[par]||[]).map(item=>{const isPinned=qf.includes(item);return `<div class="flex justify-between items-center bg-gray-50 dark:bg-gray-800 p-2 rounded border border-gray-100 dark:border-gray-700 text-sm"><span class="font-medium text-gray-700 dark:text-gray-300">${item}</span><div class="flex gap-2"><button onclick="toggleQuickFilter('${esc(item)}')" class="${isPinned?'text-indigo-600':'text-gray-300 hover:text-indigo-400'}"><i data-feather="bookmark" class="w-4 h-4 ${isPinned?'fill-current':''}"></i></button><button onclick="renameSubCat('${esc(par)}','${esc(item)}')" class="text-blue-500 hover:text-blue-700" title="Rename sub-category"><i data-feather="edit-2" class="w-4 h-4"></i></button><button onclick="reclass('${esc(item)}','${par}')" class="text-blue-500"><i data-feather="corner-up-right" class="w-4 h-4"></i></button><button onclick="delSet('sub','${esc(item)}','${par}')" class="text-red-400"><i data-feather="trash-2" class="w-4 h-4"></i></button></div></div>`;}).join('');}safeFeatherReplace();}
var renameModalTarget = null;

function openRenameModal(type, oldName, parent) {
    renameModalTarget = type === 'parent' ? { type: 'parent', oldName: oldName } : { type: 'sub', parent: parent, oldSub: oldName };
    var titleEl = document.getElementById('renameModalTitle');
    var labelEl = document.getElementById('renameModalLabel');
    var inputEl = document.getElementById('renameModalInput');
    var errEl = document.getElementById('renameModalError');
    if (titleEl) titleEl.textContent = type === 'parent' ? 'Rename parent category' : 'Rename sub-category';
    if (labelEl) labelEl.textContent = type === 'parent' ? ('Current: "' + oldName + '"') : ('Current: "' + oldName + '" (under ' + (parent || '') + ')');
    if (inputEl) { inputEl.value = oldName; inputEl.select(); }
    if (errEl) { errEl.classList.add('hidden'); errEl.textContent = ''; }
    document.getElementById('renameModal').classList.remove('hidden');
    setTimeout(function() { if (inputEl) inputEl.focus(); }, 100);
}

function closeRenameModal() {
    renameModalTarget = null;
    document.getElementById('renameModal').classList.add('hidden');
    var errEl = document.getElementById('renameModalError');
    if (errEl) { errEl.classList.add('hidden'); errEl.textContent = ''; }
}

function confirmRenameModal() {
    if (!renameModalTarget) return;
    var inputEl = document.getElementById('renameModalInput');
    var errEl = document.getElementById('renameModalError');
    var newName = (inputEl && inputEl.value || '').trim();
    if (!newName) {
        if (errEl) { errEl.textContent = 'Please enter a name.'; errEl.classList.remove('hidden'); }
        return;
    }
    if (renameModalTarget.type === 'parent') {
        var oldName = renameModalTarget.oldName;
        if (newName === oldName) { closeRenameModal(); return; }
        if (appData.categories[newName]) {
            if (errEl) { errEl.textContent = 'A category with this name already exists.'; errEl.classList.remove('hidden'); }
            return;
        }
        appData.categories[newName] = appData.categories[oldName];
        delete appData.categories[oldName];
        var s = appData.schema;
        appData.expenses.forEach(function(r) { if (r[s.parent] === oldName) r[s.parent] = newName; });
        if (appData.scheduled) {
            appData.scheduled.forEach(function(r) { if (r[6] === oldName) r[6] = newName; });
        }
        if (appData.pending) {
            appData.pending.forEach(function(item) {
                if (item.incomeCategory === oldName) item.incomeCategory = newName;
                if (item.transferCategory === oldName) item.transferCategory = newName;
            });
        }
        if (typeof buildSearchIndex === 'function') buildSearchIndex();
        renderSettingsUI();
        populateFilterDropdowns();
        var fp = document.getElementById('filterParent');
        if (fp && fp.value === oldName) fp.value = newName;
        if (typeof renderScheduledTable === 'function') renderScheduledTable();
        if (typeof renderPendingTable === 'function') renderPendingTable(appData.pending);
        renderReportTable();
        closeRenameModal();
        showToast('Renamed!');
        if (useSupabase()) {
            renameParentCategoryToSupabase(oldName, newName).catch(function(e) { showToast(e && e.message ? e.message : 'Failed', 'error'); });
        } else {
            try { google.script.run.renameParentCategory(oldName, newName); } catch (e) { console.error(e); }
        }
    } else {
        var parent = renameModalTarget.parent;
        var oldSub = renameModalTarget.oldSub;
        if (newName === oldSub) { closeRenameModal(); return; }
        var subs = appData.categories[parent];
        if (!subs || subs.indexOf(newName) !== -1) {
            if (errEl) { errEl.textContent = subs && subs.indexOf(newName) !== -1 ? 'Sub-category already exists under this parent.' : 'Invalid name.'; errEl.classList.remove('hidden'); }
            return;
        }
        var idx = subs.indexOf(oldSub);
        if (idx === -1) { closeRenameModal(); return; }
        subs[idx] = newName;
        var s = appData.schema;
        appData.expenses.forEach(function(r) {
            if (r[s.parent] === parent && r[s.sub] === oldSub) r[s.sub] = newName;
        });
        if (appData.scheduled) {
            appData.scheduled.forEach(function(r) {
                if (r[6] === parent && r[5] === oldSub) r[5] = newName;
            });
        }
        if (appData.pending) {
            appData.pending.forEach(function(item) {
                if (item.incomeCategory === parent && item.incomeSubCategory === oldSub) item.incomeSubCategory = newName;
                if (item.transferCategory === parent && item.transferSubCategory === oldSub) item.transferSubCategory = newName;
            });
        }
        renderSettingsUI();
        populateFilterDropdowns();
        refreshAllDatalists();
        if (typeof buildSearchIndex === 'function') buildSearchIndex();
        var fs = document.getElementById('filterSub');
        if (fs && fs.value === oldSub) fs.value = newName;
        if (typeof renderScheduledTable === 'function') renderScheduledTable();
        if (typeof renderPendingTable === 'function') renderPendingTable(appData.pending);
        renderReportTable();
        closeRenameModal();
        showToast('Sub-category renamed. Expenses updated.');
        if (useSupabase()) {
            renameSubCategoryToSupabase(parent, oldSub, newName).catch(function(e) { showToast(e && e.message ? e.message : 'Sync failed', 'error'); });
        } else {
            try { google.script.run.renameSubCategory(parent, oldSub, newName); } catch (e) { console.error(e); }
        }
    }
}

function renameParentCat(oldName) {
    openRenameModal('parent', oldName);
}

function renameSubCat(parent, oldSub) {
    openRenameModal('sub', oldSub, parent);
}
function deleteParentCat(name){
    if(appData.categories[name]&&appData.categories[name].length>0){
        return showToast("Cannot delete: Has sub-categories",'error');
    }
    openConfirmModal("Delete Parent Category \""+name+"\"?", function() {
        delete appData.categories[name];
        renderSettingsUI();
        populateFilterDropdowns();
        if(useSupabase()){
            deleteParentCategoryToSupabase(name).then(function(){showToast("Deleted");}).catch(function(e){showToast(e&&e.message?e.message:'Failed','error');});
        }else{try{google.script.run.deleteParentCategory(name);showToast("Deleted");}catch(e){console.error(e);}}
    });
}
function toggleFlag(n,t,v,btn){
    var orig=btn.innerHTML;
    btn.innerHTML='<svg class="animate-spin h-4 w-4" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle></svg>';
    btn.disabled=true;
    function done(){var idx=appData.sources.findIndex(function(r){return r[0]===n;});if(idx>-1){if(t==='fav')appData.sources[idx][6]=v;if(t==='def'){appData.sources.forEach(function(r){r[7]=false;});appData.sources[idx][7]=v;}}renderSettingsUI();calculateLiveBalances();showToast("Default Source Updated!");btn.innerHTML=orig;btn.disabled=false;}
    function fail(e){showToast(e&&e.message?e.message:'Error','error');btn.innerHTML=orig;btn.disabled=false;}
    if(useSupabase()){
        updateSourceFlagsToSupabase(n,t,v).then(done).catch(fail);
    }else{
        google.script.run.withSuccessHandler(done).withFailureHandler(fail).updateSourceFlags(n,t,v);
    }
}
function updateSourceOpeningByIndex(i, val) {
    var r = appData.sources && appData.sources[i];
    if (!r) return;
    var num = (val !== '' && val !== undefined) ? Number(val) : 0;
    if (isNaN(num)) num = 0;
    if (Array.isArray(r)) r[2] = num;
    else return;
    var name = r[0];
    if (useSupabase()) updateSourceOpeningToSupabase(name, num).catch(function(e) { showToast(e && e.message ? e.message : 'Failed to update opening', 'error'); });
    calculateLiveBalances();
}

function addSource() {
    var v = document.getElementById('newSourceInp').value;
    var t = document.getElementById('newSourceType').value;
    var openEl = document.getElementById('newSourceOpening');
    var openingVal = (openEl && openEl.value !== '') ? Number(openEl.value) : 0;
    if (isNaN(openingVal)) openingVal = 0;
    if (!v) return;
    if (/[|:]/.test(v)) { showToast("Source name cannot contain ':' or '|'", 'error'); return; }
    appData.sources.push([v, t, openingVal, '', '', '', false, false]);
    document.getElementById('newSourceInp').value = '';
    if (openEl) openEl.value = '';
    renderSettingsUI();
    refreshTransferDropdowns();
    if (useSupabase()) {
        addSourceToSupabase(v, t, openingVal).catch(function(e) { appData.sources = appData.sources.filter(function(x) { return (Array.isArray(x) ? x[0] : x) !== v; }); renderSettingsUI(); refreshTransferDropdowns(); showToast(e && e.message ? e.message : 'Failed', 'error'); });
    } else {
        google.script.run.manageSettings('addSource', { name: v, type: t });
    }
}
function addParent(){
    var v=document.getElementById('newParentInp').value;
    if(!v)return;
    document.getElementById('newParentInp').value='';
    if(useSupabase()){
        addCategoryParentToSupabase(v).then(function(){
            appData.categories[v]=[v];
            populateFilterDropdowns();
            renderSettingsUI();
        }).catch(function(e){showToast(e&&e.message?e.message:'Failed','error');});
    }else{
        appData.categories[v]=[];
        google.script.run.manageSettings('addParent',{name:v});
        populateFilterDropdowns();
        renderSettingsUI();
    }
}
function addSub(){
    var p=document.getElementById('selParentForSub').value,v=document.getElementById('newSubInp').value;
    if(!v||!p)return;
    appData.categories[p].push(v);
    document.getElementById('newSubInp').value='';
    renderSettingsUI();
    refreshAllDatalists();
    populateFilterDropdowns();
    if(useSupabase()){
        addCategorySubToSupabase(p,v).catch(function(e){appData.categories[p]=appData.categories[p].filter(function(x){return x!==v;});renderSettingsUI();refreshAllDatalists();populateFilterDropdowns();showToast(e&&e.message?e.message:'Failed','error');});
    }else{
        google.script.run.manageSettings('addSub',{parent:p,sub:v});
    }
}
function delSet(t, n, p) {
    if (t === 'source') {
        var s = appData.schema;
        var isUsed = appData.expenses.some(function(r) { var srcStr = String(r[s.source] || ""); return srcStr === n || srcStr.indexOf(': '+n) !== -1 || srcStr.indexOf(n+':') !== -1; });
        if (isUsed) { showToast('Cannot delete "'+n+'": It is used in transactions. Rename it instead.', 'error'); return; }
    }
    var msg = t === 'source' ? ('Delete Source "'+n+'"?') : ('Delete Sub-Category "'+n+'"?');
    openConfirmModal(msg, function() {
        if (t === 'source') {
            appData.sources = appData.sources.filter(function(x) { return (Array.isArray(x) ? x[0] : x) !== n; });
            if(useSupabase()) deleteSourceToSupabase(n).catch(function(e){showToast(e&&e.message?e.message:'Failed','error');});
            else google.script.run.manageSettings('deleteSource', { name: n });
        } else {
            appData.categories[p] = appData.categories[p].filter(function(x) { return x !== n; });
            if(useSupabase()) deleteCategorySubToSupabase(p,n).catch(function(e){showToast(e&&e.message?e.message:'Failed','error');});
            else google.script.run.manageSettings('deleteSub', { parent: p, sub: n });
        }
        renderSettingsUI();
        refreshAllDatalists();
        populateFilterDropdowns();
    });
}
function reclass(s,p){reclassifyTarget={sub:s,oldParent:p};document.getElementById('modalSubName').innerText=s;document.getElementById('reclassifyModal').classList.remove('hidden');}
function closeReclassifyModal(){document.getElementById('reclassifyModal').classList.add('hidden');}
function confirmReclassify(){
    var np=document.getElementById('modalNewParent').value;
    if(!np)return showToast("Select parent",'error');
    var sub=reclassifyTarget.sub, oldParent=reclassifyTarget.oldParent;
    appData.categories[oldParent]=appData.categories[oldParent].filter(function(x){return x!==sub;});
    if(!appData.categories[np])appData.categories[np]=[];
    appData.categories[np].push(sub);
    var s=appData.schema;
    appData.expenses.forEach(function(r){if(r[s.sub]===sub)r[s.parent]=np;});
    closeReclassifyModal();
    renderSettingsUI();
    populateFilterDropdowns();
    refreshAllDatalists();
    showToast('Moved '+sub+' to '+np);
    if(useSupabase()){
        reclassifySubCategoryToSupabase(sub,oldParent,np).catch(function(e){showToast(e&&e.message?e.message:'Failed','error');});
    }else{
        google.script.run.reclassifySubCategory(sub,oldParent,np);
    }
}
function setEntryMode(m){if(m==='single'){document.getElementById('container-single').classList.remove('hidden');document.getElementById('container-bulk').classList.add('hidden');document.getElementById('mode-single').classList.add('bg-white','dark:bg-gray-600','shadow','text-gray-800','dark:text-white');document.getElementById('mode-bulk').classList.remove('bg-white','dark:bg-gray-600','shadow','text-gray-800','dark:text-white');}else{document.getElementById('container-single').classList.add('hidden');document.getElementById('container-bulk').classList.remove('hidden');document.getElementById('mode-bulk').classList.add('bg-white','dark:bg-gray-600','shadow','text-gray-800','dark:text-white');document.getElementById('mode-single').classList.remove('bg-white','dark:bg-gray-600','shadow','text-gray-800','dark:text-white');}}
function handleSubCategoryInput(el, targetId = 'inpParent') {
    const val = el.value;
    const parentField = document.getElementById(targetId); // Uses custom target if provided
    
    if (!val || !parentField) return;

    // Search for the parent category in your data
    let foundParent = "";
    
    // Iterate over appData.categories object
    for (const [p, subs] of Object.entries(appData.categories)) {
        if (Array.isArray(subs) && subs.includes(val)) {
            foundParent = p;
            break;
        }
    }

    // Update the correct field
    if (foundParent) {
        parentField.value = foundParent;
    } else {
        parentField.value = ""; // Clear if not found (optional)
    }
}
function handleModeChange(){const mode = document.getElementById('inpMode').value;refreshTransferDropdowns();let targetSource = "";if(appData.sources){if(mode === 'Cash'){const cashAcct = appData.sources.find(s => (Array.isArray(s) ? s[1] : 'Bank') === 'Cash');if(cashAcct) targetSource = Array.isArray(cashAcct) ? cashAcct[0] : cashAcct;} else {const defAcct = appData.sources.find(s => Array.isArray(s) && s[7] === true);if(defAcct) targetSource = defAcct[0];}}document.querySelectorAll('.split-row').forEach(row => {const sel = row.querySelector('.split-source');const val = sel.value;sel.innerHTML = `<option value="" disabled>Source</option>`;if(appData.sources){appData.sources.forEach(s => {const n = Array.isArray(s) ? s[0] : s;const type = Array.isArray(s) ? (s[1]||'Bank') : 'Bank';if(mode === 'Cash'){if(type === 'Cash') sel.innerHTML += `<option value="${n}">${n}</option>`;} else {if(type !== 'Cash') sel.innerHTML += `<option value="${n}">${n}</option>`;}});}if(val && Array.from(sel.options).some(o=>o.value===val)) sel.value = val;else if(targetSource) sel.value = targetSource;else sel.value = '';});}
function handleAmountInput() {const totalAmt = document.getElementById('inpAmount').value;const rows = document.querySelectorAll('.split-row');if(rows.length === 1) {const input = rows[0].querySelector('.split-amount');input.value = totalAmt;}validateSplits();}
function toggleTransferMode(keep=false){const t=document.getElementById('inpType').value;if(!keep){document.getElementById('inpSub').value='';document.getElementById('inpParent').value='';}refreshAllDatalists();const isE=t==='Expense',isI=t==='Income',isT=t==='Transfer';document.getElementById('wrapSub').classList.toggle('hidden',false);document.getElementById('wrapParent').classList.toggle('hidden',false);document.getElementById('wrapMode').classList.toggle('hidden',!isE);document.getElementById('wrapSource').classList.toggle('hidden',!(isI||isT));document.getElementById('lblSource').innerText=isI?"Deposit To Account":"From Account";document.getElementById('divExpenseSplits').classList.toggle('hidden',!isE);document.getElementById('divTransferDestinations').classList.toggle('hidden',!isT);if(isE&&document.getElementById('splitContainer').children.length===0)addSplitRow();if(isT&&document.getElementById('transferContainer').children.length===0)addTransferRow();handleModeChange();}
function addSplitRow(s="",a=""){const mode = document.getElementById('inpMode').value;const d=document.createElement('div');d.className="flex gap-2 split-row items-center w-full";let opts=`<option value="" disabled ${!s?'selected':''}>Source</option>`;if(appData.sources){appData.sources.forEach(r=>{const n=Array.isArray(r)?r[0]:r;const type=Array.isArray(r)?(r[1]||'Bank'):'Bank';if(mode==='Cash'){if(type==='Cash') opts+=`<option value="${n}" ${n===s?'selected':''}>${n}</option>`;} else {if(type!=='Cash') opts+=`<option value="${n}" ${n===s?'selected':''}>${n}</option>`;}});}d.innerHTML=`<select class="split-source flex-grow py-1.5 px-2 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white font-medium outline-none">${opts}</select><input type="number" class="split-amount w-24 py-1.5 px-2 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white font-mono outline-none font-bold" placeholder="0.00" value="${a}" oninput="validateSplits()"><button type="button" onclick="this.parentElement.remove(); validateSplits()" class="text-red-400 hover:text-red-600 p-1 hover:bg-red-50 dark:hover:bg-red-900/30 rounded"><i data-feather="x" class="w-4 h-4"></i></button>`;document.getElementById('splitContainer').appendChild(d);safeFeatherReplace();validateSplits();}
function validateSplits(){const t=toPaise(document.getElementById('inpAmount').value)||0;let c=0;document.querySelectorAll('.split-row').forEach(r=>c+=toPaise(r.querySelector('.split-amount').value)||0);document.getElementById('splitTotal').innerText="Total: "+fromPaise(c);const match=Math.abs(t-c)<1;document.getElementById('splitError').classList.toggle('hidden',match);return match&&t>0;}
function addTransferRow(d="",a=""){const div=document.createElement('div');div.className="flex gap-2 trans-row items-center w-full";let opts='<option value="" disabled selected>Destination</option>';(appData.sources||[]).forEach(s=>{let n=Array.isArray(s)?s[0]:s;opts+=`<option value="${n}" ${n===d?'selected':''}>${n}</option>`;});div.innerHTML=`<select class="trans-dest flex-grow py-1.5 px-2 text-xs border border-green-300 dark:border-green-700 rounded bg-white dark:bg-gray-700 dark:text-white font-medium outline-none">${opts}</select><input type="number" class="trans-amount w-20 py-1.5 px-2 text-xs border border-green-300 dark:border-green-700 rounded bg-white dark:bg-gray-700 dark:text-white font-mono outline-none font-bold" placeholder="Amt" value="${a}" oninput="validateTransferSplits()"><button type="button" onclick="this.parentElement.remove();validateTransferSplits()" class="text-red-400 hover:text-red-600 p-1"><i data-feather="x" class="w-4 h-4"></i></button>`;document.getElementById('transferContainer').appendChild(div);safeFeatherReplace();}
function validateTransferSplits(){const t=toPaise(document.getElementById('inpAmount').value)||0;let c=0;document.querySelectorAll('.trans-row').forEach(r=>c+=toPaise(r.querySelector('.trans-amount').value)||0);document.getElementById('transTotal').innerText="Total: "+fromPaise(c);const match=Math.abs(t-c)<1;document.getElementById('transError').classList.toggle('hidden',match);return match&&t>0;}
function validateTransaction(d) {
    if (!d.date) return { ok: false, msg: "Date is required" };
    if (Number(d.amount) <= 0) return { ok: false, msg: "Amount must be > 0" };
    if (d.type !== 'Transfer' && !d.subCategory) return { ok: false, msg: "Sub-Category required" };
    
    // STRICT CHECK: Source is now mandatory for ALL types (Income, Expense, Transfer)
    if (!d.source) return { ok: false, msg: "Source account required" };
    
    return { ok: true };
}
function handleFormSubmit(e) {
    e.preventDefault();
    const f = document.getElementById('txnForm');
    const type = document.getElementById('inpType').value;

    // 1. SPECIFIC CHECKS FOR EXPENSES
    if (type === 'Expense') {
        // A. Check Amounts
        if (!validateSplits()) { 
            showToast("Split Amount Mismatch!", 'error'); 
            return; 
        }
        
        // B. Check Sources (The Fix You Requested)
        let missingSrc = false;
        document.querySelectorAll('.split-row').forEach(r => {
            if (!r.querySelector('.split-source').value) missingSrc = true;
        });
        if (missingSrc) return showToast("Please select a Source for each split row", 'error');
    }

    // 2. SPECIFIC CHECKS FOR TRANSFERS
    if (type === 'Transfer' && !validateTransferSplits()) { 
        showToast("Transfer Amount Mismatch!", 'error'); 
        return; 
    }

    // 3. PREPARE DATA FOR VALIDATION
    // For Expenses, we pass 'Mixed' as the source to satisfy the strict validator,
    // because we have already validated the individual split sources above.
    let formData = {
        date: f.date.value,
        amount: f.amount.value,
        type: type,
        subCategory: f.subCategory.value,
        source: type === 'Expense' ? 'Mixed' : document.getElementById('inpTransferSource').value
    };

    // 4. RUN STRICT VALIDATION
    let val = validateTransaction(formData);
    if (!val.ok) return showToast(val.msg, 'error');

    // 5. DUPLICATE CHECK
    if (!f.transactionId.value && checkDuplicate(f.date.value, f.amount.value, f.subCategory.value)) {
        if (!confirm("Duplicate transaction detected. Save anyway?")) return;
    }

    // 6. SAVE LOGIC
    const btn = document.getElementById('btnSubmit');
    btn.innerHTML = 'Saving...';
    btn.disabled = true;

    let d = {
        transactionId: f.transactionId.value,
        date: f.date.value,
        type: type,
        amount: f.amount.value,
        remarks: f.remarks.value
    };

    if (type === 'Transfer') {
        d.subCategory = f.subCategory.value || 'Self-Transfer';
        d.parentCategory = f.parentCategory.value || 'Transfer';
        d.mode = 'Cashless';
        d.source = document.getElementById('inpTransferSource').value;
        d.splits = [];
        const dests = [];
        document.querySelectorAll('.trans-row').forEach(r => {
            dests.push(`To: ${r.querySelector('.trans-dest').value}: ${r.querySelector('.trans-amount').value}`)
        });
        d.remarks = dests.join(' | ') + (d.remarks ? ` (${d.remarks})` : '');
    } else if (type === 'Income') {
        d.subCategory = f.subCategory.value;
        d.parentCategory = f.parentCategory.value;
        d.mode = 'Cashless';
        d.source = document.getElementById('inpTransferSource').value;
        d.splits = [];
    } else {
        d.subCategory = f.subCategory.value;
        d.parentCategory = f.parentCategory.value;
        d.mode = f.mode.value;
        d.splits = [];
        document.querySelectorAll('.split-row').forEach(r => {
            d.splits.push({
                source: r.querySelector('.split-source').value,
                amount: r.querySelector('.split-amount').value
            })
        });
        // Fallback for single row
        if (d.splits.length === 0) d.splits.push({
            source: appData.sources[0][0],
            amount: f.amount.value
        });
    }

    function onSaveDone(r) {
        var res = typeof r === 'string' ? JSON.parse(r) : r;
        if (res.success) {
            const s = appData.schema;
            if (d.transactionId) appData.expenses = appData.expenses.filter(x => x[s.id] !== d.transactionId);
            let srcStr = (type === 'Transfer' || type === 'Income') ? d.source : (d.splits && d.splits.length ? d.splits.map(x => x.source + ': ' + x.amount).join(' | ') : '');
            const newRow = [res.savedId, d.date, d.type, d.subCategory, d.parentCategory, d.amount, d.mode, srcStr, d.remarks];
            const parts = d.date.split('-');
            const dt = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
            newRow._day = dt.getDay();
            appData.expenses.push(newRow);
            appData.expenses.sort((a, b) => (a[s.date] < b[s.date] ? 1 : -1));
            sessionRecent.unshift({ date: d.date, sub: d.subCategory, parent: d.parentCategory, amount: d.amount });
            buildSearchIndex();
            resetForm();
            renderRecentList();
            calculateLiveBalances();
            renderReportTable();
            showToast("Saved!");
        } else {
            showToast(res.message || 'Save failed', 'error');
        }
        btn.innerHTML = '<span>Save</span><i data-feather="arrow-right-circle" class="w-4 h-4"></i>';
        btn.disabled = false;
        if (typeof feather !== 'undefined') feather.replace();
    }
    if (useSupabase()) {
        saveTransactionToSupabase(d).then(onSaveDone).catch(function(err) {
            showToast(err && err.message ? err.message : 'Save failed', 'error');
            btn.innerHTML = '<span>Save</span><i data-feather="arrow-right-circle" class="w-4 h-4"></i>';
            btn.disabled = false;
            if (typeof feather !== 'undefined') feather.replace();
        });
    } else {
        google.script.run.withSuccessHandler(onSaveDone).withFailureHandler(function(e) { onSaveDone({ success: false, message: e.message }); }).saveTransaction(d);
    }
}
function checkDuplicate(d,a,s){const sc=appData.schema;return appData.expenses.some(r=>String(r[sc.date]).split('T')[0]===d&&Number(r[sc.amt])===Number(a)&&r[sc.sub]===s);}
function resetForm(){document.getElementById('txnForm').reset();document.getElementById('inpId').value="";const now = new Date(); const todayStr = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().split('T')[0];document.getElementById('inpDate').value=todayStr;document.getElementById('splitContainer').innerHTML='';document.getElementById('transferContainer').innerHTML='';document.getElementById('inpType').value='Expense';toggleTransferMode();}
function renderRecentList(){const t=document.getElementById('recentListBody');t.innerHTML='';const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];sessionRecent.slice(0,5).forEach(r=>{let dDisp=r.date;try{const [y,m,d]=r.date.split('-');dDisp=`${d} ${months[parseInt(m)-1]}`;}catch(e){}t.innerHTML+=`<tr class="hover:bg-blue-50/50 dark:hover:bg-blue-900/20 transition-colors"><td class="p-3 text-gray-700 dark:text-gray-300">${dDisp}</td><td class="p-3 font-semibold">${r.sub}</td><td class="p-3 text-gray-500 text-xs uppercase">${r.parent}</td><td class="p-3 text-right font-mono font-bold">${r.amount}</td></tr>`;});}
function editTxn(id){const s=appData.schema,r=appData.expenses.find(x=>x[s.id]===id);if(!r)return;switchTab('entry');setEntryMode('single');document.getElementById('inpId').value=r[s.id];try{document.getElementById('inpDate').value=new Date(r[s.date]).toISOString().split('T')[0]}catch(e){}document.getElementById('inpAmount').value=r[s.amt];document.getElementById('inpRemarks').value=r[s.remarks];document.getElementById('inpType').value=r[s.type];toggleTransferMode(true);document.getElementById('inpSub').value=r[s.sub];document.getElementById('inpParent').value=r[s.parent];document.getElementById('inpMode').value=r[s.mode];handleModeChange();const src=String(r[s.source]||"");if(r[s.type]==='Expense'){document.getElementById('splitContainer').innerHTML='';if(src.includes(':')&&!src.startsWith('To:')){src.split('|').forEach(p=>{const[n,a]=p.split(':');addSplitRow(n.trim(),a.trim())});}else addSplitRow(src,r[s.amt]);}else{document.getElementById('inpTransferSource').value=src;}document.getElementById('btnSubmit').innerHTML=`<span>Update</span><i data-feather="refresh-cw" class="w-4 h-4"></i>`;}
function deleteTxn(id){
    openConfirmModal("Permanently delete this transaction? This can be undone briefly.", function() {
        const s = appData.schema;
        const idx = appData.expenses.findIndex(x => x[s.id] === id);
        if(idx > -1){
            lastDeletedTxn = appData.expenses[idx];
            appData.expenses.splice(idx, 1);
            calculateLiveBalances();
            renderRecentList();
            buildSearchIndex();
            renderReportTable();
            showToast("Transaction Deleted!", 'undo');
            if (useSupabase()) {
                deleteTransactionToSupabase(id).catch(function(e) { showToast(e && e.message ? e.message : 'Delete failed', 'error'); });
            } else {
                google.script.run.deleteTransaction(id);
            }
        }
    });
}
function handleUndo(el){
    if (!lastDeletedTxn) return;
    if (useSupabase()) {
        restoreTransactionToSupabase(lastDeletedTxn).then(function() {
            appData.expenses.push(lastDeletedTxn);
            appData.expenses.sort((a,b)=>(a[appData.schema.date]<b[appData.schema.date]?1:-1));
            renderReportTable();
            if (el && el.remove) el.remove();
            lastDeletedTxn = null;
        }).catch(function(e) { showToast(e && e.message ? e.message : 'Restore failed', 'error'); });
    } else {
        appData.expenses.push(lastDeletedTxn);
        appData.expenses.sort((a,b)=>(a[appData.schema.date]<b[appData.schema.date]?1:-1));
        renderReportTable();
        google.script.run.restoreTransaction(lastDeletedTxn);
        if (el && el.remove) el.remove();
        lastDeletedTxn = null;
    }
}
function editSch(id){const r=appData.scheduled.find(x=>x[0]===id);if(!r)return;document.getElementById('schId').value=r[0];document.getElementById('schFreq').value=r[1];document.getElementById('schStartDate').value=r[2];document.getElementById('schEndDate').value=r[3];document.getElementById('schType').value=r[4];document.getElementById('schSub').value=r[5];document.getElementById('schParent').value=r[6];document.getElementById('schAmount').value=r[7];document.getElementById('schMode').value=r[8];document.getElementById('schSource').value=r[9];document.getElementById('schRemarks').value=r[10];document.getElementById('schFormTitle').innerText="Edit Schedule";const btn=document.getElementById('btnSchSubmit');btn.innerHTML='Update Schedule';btn.classList.remove('bg-blue-600');btn.classList.add('bg-green-600','hover:bg-green-700');}
function resetScheduleForm(){document.getElementById('scheduleForm').reset();document.getElementById('schId').value='';const today=new Date().toISOString().split('T')[0];document.getElementById('schStartDate').value=today;document.getElementById('schFreq').value='Monthly';document.getElementById('schType').value='Expense';document.getElementById('schFormTitle').innerText="Create Schedule";const btn=document.getElementById('btnSchSubmit');btn.innerHTML='Set Schedule';btn.classList.remove('bg-green-600','hover:bg-green-700');btn.classList.add('bg-blue-600');}
function handleScheduleSubmit(e){
    e.preventDefault();
    var f=document.getElementById('scheduleForm'), p={scheduleId:f.scheduleId.value,frequency:f.frequency.value,startDate:f.startDate.value,endDate:f.endDate.value,type:f.type.value,subCategory:f.subCategory.value,parentCategory:f.parentCategory.value,amount:f.amount.value,mode:f.mode.value,source:f.source.value,remarks:f.remarks.value};
    var btn=document.getElementById('btnSchSubmit');
    btn.innerText="Saving...";
    btn.disabled=true;
    function done(){ showToast(p.scheduleId?"Schedule Updated!":"Schedule Created!"); resetScheduleForm(); btn.disabled=false; if(useSupabase()) fetchInitialDataFromSupabase().then(function(data){onDataLoad(JSON.stringify(data));}); else google.script.run.withSuccessHandler(onDataLoad).getInitialData(); }
    function fail(err){ showToast(err&&err.message?err.message:'Failed','error'); btn.disabled=false; }
    if(useSupabase()){ saveScheduleToSupabase(p).then(done).catch(fail); }
    else{ google.script.run.withSuccessHandler(done).saveSchedule(p); }
}

// --- NEW SHARED STATS FUNCTION ---
function updateScheduleStats(refDate) {
    const stats = document.getElementById('schStatsBar');
    if (!stats) return;

    // 1. Setup Dates based on the requested date (refDate)
    const year = refDate.getFullYear();
    const month = refDate.getMonth();
    const startOfM = new Date(year, month, 1);
    const endOfM = new Date(year, month + 1, 0);
    const monthName = refDate.toLocaleDateString('en-US', { month: 'short' });
    
    // 2. Filter Logs for this specific month
    const s = appData.schema;
    const monthLogs = appData.expenses.filter(r => {
        const d = new Date(r[s.date]);
        return d >= startOfM && d <= endOfM;
    });

    // 3. Variables
    let totalMonthlyAmt = 0;
    let pendingMonthlyAmt = 0;
    let countTotal = 0;
    let countProcessed = 0;

    // 4. Iterate Active Schedules
    appData.scheduled.forEach(r => {
        const freq = r[1];
        const sub = r[5];
        const amt = Number(r[7]) || 0;
        const nextDueStr = r[2];
        const sunsetStr = r[3];

        // Skip if expired before this month starts
        if (sunsetStr) {
            const sunDate = new Date(sunsetStr);
            if (sunDate < startOfM) return;
        }

        if (['Monthly', 'Weekly', 'Daily'].includes(freq)) {
             countTotal++;
             
             // Normalize Burden
             if (freq === 'Monthly') totalMonthlyAmt += amt;
             else if (freq === 'Weekly') totalMonthlyAmt += (amt * 4);
             else if (freq === 'Daily') totalMonthlyAmt += (amt * 30);

             let isDone = false;

             if (freq === 'Monthly') {
                 // STRICT MODE: Check for actual log in this specific month
                 const match = monthLogs.find(log => 
                    log[s.sub] === sub && 
                    Math.abs(Number(log[s.amt]) - amt) < 1 
                 );
                 isDone = !!match;
             } else {
                 // FALLBACK (Weekly/Daily): Check Next Due Date vs Month End
                 const nextDueDate = new Date(nextDueStr);
                 nextDueDate.setHours(0,0,0,0);
                 // If the system says the next payment is AFTER this month, 
                 // we assume this month's obligations are met.
                 if (nextDueDate > endOfM) isDone = true;
             }

             if (isDone) {
                 countProcessed++;
             } else {
                 pendingMonthlyAmt += amt;
             }
        }
    });

    // 5. Render Stats
    // Note: I updated the Title to include the Month Name (e.g., "Status (Feb)")
    stats.innerHTML = 
        renderStatCard(`Status (${monthName})`, `${countProcessed} / ${countTotal} Done`, "blue") + 
        renderStatCard("Remaining Due", pendingMonthlyAmt, "red") + 
        renderStatCard("Total Commitment", totalMonthlyAmt, "gray");
}

function renderScheduledTable() {
    const tb = document.getElementById('scheduledTableBody');
    tb.innerHTML = '';
    
    // 1. SETUP DATA FOR "DONE" BADGES (Current Month Only)
    const today = new Date();
    const currentMonthIdx = today.getMonth(); 
    const currentYear = today.getFullYear();
    
    // Define window for checking logs (Start to End of THIS month)
    const startOfMonth = new Date(currentYear, currentMonthIdx, 1);
    const endOfMonth = new Date(currentYear, currentMonthIdx + 1, 0);
    
    const s = appData.schema;
    // Get actual transaction logs for this month to verify payments
    const monthLogs = appData.expenses.filter(r => {
        const d = new Date(r[s.date]);
        return d >= startOfMonth && d <= endOfMonth;
    });

    // 2. ITERATE AND RENDER ROWS
    appData.scheduled.forEach(r => {
        // r indices: [0]=ID, [1]=Freq, [2]=NextDue, [3]=Sunset, [5]=SubCat, [7]=Amount
        const id = r[0];
        const freq = r[1];
        const nextDueStr = r[2];
        const sunsetStr = r[3];
        const subCat = r[5];
        const parentCat = r[6]; // Assuming parent is at 6 based on your previous code
        const amt = Number(r[7]) || 0;
        
        // Skip Inactive/Expired
        if (sunsetStr) {
            const sunDate = new Date(sunsetStr);
            if (sunDate < today) return; 
        }

        // --- SMART MATCH LOGIC (For Badge) ---
        let isDone = false;
        let doneDate = "";

        if (['Monthly', 'Weekly', 'Daily'].includes(freq)) {
            if (freq === 'Monthly') {
                // STRICT MATCH: Look for log in this month
                const match = monthLogs.find(log => 
                    log[s.sub] === subCat && 
                    Math.abs(Number(log[s.amt]) - amt) < 1 
                );
                
                if (match) {
                    isDone = true;
                    doneDate = match[s.date];
                }
            } else {
                // FALLBACK (Weekly/Daily): Use Date Logic
                const nextDueDate = new Date(nextDueStr);
                nextDueDate.setHours(0,0,0,0);
                if (nextDueDate > endOfMonth) isDone = true;
            }
        }

        // --- BUILD HTML ---
        let dEnd = r[3] ? r[3] : 'Forever';
        
        // Date Styling (Orange if due soon and NOT done)
        const dNext = new Date(r[2]);
        const isSoon = dNext <= new Date(today.getTime() + 7*86400000);
        const dateColor = (isSoon && !isDone) ? "text-orange-600 font-bold" : "text-blue-600 font-medium";

        // Frequency Badge with "DONE" Status
        let freqHtml = `<span class="font-bold text-gray-700 dark:text-gray-300">${freq}</span>`;
        if (isDone) {
            freqHtml += ` <span class="ml-1 inline-flex items-center px-1.5 py-0.5 rounded text-[9px] font-bold bg-green-100 text-green-800 border border-green-200 dark:bg-green-900/30 dark:text-green-300 dark:border-green-800" title="Verified in log: ${doneDate}">DONE</span>`;
        }

        // Row Highlight (Subtle green tint if done)
        const rowBg = isDone ? 'bg-gray-50/50 dark:bg-gray-800/30' : '';

        tb.innerHTML += `
        <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition ${rowBg}">
            <td class="p-3 whitespace-nowrap">${freqHtml}</td>
            <td class="p-3 ${dateColor}">${nextDueStr}</td>
            <td class="p-3 text-xs">
                <div class="font-bold text-gray-800 dark:text-gray-200">${subCat}</div>
                <div class="text-gray-500">${parentCat}</div>
            </td>
            <td class="p-3 font-mono font-bold">₹${amt.toLocaleString('en-IN')}</td>
            <td class="p-3 text-xs text-gray-500">${dEnd}</td>
            <td class="p-3 flex gap-2 justify-center">
                <button onclick="editSch('${id}')" class="text-blue-500 hover:text-blue-700 p-1 bg-blue-50 dark:bg-blue-900/30 rounded"><i data-feather="edit-2" class="w-4 h-4"></i></button>
                <button onclick="delSch('${id}')" class="text-red-400 hover:text-red-600 p-1 bg-red-50 dark:bg-red-900/30 rounded"><i data-feather="trash-2" class="w-4 h-4"></i></button>
            </td>
        </tr>`;
    });

    safeFeatherReplace();

    // 3. UPDATE STATS BAR (Default to Current Month for List View)
    updateScheduleStats(new Date());
}

function delSch(id){
    openConfirmModal("Stop and delete this recurring schedule?", function() {
        appData.scheduled=appData.scheduled.filter(function(r){return r[0]!==id;});
        renderScheduledTable();
        if(useSupabase()) deleteScheduleToSupabase(id).catch(function(e){showToast(e&&e.message?e.message:'Failed','error');});
        else google.script.run.withSuccessHandler(function(){}).deleteSchedule(id);
    });
}
function renderBudgetView(){const c=document.getElementById('budgetContainer'),s=document.getElementById('budgetCat');c.innerHTML='';s.innerHTML='<option value="">Select Category</option>';Object.keys(appData.categories).forEach(k=>s.innerHTML+=`<option value="${k}">${k}</option>`);const mon=new Date().toISOString().slice(0,7);const sp={};appData.expenses.forEach(r=>{if(r[appData.schema.type]==='Expense'&&String(r[appData.schema.date]).startsWith(mon)){const p=r[appData.schema.parent];sp[p]=(sp[p]||0)+toPaise(r[appData.schema.amt]);}});Object.entries(appData.budgets).forEach(([k,l])=>{let catName=k;let limit=l;if(k.includes('#')){const parts=k.split('#');if(parts[1]!==mon)return;catName=parts[0];}const lP=toPaise(limit);const u=sp[catName]||0,p=Math.min((u/lP)*100,100),clr=p>90?'red':p>70?'yellow':'green';c.innerHTML+=`<div class="bg-white dark:bg-gray-800 p-4 rounded border border-gray-200 dark:border-gray-700 relative group"><button onclick="delBud('${k}')" class="absolute top-2 right-2 text-red-400 opacity-0 group-hover:opacity-100"><i data-feather="trash-2" class="w-4 h-4"></i></button><div class="flex justify-between items-end mb-2"><div><h4 class="font-bold">${catName}</h4><p class="text-xs text-gray-500">Limit: ₹${limit}</p></div><div class="text-right"><span class="font-bold text-${clr}-600">₹${fromPaise(u)}</span></div></div><div class="w-full bg-gray-200 h-2 rounded"><div class="bg-${clr}-500 h-2 rounded" style="width:${p}%"></div></div></div>`;});safeFeatherReplace();}
function handleSaveBudget(e){
    e.preventDefault();
    var c=document.getElementById('budgetCat').value,l=document.getElementById('budgetLimit').value;
    if(!c)return;
    var mon=new Date().toISOString().slice(0,7), key=c+'#'+mon;
    appData.budgets[key]=Number(l);
    document.getElementById('budgetLimit').value='';
    renderBudgetView();
    if(useSupabase()) saveBudgetToSupabase(key,l).catch(function(err){delete appData.budgets[key];renderBudgetView();showToast(err&&err.message?err.message:'Failed','error');});
    else google.script.run.saveBudget(key,l);
}
function delBud(c){
    openConfirmModal("Remove budget limit for "+c+"?", function() {
        delete appData.budgets[c];
        renderBudgetView();
        if(useSupabase()) deleteBudgetToSupabase(c).catch(function(e){showToast(e&&e.message?e.message:'Failed','error');});
        else google.script.run.deleteBudget(c);
    });
}
function resetBulkForm() {
    // 1. Reset Date to Today
    document.getElementById('bulkDate').value = new Date().toISOString().split('T')[0];
    
    // 2. Clear Dropdowns
    document.getElementById('bulkParent').value = "";
    document.getElementById('bulkGlobalSource').value = ""; // <--- Added this line
    
    // 3. Reset Table State
    document.getElementById('bulkRowsBody').innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-400 italic">Select Parent first.</td></tr>';
}
function renderBulkRows() {
    const p = document.getElementById('bulkParent').value;
    const tb = document.getElementById('bulkRowsBody');
    tb.innerHTML = '';

    if (!p || !appData.categories[p]) {
        tb.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-400 italic">Select a Parent Category first.</td></tr>';
        return;
    }

    const subs = appData.categories[p];
    if (!subs || subs.length === 0) {
        tb.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-400">No sub-categories found.</td></tr>';
        return;
    }

    subs.forEach(s => {
        // Added list="remarksList" to the bulk-remarks input below
        tb.innerHTML += `
        <tr class="hover:bg-purple-50 dark:hover:bg-purple-900/10 transition-colors">
            <td class="p-3 font-semibold text-gray-700 dark:text-gray-300 border-b dark:border-gray-700"> 
                ${s} <input type="hidden" class="bulk-sub" value="${s}"> 
            </td>
            <td class="p-3 border-b dark:border-gray-700"> 
                <input type="number" class="bulk-amount w-full compact-input text-sm font-mono" placeholder="₹ 0.00"> 
            </td>
            <td class="p-3 border-b dark:border-gray-700"> 
                <input type="text" class="bulk-remarks w-full compact-input text-sm" placeholder="Item Details / Note" list="remarksList"> 
            </td>
            <td class="p-3 border-b dark:border-gray-700"> 
                <select class="bulk-source w-full compact-input text-xs"> 
                    <option value="">Use Global Source</option> 
                    ${(appData.sources || []).map(x => {
                        let n = Array.isArray(x) ? x[0] : x;
                        return `<option value="${n}">${n}</option>`;
                    }).join('')} 
                </select> 
            </td>
        </tr>`;
    });

    handleBulkModeChange();
}
function handleBulkModeChange(){const mode=document.getElementById('bulkMode').value;document.querySelectorAll('.bulk-source').forEach(sel=>{const val=sel.value;sel.innerHTML='<option value="">Use Global Source</option>';if(appData.sources){appData.sources.forEach(s=>{const n=Array.isArray(s)?s[0]:s;const type=Array.isArray(s)?(s[1]||'Bank'):'Bank';if(mode==='Cash'){if(type==='Cash')sel.innerHTML+=`<option value="${n}">${n}</option>`;}else{if(type!=='Cash')sel.innerHTML+=`<option value="${n}">${n}</option>`;}});if(val&&Array.from(sel.options).some(o=>o.value===val))sel.value=val;else sel.value='';}});}
function handleBulkSubmit(e) {
    e.preventDefault();
    const p = document.getElementById('bulkParent').value;
    const d = document.getElementById('bulkDate').value;
    const ents = [];
    let hasErrors = false;

    // Iterate rows
    document.querySelectorAll('#bulkRowsBody tr').forEach(tr => {
        const a = tr.querySelector('.bulk-amount').value;
        // Only process rows with an amount
        if (a) {
            const sub = tr.querySelector('.bulk-sub').value;
            const src = tr.querySelector('.bulk-source').value || document.getElementById('bulkGlobalSource').value;
            const rem = tr.querySelector('.bulk-remarks').value;

            // VALIDATION SYMMETRY: Reuse the core validator
            let val = validateTransaction({
                date: d,
                amount: a,
                type: 'Expense',
                subCategory: sub,
                source: src
            });

            if (!val.ok) {
                hasErrors = true;
                showToast(`Row "${sub}": ${val.msg}`, 'error');
                // Highlight the error row visually
                tr.classList.add('bg-red-50', 'dark:bg-red-900/20');
                setTimeout(() => tr.classList.remove('bg-red-50', 'dark:bg-red-900/20'), 3000);
                return;
            }

            ents.push({
                date: d,
                type: 'Expense',
                parentCategory: p,
                subCategory: sub,
                amount: a,
                source: src,
                mode: 'Cashless',
                remarks: rem
            });
        }
    });

    if (hasErrors || ents.length === 0) {
        if (ents.length === 0 && !hasErrors) showToast("No entries to save.", 'error');
        return;
    }

    var btn = document.getElementById('btnBulkSubmit');
    btn.innerText = "Saving...";
    btn.disabled = true;
    function done(){
        showToast("Bulk Saved!");
        resetBulkForm();
        btn.innerText = "Save Bulk";
        btn.disabled = false;
        if(useSupabase()) fetchInitialDataFromSupabase().then(function(data){ onDataLoad(JSON.stringify(data)); });
        else google.script.run.withSuccessHandler(onDataLoad).getInitialData();
    }
    function fail(err){ showToast(err&&err.message?err.message:'Failed','error'); btn.innerText = "Save Bulk"; btn.disabled = false; }
    if(useSupabase()){
        saveBatchTransactionsToSupabase(ents).then(function(r){
            if(r.savedIds&&r.savedIds.length){ var s=appData.schema; ents.forEach(function(e,i){ var id=r.savedIds[i]; if(id) appData.expenses.push([id,e.date,e.type,e.subCategory,e.parentCategory,e.amount,'Cashless',e.source,e.remarks]); }); appData.expenses.sort(function(a,b){ return a[s.date]<b[s.date]?1:-1; }); buildSearchIndex(); calculateLiveBalances(); renderReportTable(); }
            done();
        }).catch(fail);
    } else {
        google.script.run.withSuccessHandler(done).withFailureHandler(fail).saveBatchTransactions({ entries: ents });
    }
}

function calculateLiveBalances() {
    liveBalances = {};
    
    // 1. Initialize from SNAPSHOT (if exists) OR zero
    if (appData.snapshot && appData.snapshot.balances) {
        // Load snapshot values
        liveBalances = JSON.parse(JSON.stringify(appData.snapshot.balances));
        
        // Ensure format consistency (add fav flag placeholder if missing)
        Object.keys(liveBalances).forEach(k => {
            if (!liveBalances[k].hasOwnProperty('fav')) liveBalances[k].fav = false;
        });
    } else {
        // Fallback: Initialize from Source List (Opening Balance)
        appData.sources.forEach(r => {
            let n = Array.isArray(r) ? r[0] : r;
            liveBalances[n] = {
                bal: toPaise(Array.isArray(r) ? Number(r[2] || 0) : 0),
                fav: Array.isArray(r) ? r[6] : false
            };
        });
    }
    
    // Get Snapshot Cutoff Date
    const snapDate = appData.snapshot ? new Date(appData.snapshot.date) : new Date('2000-01-01');

    const s = appData.schema;
    
    // 2. Process Transactions (Only those AFTER snapshot)
    appData.expenses.forEach(r => {
        // Skip transactions that are older than or equal to snapshot date
        // (Because their values are already baked into the snapshot)
        const txnDate = new Date(r[s.date]);
        if (txnDate <= snapDate) return;

        const amtP = toPaise(r[s.amt]);
        const src = String(r[s.source] || "");
        
        // [Existing Logic for Income/Expense/Transfer...]
        // COPY YOUR EXISTING LOGIC INSIDE THIS LOOP HERE.
        // It's the exact same logic (splitting strings, etc), just wrapped in the date check.
        if (r[s.type] === 'Income') {
            if (liveBalances[src]) liveBalances[src].bal += amtP;
        } 
        else if (r[s.type] === 'Expense') {
            if (src.includes(':')) {
                src.split('|').forEach(p => {
                    const [n, v] = p.split(':');
                    if (n && v && liveBalances[n.trim()]) liveBalances[n.trim()].bal -= toPaise(v);
                });
            } else if (liveBalances[src]) {
                liveBalances[src].bal -= amtP;
            }
        } 
        else if (r[s.type] === 'Transfer') {
            if (liveBalances[src]) liveBalances[src].bal -= amtP;
            if (r[s.remarks] && r[s.remarks].includes('To:')) {
                r[s.remarks].split('|').forEach(p => {
                    if (p.trim().startsWith('To:')) {
                        const seg = p.split(':');
                        if (seg.length >= 3 && liveBalances[seg[1].trim()]) {
                            const destAmt = parseFloat(seg[2]); 
                            if (!isNaN(destAmt)) liveBalances[seg[1].trim()].bal += toPaise(destAmt);
                        }
                    }
                });
            }
        }
    });

    // 3. Render Ticker
    const d = document.getElementById('balanceTicker');
    d.innerHTML = '';
    Object.entries(liveBalances).forEach(([n, v]) => {
        // Use flag from Sources array for display preference if available
        const srcDef = appData.sources.find(x => x[0] === n);
        const isFav = srcDef ? srcDef[6] : false;

        if (isFav) {
            const c = v.bal < 0 ? 'text-red-600 dark:text-red-400' : 'text-green-700 dark:text-green-400';
            d.innerHTML += `<div class="flex-shrink-0 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 px-3 py-1 rounded-md text-xs shadow-sm flex flex-col"><span class="text-[10px] text-gray-500 dark:text-gray-400 font-bold uppercase truncate max-w-[100px]">${n}</span><span class="font-mono font-bold ${c}">₹${fmtMoney(v.bal)}</span></div>`;
        }
    });
}

// --- SNAPSHOT & HISTORY TOOLS ---

function createServerSnapshot() {
    openConfirmModal("Close books for today? This creates a restore point.", () => {
        // 1. Calculate current balances exactly as they are now
        calculateLiveBalances(); // Ensure fresh
        
        const todayStr = new Date().toISOString().split('T')[0];
        const balancesJSON = JSON.stringify(liveBalances);
        
        function afterSave() {
            showToast("Snapshot Created. Reloading...");
            document.getElementById('splash').classList.remove('hidden');
            document.getElementById('splash-status').innerText = "Applying Snapshot...";
            document.getElementById('splash-spinner').classList.remove('hidden');
            if (useSupabase()) {
                fetchInitialDataFromSupabase().then(function(data) { onDataLoad(JSON.stringify(data)); document.getElementById('splash').classList.add('hidden'); }).catch(function(e) { alert("Error reloading: " + (e&&e.message?e.message:'')); document.getElementById('splash').classList.add('hidden'); });
            } else {
                google.script.run.withSuccessHandler(onDataLoad).withFailureHandler(function(e) { alert("Error reloading: " + e.message); document.getElementById('splash').classList.add('hidden'); }).getInitialData();
            }
        }
        if (useSupabase()) {
            saveSnapshotToSupabase(todayStr, balancesJSON).then(afterSave).catch(function(e) { showToast(e&&e.message?e.message:'Failed','error'); });
        } else {
            google.script.run.withSuccessHandler(afterSave).saveSnapshot(todayStr, balancesJSON);
        }
    }, "Create Snapshot", "Confirm");
}

function loadArchivedData() {
    var year = prompt("Enter year to fetch (e.g. 2025):", new Date().getFullYear() - 1);
    if (!year) return;
    showToast("Fetching archives...", 'info');
    function mergeRows(oldRows) {
        if (oldRows.length === 0) return showToast("No records found for " + year, 'error');
        var s = appData.schema;
        var currentIds = new Set(appData.expenses.map(function(r) { return r[s.id]; }));
        var added = 0;
        oldRows.forEach(function(r) {
            if (!currentIds.has(r[s.id])) { appData.expenses.push(r); added++; }
        });
        appData.expenses.sort(function(a, b) { return a[s.date] < b[s.date] ? 1 : -1; });
        buildSearchIndex();
        renderReportTable();
        showToast("Loaded " + added + " archived records.");
    }
    if (useSupabase()) {
        fetchHistoryFromSupabase(year).then(mergeRows).catch(function(e) { showToast(e&&e.message?e.message:'Failed','error'); });
    } else {
        google.script.run.withSuccessHandler(function(json) { mergeRows(JSON.parse(json)); }).fetchHistory(year);
    }
}

// --- BULK OPERATIONS LOGIC ---
let selectedIds = new Set();

function toggleBulkRow(id) {
    if (selectedIds.has(id)) selectedIds.delete(id);
    else selectedIds.add(id);
    updateBulkUI();
}

function toggleSelectAll() {
    const checkboxes = document.querySelectorAll('.bulk-check');
    const allChecked = Array.from(checkboxes).every(c => c.checked);
    
    if (allChecked) {
        selectedIds.clear(); // Uncheck all
    } else {
        checkboxes.forEach(c => selectedIds.add(c.value)); // Check all visible
    }
    // Re-render to show correct state
    renderReportTable(false); // false = don't reset filters, just re-render
}

function clearBulkSelection() {
    selectedIds.clear();
    renderReportTable(false);
}

function updateBulkUI() {
    const bar = document.getElementById('bulkActionBar');
    const count = document.getElementById('bulkCount');
    
    // Update count
    count.innerText = selectedIds.size;

    // Show/Hide Bar (Animation classes)
    if (selectedIds.size > 0) {
        bar.classList.remove('translate-y-20', 'opacity-0');
    } else {
        bar.classList.add('translate-y-20', 'opacity-0');
    }
}

// --- BULK ACTIONS ---

function executeBulkDelete() {
    openConfirmModal(`Delete ${selectedIds.size} transactions? This cannot be undone.`, () => {
        const ids = Array.from(selectedIds);
        
        // Optimistic UI Update
        appData.expenses = appData.expenses.filter(r => !selectedIds.has(r[appData.schema.id]));
        clearBulkSelection();
		calculateLiveBalances(); 
        
        if(useSupabase()) deleteBulkTransactionsToSupabase(ids).then(function(){ showToast("Bulk deleted successfully"); }).catch(function(e){ showToast(e&&e.message?e.message:'Failed','error'); });
        else google.script.run.withSuccessHandler(function(){ showToast("Bulk deleted successfully"); }).deleteBulkTransactions(ids);
    });
}

function openBulkEditModal() {
    document.getElementById('bulkEditCount').innerText = selectedIds.size;
    const modal = document.getElementById('bulkEditModal');
    const content = document.getElementById('bulkEditContent');
    modal.classList.remove('hidden');
    // Simple animation
    setTimeout(() => {
        content.classList.remove('scale-95', 'opacity-0');
        content.classList.add('scale-100', 'opacity-100');
    }, 10);
}

function closeBulkEditModal() {
    const modal = document.getElementById('bulkEditModal');
    const content = document.getElementById('bulkEditContent');
    content.classList.remove('scale-100', 'opacity-100');
    content.classList.add('scale-95', 'opacity-0');
    setTimeout(() => modal.classList.add('hidden'), 200);
}

function submitBulkEdit() {
    const sub = document.getElementById('bulkNewSub').value;
    const parent = document.getElementById('bulkNewParent').value;
    
    if(!sub || !parent) return showToast("Please select a category", "error");
    
    const ids = Array.from(selectedIds);
    const s = appData.schema;
    
    // Optimistic UI Update
    appData.expenses.forEach(r => {
        if (selectedIds.has(r[s.id])) {
            r[s.sub] = sub;
            r[s.parent] = parent;
        }
    });
    
    closeBulkEditModal();
    clearBulkSelection(); // Will re-render table
	calculateLiveBalances(); 
    
    if(useSupabase()) updateBulkCategoryToSupabase(ids, parent, sub).then(function(){ showToast("Bulk updated successfully"); }).catch(function(e){ showToast(e&&e.message?e.message:'Failed','error'); });
    else google.script.run.withSuccessHandler(function(){ showToast("Bulk updated successfully"); }).updateBulkCategory(ids, parent, sub);
}

// ==========================================
// MISSING REPORTING & FILTER FUNCTIONS
// ==========================================

function renderReportTable(reset = false) {
    if (reset) renderLimit = BATCH_SIZE;
    const tbody = document.getElementById('reportTableBody');
    const loadBtn = document.getElementById('loadMoreTrigger');
    
    // --- BULK UI SYNC ---
    // Ensure the floating bar is correct every time we re-render
    if (typeof updateBulkUI === 'function') updateBulkUI(); 

    // 1. GATHER FILTER VALUES
    const fStart = document.getElementById('filterStartDate').value;
    const fEnd = document.getElementById('filterEndDate').value;
    const fType = document.getElementById('filterType').value;
    const fParent = document.getElementById('filterParent').value;
    const fSub = document.getElementById('filterSub').value;
    const fSource = document.getElementById('filterSource').value;
    const fMin = document.getElementById('filterMinAmount').value;
    const fMax = document.getElementById('filterMaxAmount').value;
    const fDay = document.getElementById('filterDayType').value;
    const search = document.getElementById('reportSearch').value.toLowerCase();
    
    // 2. FILTER DATA
    currentFilteredData = appData.expenses.filter((r, i) => {
        const s = appData.schema;
        
        // Date Logic
        if (fStart && r[s.date] < fStart) return false;
        if (fEnd && r[s.date] > fEnd) return false;
        
        // Type/Category/Source Logic
        if (fType && r[s.type] !== fType) return false;
        if (fParent && r[s.parent] !== fParent) return false;
        if (fSub && r[s.sub] !== fSub) return false;
        if (fSource) {
             if (!String(r[s.source]).includes(fSource) && !String(r[s.remarks]).includes(fSource)) return false;
        }

        // Amount Logic
        const val = Number(r[s.amt]);
        if (fMin && val < Number(fMin)) return false;
        if (fMax && val > Number(fMax)) return false;
        
        // Day Logic
        if (fDay === 'weekday' && (r._day === 0 || r._day === 6)) return false;
        if (fDay === 'weekend' && (r._day > 0 && r._day < 6)) return false;

        // Search Logic
        if (search) {
             const txt = Object.values(r).join(" ").toLowerCase();
             if (!txt.includes(search)) return false;
        }

        return true;
    });

    document.getElementById('reportCount').innerText = currentFilteredData.length;
    document.getElementById('filterMatchCount').innerText = `(${currentFilteredData.length})`;

    // 3. CALCULATE TOTALS & BREAKDOWNS
    let inc = 0, exp = 0;
    const srcMap = {}; 
    const hierMap = {}; 

    currentFilteredData.forEach(r => {
        const s = appData.schema;
        const type = r[s.type];
        const amt = toPaise(r[s.amt]);
        const srcStr = String(r[s.source] || "");
        
        if (type === 'Income') {
            inc += amt;
        } 
        else if (type === 'Expense') {
            exp += amt;

            // --- A. CATEGORY HIERARCHY ---
            const p = r[s.parent] || 'Uncategorized';
            const sub = r[s.sub] || 'General';
            if (!hierMap[p]) hierMap[p] = { total: 0, subs: {} };
            hierMap[p].total += amt;
            hierMap[p].subs[sub] = (hierMap[p].subs[sub] || 0) + amt;

            // --- B. GROSS SOURCE EXPENSE LOGIC ---
            if (srcStr.includes(':') && !srcStr.startsWith('To:')) {
                srcStr.split('|').forEach(part => {
                    const [acct, val] = part.split(':');
                    if (acct && val) {
                        const cleanAcct = acct.trim();
                        const subAmt = toPaise(val.trim());
                        srcMap[cleanAcct] = (srcMap[cleanAcct] || 0) + subAmt;
                    }
                });
            } else {
                srcMap[srcStr] = (srcMap[srcStr] || 0) + amt;
            }
        }
    });

    document.getElementById('sumIncome').innerText = "₹" + fmtMoney(inc);
    document.getElementById('sumExpense').innerText = "₹" + fmtMoney(exp);
    document.getElementById('sumNet').innerText = "₹" + fmtMoney(inc - exp);

    // RENDER 1: Source Breakdown
    const srcContainer = document.getElementById('sourceBreakdown');
    srcContainer.innerHTML = "";
    
    const sortedSources = Object.entries(srcMap).sort((a,b) => b[1] - a[1]);

    sortedSources.forEach(([srcName, srcTotal]) => {
        const pct = exp > 0 ? Math.round((srcTotal / exp) * 100) : 0;
        srcContainer.innerHTML += `
            <div class="mb-3 last:mb-0">
                <div class="flex justify-between items-end mb-1">
                    <span class="font-bold text-xs text-gray-700 dark:text-gray-300 truncate pr-2" title="${srcName}">${srcName}</span>
                    <span class="font-bold text-[10px] text-gray-900 dark:text-white">₹${fmtMoney(srcTotal)} (${pct}%)</span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 h-1.5 rounded-full overflow-hidden">
                    <div class="bg-blue-600 h-1.5 rounded-full" style="width:${pct}%"></div>
                </div>
            </div>`;
    });
        
    // RENDER 2: Hierarchical Category Sidebar
    const catContainer = document.getElementById('categoryBreakdown');
    catContainer.innerHTML = "";
    const sortedParents = Object.entries(hierMap).sort((a,b) => b[1].total - a[1].total);

    sortedParents.forEach(([parentName, data]) => {
        const pTotal = data.total;
        const pPct = exp > 0 ? Math.round((pTotal / exp) * 100) : 0;
        
        let html = `
            <div class="mb-5 last:mb-0">
                <div class="flex justify-between items-end mb-1">
                    <span class="font-bold text-sm text-gray-800 dark:text-gray-200">${parentName}</span>
                    <span class="font-bold text-xs text-gray-900 dark:text-white">₹${fmtMoney(pTotal)} (${pPct}%)</span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 h-2 rounded-full mb-3 overflow-hidden">
                    <div class="bg-blue-600 h-2 rounded-full" style="width:${pPct}%"></div>
                </div>
                <div class="space-y-1.5">`;

        const sortedSubs = Object.entries(data.subs).sort((a,b) => b[1] - a[1]);
        sortedSubs.forEach(([subName, subAmt]) => {
            const subPct = pTotal > 0 ? (subAmt / pTotal) * 100 : 0;
            html += `
                <div class="flex items-center text-[11px] group">
                    <div class="w-24 text-right pr-2 border-r-2 border-gray-300 dark:border-gray-600 truncate text-gray-600 dark:text-gray-400 font-medium" title="${subName}">${subName}</div>
                    <div class="flex-1 px-2">
                        <div class="w-full bg-gray-100 dark:bg-gray-800 h-1.5 rounded-full overflow-hidden">
                            <div class="bg-blue-300 dark:bg-blue-500/50 h-1.5 rounded-full" style="width:${subPct}%"></div>
                        </div>
                    </div>
                    <div class="w-16 text-right font-mono text-gray-500 dark:text-gray-400">₹${fmtMoney(subAmt)}</div>
                </div>`;
        });
        html += `</div></div>`;
        catContainer.innerHTML += html;
    });

    // 4. RENDER ROWS (Date Grouped + BULK CHECKBOXES)
    tbody.innerHTML = "";
    const viewData = currentFilteredData.slice(0, renderLimit);
    let lastDate = null;

    viewData.forEach(r => {
        const s = appData.schema;
        const isExp = r[s.type] === 'Expense';
        const clr = isExp ? 'text-red-600' : (r[s.type] === 'Income' ? 'text-green-600' : 'text-blue-600');
        const sign = isExp ? '-' : '+';
        
        // --- BULK LOGIC: Check State ---
        const isChecked = selectedIds.has(r[s.id]);
        const rowBg = isChecked ? 'bg-blue-50 dark:bg-blue-900/20' : ''; // Highlight if selected
        
        if (r[s.date] !== lastDate) {
            const dObj = new Date(r[s.date]);
            const dateStr = dObj.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
            // UPDATED COLSPAN TO 7 (to cover the new checkbox column)
            tbody.innerHTML += `<tr class="bg-white dark:bg-gray-900 border-b border-gray-100 dark:border-gray-800"><td colspan="7" class="px-4 py-3 bg-gray-50/50 dark:bg-gray-800/30"><span class="text-xs font-bold text-gray-800 dark:text-gray-200 uppercase tracking-wide">${dateStr}</span></td></tr>`;
            lastDate = r[s.date];
        }

        const row = `
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-800 transition group border-b dark:border-gray-700 ${rowBg}">
            <td class="p-3 w-8 text-center">
                <input type="checkbox" class="bulk-check w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" 
                    value="${r[s.id]}" 
                    ${isChecked ? 'checked' : ''} 
                    onchange="toggleBulkRow('${r[s.id]}')">
            </td>
            <td class="p-3 pl-4 whitespace-nowrap">
                <div class="font-bold text-gray-700 dark:text-gray-300 text-xs">${r[s.date]}</div>
                <div class="text-[9px] text-gray-400 uppercase">${new Date(r[s.date]).toLocaleDateString('en-US', {weekday:'short'})}</div>
            </td>
            <td class="p-3">
                <div class="font-semibold text-gray-800 dark:text-gray-200 text-xs">${r[s.sub]}</div>
                <div class="text-[10px] text-blue-500 cursor-pointer hover:underline" onclick="applyQuickFilter('${r[s.parent]}')">${r[s.parent]}</div>
            </td>
            <td class="p-3 text-xs text-gray-500 break-words max-w-[150px]">${r[s.source]}</td>
            <td class="p-3 text-xs text-gray-500 italic max-w-[200px] truncate" title="${r[s.remarks]}">${r[s.remarks]}</td>
            <td class="p-3 text-right font-mono font-bold ${clr} text-xs">${sign} ₹${Number(r[s.amt]).toLocaleString('en-IN')}</td>
            <td class="p-3 text-center opacity-0 group-hover:opacity-100 transition-opacity">
                <div class="flex justify-center gap-1">
                    <button onclick="editTxn('${r[s.id]}')" class="p-1 hover:bg-blue-100 text-blue-600 rounded"><i data-feather="edit-2" class="w-3 h-3"></i></button>
                    <button onclick="deleteTxn('${r[s.id]}')" class="p-1 hover:bg-red-100 text-red-600 rounded"><i data-feather="trash-2" class="w-3 h-3"></i></button>
                </div>
            </td>
        </tr>`;
        tbody.innerHTML += row;
    });

    if (currentFilteredData.length > renderLimit) loadBtn.classList.remove('hidden');
    else loadBtn.classList.add('hidden');
    
    safeFeatherReplace();
}

function loadMoreRows() {
    renderLimit += BATCH_SIZE;
    renderReportTable(false);
}

function resetFilters() {
    ['filterStartDate','filterEndDate','filterType','filterParent','filterSub','filterSource','filterMinAmount','filterMaxAmount','reportSearch'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.value = '';
    });
    document.getElementById('filterDayType').value = "";
    renderReportTable(true);
}

// QUICK FILTER & PRESETS SUPPORT
function getQuickFilters() {
    try { return JSON.parse(localStorage.getItem('quickFilters')) || []; } 
    catch(e){ return []; }
}

function toggleQuickFilter(name) {
    let qf = getQuickFilters();
    if(qf.includes(name)) qf = qf.filter(x => x !== name);
    else qf.push(name);
    localStorage.setItem('quickFilters', JSON.stringify(qf));
    renderSettingsUI();
    renderQuickFilterBar();
}

function renderQuickFilterBar() {
    const c = document.getElementById('quickFilterContainer');
    if(!c) return;
    const qf = getQuickFilters();
    c.innerHTML = qf.map(name => 
        `<button onclick="applyQuickFilter('${name}')" class="px-2 py-1 bg-indigo-100 text-indigo-700 text-[10px] font-bold rounded border border-indigo-200 hover:bg-indigo-200 whitespace-nowrap">${name}</button>`
    ).join('');
}

function applyQuickFilter(name) {
    // Check if it's a parent
    if (appData.categories[name]) {
        document.getElementById('filterParent').value = name;
        updateSubFilter();
        document.getElementById('filterSub').value = "";
    } else {
        // Assume sub-category or try to find parent
        document.getElementById('filterParent').value = "";
        updateSubFilter(); // Reset subs
        document.getElementById('filterSub').innerHTML += `<option value="${name}" selected>${name}</option>`;
        document.getElementById('filterSub').value = name;
    }
    renderReportTable(true);
}

// EXPORT TO CSV
function exportReportToCSV() {
    if(!currentFilteredData || !currentFilteredData.length) return showToast("No data to export", 'error');
    
    const h = ["Date", "Type", "Sub-Category", "Parent-Category", "Amount", "Mode", "Source", "Remarks"];
    const s = appData.schema;
    
    let csvContent = "data:text/csv;charset=utf-8," + h.join(",") + "\n";
    
    currentFilteredData.forEach(r => {
        const row = [
            r[s.date], r[s.type], `"${r[s.sub]}"`, `"${r[s.parent]}"`, 
            r[s.amt], r[s.mode], `"${r[s.source]}"`, `"${(r[s.remarks]||'').replace(/"/g, '""')}"`
        ];
        csvContent += row.join(",") + "\n";
    });
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `Expense_Report_${new Date().toISOString().slice(0,10)}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// PRESET MODAL STUBS
function openPresetModal(){ document.getElementById('presetModal').classList.remove('hidden'); renderPresets(); }
function closePresetModal(){ document.getElementById('presetModal').classList.add('hidden'); }

function getPresets() { try { return JSON.parse(localStorage.getItem('filterPresets')) || {}; } catch(e){ return {}; } }

function renderPresets() {
    const list = document.getElementById('presetList');
    const p = getPresets();
    list.innerHTML = Object.keys(p).length ? '' : '<p class="text-xs text-gray-400 italic">No saved presets.</p>';
    Object.keys(p).forEach(k => {
        list.innerHTML += `<div class="flex justify-between items-center bg-gray-50 p-2 rounded mb-1"><span class="text-sm font-bold text-gray-700">${k}</span><div class="flex gap-2"><button onclick="loadPreset('${k}')" class="text-blue-600 text-xs hover:underline">Load</button><button onclick="deletePreset('${k}')" class="text-red-500 text-xs hover:underline">Del</button></div></div>`;
    });
}

function saveNewPreset() {
    const n = document.getElementById('newPresetName').value;
    if(!n) return showToast("Enter a name", 'error');
    const p = getPresets();
    p[n] = {
        start: document.getElementById('filterStartDate').value,
        end: document.getElementById('filterEndDate').value,
        type: document.getElementById('filterType').value,
        parent: document.getElementById('filterParent').value,
        sub: document.getElementById('filterSub').value
    };
    localStorage.setItem('filterPresets', JSON.stringify(p));
    document.getElementById('newPresetName').value = '';
    renderPresets();
    showToast("Preset Saved");
}

function loadPreset(n) {
    const p = getPresets()[n];
    if(p) {
        document.getElementById('filterStartDate').value = p.start;
        document.getElementById('filterEndDate').value = p.end;
        document.getElementById('filterType').value = p.type;
        document.getElementById('filterParent').value = p.parent;
        updateSubFilter();
        document.getElementById('filterSub').value = p.sub;
        renderReportTable(true);
        closePresetModal();
        showToast("Preset Loaded");
    }
}
function deletePreset(n) {
    const p = getPresets();
    delete p[n];
    localStorage.setItem('filterPresets', JSON.stringify(p));
    renderPresets();
}


// ==========================================
// 5. INITIALIZATION (AT BOTTOM)
// ==========================================
document.addEventListener('DOMContentLoaded',()=>{
    // Capture password-recovery flag from URL before Supabase client runs (client consumes the hash)
    var isRecoveryRedirect = !!(window.location && (window.location.hash || '').indexOf('type=recovery') !== -1);

    initTheme();
    safeFeatherReplace();
    setTimeout(()=>{
        if(!document.getElementById('splash').classList.contains('hidden')){
            document.getElementById('splash-status').innerText="Taking longer than usual...";
            document.getElementById('forceLoadBtn').classList.remove('hidden');
        }
    },5000);

    const now = new Date(); 
    const todayStr = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
    ['inpDate','bulkDate','schStartDate','filterStartDate', 'filterEndDate', 'pendDate', 'approveDate'].forEach(id=>{
        const el=document.getElementById(id);if(el)el.value=todayStr;
    });

    const selParent=document.getElementById('selParentForSub');
    if(selParent)selParent.addEventListener('change',renderSettingsUI);

    const searchInp=document.getElementById('reportSearch');
    if(searchInp){
        searchInp.addEventListener('input',()=>{
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer=setTimeout(renderReportTable,300);
        });
    }

    const scrollCont=document.getElementById('reportScrollContainer');
    if(scrollCont){
        scrollCont.addEventListener('scroll',()=>{
            if(scrollCont.scrollTop+scrollCont.clientHeight>=scrollCont.scrollHeight-50){loadMoreRows();}
        });
    }

    // Phase 3: If Supabase is configured, use sign-in + Supabase data; else use Google.
    const supabase = getSupabaseClient();
    if (supabase) {
        function tryStartWithSession() {
            supabase.auth.getSession().then(function(result) {
                var session = result.data && result.data.session;
                if (session && session.user && isRecoveryRedirect) {
                    supabaseUserId = session.user.id;
                    showSetNewPasswordUI();
                    return;
                }
                if (session && session.user) {
                    supabaseUserId = session.user.id;
                    startAppWithSupabase();
                    return;
                }
                // No session yet (maybe hash not processed). Wait a bit then try again or show sign-in.
                setTimeout(function() {
                    if (supabaseUserId) return;
                    supabase.auth.getSession().then(function(r2) {
                        var s2 = r2.data && r2.data.session;
                        if (s2 && s2.user && isRecoveryRedirect) {
                            supabaseUserId = s2.user.id;
                            showSetNewPasswordUI();
                            return;
                        }
                        if (s2 && s2.user) {
                            supabaseUserId = s2.user.id;
                            startAppWithSupabase();
                        } else {
                            showSignInUI();
                            supabase.auth.onAuthStateChange(function(event, payload) {
                                if (event === 'SIGNED_IN' && payload && payload.session && payload.session.user) {
                                    supabaseUserId = payload.session.user.id;
                                    startAppWithSupabase();
                                }
                            });
                        }
                    });
                }, 400);
            });
        }
        tryStartWithSession();
    } else {
        try{
            google.script.run.withSuccessHandler(onDataLoad).withFailureHandler(e=>{
                document.getElementById('errorBox').classList.remove('hidden');
                document.getElementById('errorMsg').innerText="Server Error: "+e.message;
                document.getElementById('splash-spinner').classList.add('hidden');
                document.getElementById('forceLoadBtn').classList.remove('hidden');
            }).getInitialData();
        }catch(e){
            console.warn("Local Mode");
            document.getElementById('errorMsg').innerText="Google Script API missing.";
            document.getElementById('errorBox').classList.remove('hidden');
            document.getElementById('forceLoadBtn').classList.remove('hidden');
        }
    }
    
    document.addEventListener('keydown',handleShortcuts);
});

// --- DASHBOARD LOGIC ---
let chartInstances = {}; // Store charts to destroy them before redrawing

function renderDashboard() {
    const s = appData.schema;
    
    // 1. PREPARE DATA: 6-Month Cashflow
    const monthMap = {};
    const today = new Date();
    
    // Initialize last 6 months
    for (let i = 5; i >= 0; i--) {
        const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
        const key = d.toISOString().slice(0, 7); // YYYY-MM
        const label = d.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
        monthMap[key] = { label: label, inc: 0, exp: 0 };
    }

    // 2. PREPARE DATA: 30-Day Trend
    const dayMap = {};
    for (let i = 29; i >= 0; i--) {
        const d = new Date();
        d.setDate(today.getDate() - i);
        const key = d.toISOString().slice(0, 10); // YYYY-MM-DD
        const label = d.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
        // NEW: Added 'items' array to store details
        dayMap[key] = { label: label, amt: 0, items: [] }; 
    }

    // 3. PROCESS LEDGER
    appData.expenses.forEach(r => {
        const dateStr = r[s.date]; 
        const monthKey = dateStr.slice(0, 7);
        const amt = toPaise(r[s.amt]);

        // Fill Monthly Data
        if (monthMap[monthKey]) {
            if (r[s.type] === 'Income') monthMap[monthKey].inc += amt;
            if (r[s.type] === 'Expense') monthMap[monthKey].exp += amt;
        }

        // Fill Daily Data (Expenses Only)
        if (dayMap[dateStr] && r[s.type] === 'Expense') {
            dayMap[dateStr].amt += amt;
            // NEW: Push transaction details
            dayMap[dateStr].items.push({ 
                sub: r[s.sub], 
                val: amt 
            });
        }
    });

    // 4. RENDER CHART 1: CASHFLOW (Standard Bar)
    const ctx1 = document.getElementById('chartCashflow').getContext('2d');
    if (chartInstances.cashflow) chartInstances.cashflow.destroy();
    
    const months = Object.values(monthMap);
    chartInstances.cashflow = new Chart(ctx1, {
        type: 'bar',
        data: {
            labels: months.map(m => m.label),
            datasets: [
                {
                    label: 'Income',
                    data: months.map(m => fromPaise(m.inc)),
                    backgroundColor: 'rgba(34, 197, 94, 0.6)', 
                    borderColor: 'rgba(34, 197, 94, 1)',
                    borderWidth: 1,
                    borderRadius: 4
                },
                {
                    label: 'Expense',
                    data: months.map(m => fromPaise(m.exp)),
                    backgroundColor: 'rgba(239, 68, 68, 0.6)', 
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderWidth: 1,
                    borderRadius: 4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, grid: { color: document.documentElement.classList.contains('dark') ? '#374151' : '#e5e7eb' } },
                x: { grid: { display: false } }
            },
            plugins: {
                legend: { labels: { color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151' } }
            }
        }
    });

    // 5. RENDER CHART 2: SPENDING TREND (Enhanced Line)
    const ctx2 = document.getElementById('chartTrend').getContext('2d');
    if (chartInstances.trend) chartInstances.trend.destroy();

    const days = Object.values(dayMap);
    
    // Helper: Sort items by amount desc and take top 5
    const dailyDetails = days.map(d => {
        return d.items
            .sort((a,b) => b.val - a.val)
            .slice(0, 5) // Top 5 only
            .map(x => `${x.sub}: ₹${fromPaise(x.val)}`);
    });

    chartInstances.trend = new Chart(ctx2, {
        type: 'line',
        data: {
            labels: days.map(d => d.label),
            datasets: [{
                label: 'Daily Spending',
                data: days.map(d => fromPaise(d.amt)),
                borderColor: 'rgba(147, 51, 234, 1)', 
                backgroundColor: 'rgba(147, 51, 234, 0.1)',
                borderWidth: 2,
                tension: 0.3, 
                fill: true,
                pointRadius: 3,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, grid: { color: document.documentElement.classList.contains('dark') ? '#374151' : '#e5e7eb' } },
                x: { grid: { display: false }, ticks: { maxTicksLimit: 10 } }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    // NEW: Custom Tooltip Configuration
                    callbacks: {
                        afterBody: function(context) {
                            // Look up the details array using the data index
                            const idx = context[0].dataIndex;
                            const items = dailyDetails[idx];
                            if (items && items.length > 0) {
                                return ['', 'Top Expenses:', ...items];
                            }
                            return [];
                        }
                    }
                }
            }
        }
    });
}

// --- SMART PREDICTION LOGIC (FREQUENCY BASED) ---
function predictTransactionDetails(el) {
    const val = el.value.trim().toLowerCase();
    const type = document.getElementById('inpType').value;
    
    // 1. Guards: Need at least 3 chars, and target fields should be empty
    if (val.length < 3) return;
    const subField = document.getElementById('inpSub');
    if (subField.value !== "") return; // Don't overwrite if user already chose

    const s = appData.schema;
    
    // 2. Scan History: Find ALL matches, not just the first one
    const history = appData.expenses.filter(r => 
        r[s.type] === type && 
        String(r[s.remarks] || "").toLowerCase().includes(val)
    );

    if (history.length === 0) return;

    // 3. Frequency Analysis: Count usage of each Category pair
    const categoryFreq = {};
    history.forEach(t => {
        const key = t[s.parent] + '|' + t[s.sub];
        categoryFreq[key] = (categoryFreq[key] || 0) + 1;
    });

    // 4. Winner: Get the most frequent category
    const mostFrequent = Object.keys(categoryFreq).sort(
        (a,b) => categoryFreq[b] - categoryFreq[a]
    )[0];

    if (mostFrequent) {
        const [parent, sub] = mostFrequent.split('|');
        
        // Auto-Fill
        document.getElementById('inpParent').value = parent;
        subField.value = sub;
        
        // Visual Feedback (Green flash)
        subField.classList.add('bg-green-50', 'transition-colors', 'duration-500');
        setTimeout(() => subField.classList.remove('bg-green-50'), 1000);
        
        // Optional: Toast to tell the user "I learned this!"
        showToast(`Auto-matched: ${sub}`, 'success');
    }
}

// --- CALENDAR LOGIC START ---
let calCurrentDate = new Date();
let currentViewMode = 'list';

function toggleSchView(mode) {
    currentViewMode = mode;
    const isList = mode === 'list';
    
    // Toggle UI Containers
    document.getElementById('schListView').classList.toggle('hidden', !isList);
    document.getElementById('schCalendarView').classList.toggle('hidden', isList);
    document.getElementById('calNav').classList.toggle('hidden', isList); // Show Month Nav only in Calendar
    
    // Toggle Button Styles
    const btnList = document.getElementById('btnViewList');
    const btnCal = document.getElementById('btnViewCal');
    
    const activeClass = ['bg-white', 'dark:bg-gray-600', 'shadow', 'text-gray-800', 'dark:text-white'];
    const inactiveClass = ['text-gray-500', 'dark:text-gray-400', 'hover:text-gray-700'];

    if (isList) {
        btnList.classList.add(...activeClass); btnList.classList.remove(...inactiveClass);
        btnCal.classList.remove(...activeClass); btnCal.classList.add(...inactiveClass);
        renderScheduledTable(); // Refresh List
    } else {
        btnCal.classList.add(...activeClass); btnCal.classList.remove(...inactiveClass);
        btnList.classList.remove(...activeClass); btnList.classList.add(...inactiveClass);
        renderCalendar(); // Render Calendar
    }
}

function changeCalMonth(dir) {
    calCurrentDate.setMonth(calCurrentDate.getMonth() + dir);
    renderCalendar();
}

function initiateQuickSchedule(y, m, d, e) {
    // 1. Stop the click from opening the "View Day" modal
    e.stopPropagation(); 
    
    // 2. Reset the form to fresh state
    resetScheduleForm();
    
    // 3. Set the specific date you clicked
    // Create date object and adjust for timezone to get clean YYYY-MM-DD
    const dateObj = new Date(y, m, d);
    const dateStr = new Date(dateObj.getTime() - (dateObj.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
    
    document.getElementById('schStartDate').value = dateStr;
    
    // 4. Visual Feedback & Focus
    const formTitle = document.getElementById('schFormTitle');
    formTitle.innerText = "Schedule for " + dateObj.toLocaleDateString('en-US', {month:'short', day:'numeric'});
    formTitle.classList.add('text-blue-600');
    
    // Scroll to form (helpful on mobile)
    document.getElementById('scheduleForm').scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    // Flash the form container to show it's active
    const panel = document.getElementById('scheduleForm').closest('.glass-panel');
    panel.classList.add('ring-2', 'ring-blue-500');
    setTimeout(() => panel.classList.remove('ring-2', 'ring-blue-500'), 800);
}

// --- DAY MODAL LOGIC ---
function openDayModal(day) {
    const year = calCurrentDate.getFullYear();
    const month = calCurrentDate.getMonth();
    
    // 1. Re-calculate events for this specific day (Reuse logic or grab from global cache if you optimized)
    // For safety, we just quickly filter appData.scheduled again to be 100% accurate
    const targetDate = new Date(year, month, day);
    const dayEvents = [];
    
    // Ledger Verification for "Done" status
    const startOfM = new Date(year, month, 1);
    const endOfM = new Date(year, month + 1, 0);
    const s = appData.schema;
    const monthLogs = appData.expenses.filter(r => {
        const d = new Date(r[s.date]);
        return d >= startOfM && d <= endOfM;
    });

    appData.scheduled.forEach(r => {
        const freq = r[1];
        const nextDue = new Date(r[2]);
        const sub = r[5];
        const amt = Number(r[7]);
        const sunset = r[3] ? new Date(r[3]) : null;

        if (sunset && sunset < startOfM) return;
        
        let matchDay = false;
        if (freq === 'Monthly' && nextDue.getDate() === day) matchDay = true;
        if (freq === 'Weekly' && nextDue.getDay() === targetDate.getDay()) matchDay = true;
        if (freq === 'One-Time' && nextDue.getDate() === day && nextDue.getMonth() === month) matchDay = true;

        if (matchDay) {
            // Check Done Status
            let isDone = false;
            if (freq === 'Monthly') {
                const log = monthLogs.find(l => l[s.sub] === sub && Math.abs(Number(l[s.amt]) - amt) < 1);
                isDone = !!log;
            } else {
                const sysNextDue = new Date(r[2]); sysNextDue.setHours(0,0,0,0);
                if (sysNextDue > targetDate) isDone = true;
            }
            dayEvents.push({ id: r[0], sub, amt, isDone });
        }
    });

    // 2. Render Modal
    const title = document.getElementById('dayModalTitle');
    const content = document.getElementById('dayModalContent');
    const totalEl = document.getElementById('dayModalTotal');
    
    title.innerText = targetDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', weekday: 'long' });
    content.innerHTML = '';
    
    let total = 0;
    
    if (dayEvents.length === 0) {
        content.innerHTML = '<p class="text-center text-gray-500 italic py-4">No events scheduled.</p>';
    } else {
        dayEvents.forEach(ev => {
            total += ev.amt;
            const statusColor = ev.isDone ? 'bg-green-100 text-green-800 border-green-200' : 'bg-red-50 text-red-800 border-red-200';
            const statusIcon = ev.isDone ? 'check-circle' : 'circle';
            
            content.innerHTML += `
            <div class="flex justify-between items-center p-3 rounded-lg border ${statusColor} dark:opacity-90">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-white/50 rounded-full">
                        <i data-feather="${statusIcon}" class="w-4 h-4"></i>
                    </div>
                    <div>
                        <div class="font-bold text-sm">${ev.sub}</div>
                        <div class="text-xs opacity-75">Amount: ₹${ev.amt.toLocaleString('en-IN')}</div>
                    </div>
                </div>
                <button onclick="editSch('${ev.id}'); closeDayModal()" class="p-2 bg-white/50 hover:bg-white rounded text-xs font-bold shadow-sm transition">
                    Edit
                </button>
            </div>`;
        });
    }

    totalEl.innerText = `Total Due: ₹${total.toLocaleString('en-IN')}`;
    
    document.getElementById('dayDetailModal').classList.remove('hidden');
    safeFeatherReplace();
}

function closeDayModal() {
    document.getElementById('dayDetailModal').classList.add('hidden');
}

function renderCalendar() {
    const grid = document.getElementById('calendarGrid');
    const label = document.getElementById('calMonthLabel');
    grid.innerHTML = '';
    
    const year = calCurrentDate.getFullYear();
    const month = calCurrentDate.getMonth(); 
    
    label.innerText = new Date(year, month, 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

    const firstDay = new Date(year, month, 1).getDay(); 
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    
    const startOfM = new Date(year, month, 1);
    const endOfM = new Date(year, month + 1, 0);
    const s = appData.schema;
    
    const monthLogs = appData.expenses.filter(r => {
        const d = new Date(r[s.date]);
        return d >= startOfM && d <= endOfM;
    });

    const dayEvents = {}; 
    
    appData.scheduled.forEach(r => {
        const freq = r[1];
        const nextDue = new Date(r[2]);
        const sub = r[5];
        const amt = Number(r[7]);
        const sunset = r[3] ? new Date(r[3]) : null;

        if (sunset && sunset < startOfM) return;

        let days = [];
        if (freq === 'Monthly') {
            const dueDay = nextDue.getDate();
            if (dueDay <= daysInMonth) days.push(dueDay);
        } else if (freq === 'Weekly') {
            const targetDay = nextDue.getDay(); 
            for (let d = 1; d <= daysInMonth; d++) {
                if (new Date(year, month, d).getDay() === targetDay) days.push(d);
            }
        } else if (freq === 'One-Time') {
            if (nextDue.getMonth() === month && nextDue.getFullYear() === year) {
                days.push(nextDue.getDate());
            }
        }

        days.forEach(d => {
            if (!dayEvents[d]) dayEvents[d] = [];
            
            let isDone = false;
            let logMatch = null;
            
            if (freq === 'Monthly') {
                logMatch = monthLogs.find(log => 
                    log[s.sub] === sub && Math.abs(Number(log[s.amt]) - amt) < 1 
                );
                isDone = !!logMatch;
            } else {
                const specificDate = new Date(year, month, d); specificDate.setHours(0,0,0,0);
                const sysNextDue = new Date(r[2]); sysNextDue.setHours(0,0,0,0);
                if (sysNextDue > specificDate) isDone = true;
            }

            const colorClass = isDone 
                ? 'bg-green-100 text-green-800 border-green-200 dark:bg-green-900/40 dark:text-green-300 dark:border-green-800' 
                : 'bg-red-50 text-red-800 border-red-200 dark:bg-red-900/40 dark:text-red-300 dark:border-red-800';

            dayEvents[d].push({ 
                id: r[0],
                name: sub, 
                amt: amt, 
                done: isDone, 
                color: colorClass
            });
        });
    });

    // RENDER GRID
    for (let i = 0; i < firstDay; i++) {
        grid.innerHTML += `<div class="border-b border-r dark:border-gray-700 bg-gray-50/30 dark:bg-gray-800/30"></div>`;
    }

    for (let day = 1; day <= daysInMonth; day++) {
        const events = dayEvents[day] || [];
        const isToday = (day === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear());
        
        const dailyTotal = events.reduce((sum, e) => sum + e.amt, 0);
        const totalBadge = dailyTotal > 0 
            ? `<span class="text-[9px] font-mono text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 px-1 rounded">₹${Math.round(dailyTotal/1000)}k</span>` 
            : '';

        let eventsHtml = '';
        const maxVisible = 3; 
        
        events.slice(0, maxVisible).forEach(ev => {
            eventsHtml += `
            <div class="mb-1 px-1.5 py-0.5 rounded text-[9px] font-bold border truncate flex justify-between items-center shadow-sm ${ev.color}">
                <span class="truncate mr-1 flex-1">${ev.name}</span>
                <span class="font-mono opacity-90 text-[8px]">₹${Math.round(ev.amt)}</span>
            </div>`;
        });
        
        if (events.length > maxVisible) {
            eventsHtml += `<div class="text-[9px] text-gray-400 pl-1 font-bold">+${events.length - maxVisible} more...</div>`;
        }

        // --- NEW: Added + Button Logic below ---
        grid.innerHTML += `
            <div onclick="openDayModal(${day})" class="cursor-pointer border-b border-r dark:border-gray-700 min-h-[100px] p-1 relative hover:bg-blue-50 dark:hover:bg-blue-900/10 transition group overflow-hidden flex flex-col">
                <div class="flex justify-between items-start mb-1">
                    <div class="flex items-center gap-1">
                        <span class="text-xs font-bold ${isToday ? 'bg-blue-600 text-white w-5 h-5 flex items-center justify-center rounded-full shadow-md' : 'text-gray-500 dark:text-gray-400'}">${day}</span>
                        <button onclick="initiateQuickSchedule(${year}, ${month}, ${day}, event)" class="opacity-0 group-hover:opacity-100 transition p-0.5 rounded-full hover:bg-blue-200 dark:hover:bg-blue-700 text-blue-600 dark:text-blue-300" title="Add Schedule for ${day}">
                            <i data-feather="plus-circle" class="w-3 h-3"></i>
                        </button>
                    </div>
                    ${totalBadge}
                </div>
                <div class="flex flex-col flex-1 w-full">
                    ${eventsHtml}
                </div>
            </div>
        `;
    }
    
    const totalCells = firstDay + daysInMonth;
    const remaining = 42 - totalCells; 
    for(let i=0; i<remaining; i++) {
        grid.innerHTML += `<div class="border-b border-r dark:border-gray-700 bg-gray-50/30 dark:bg-gray-800/30"></div>`;
    }

    safeFeatherReplace(); // Ensure icons render
    updateScheduleStats(calCurrentDate);
}
// --- CALENDAR LOGIC END ---
</script>
</body>
</html>